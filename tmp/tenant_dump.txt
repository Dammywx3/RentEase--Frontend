

// ===== FILE: lib/features/tenant/alerts/alerts_screen.dart =====

import 'package:flutter/material.dart';

import '../../../core/ui/scaffold/app_top_bar.dart';
import '../../../core/ui/scaffold/app_scaffold.dart';

import '../../../core/theme/app_colors.dart';

class AlertsScreen extends StatelessWidget {
  const AlertsScreen({super.key});

  @override
  Widget build(BuildContext context) {
    return AppScaffold(
      topBar: const AppTopBar(title: 'Alerts'),
      child: ListView.separated(
        padding: const EdgeInsets.fromLTRB(14, 10, 14, 14),
        itemBuilder: (context, i) => Container(
          padding: const EdgeInsets.all(14),
          decoration: BoxDecoration(
            color: AppColors.surface(context).withValues(alpha: 0.92),
            borderRadius: BorderRadius.circular(16),
            border: Border.all(color: AppColors.overlay(context, 0.06)),
            boxShadow: [
              BoxShadow(
                blurRadius: 18,
                offset: const Offset(0, 10),
                color: AppColors.overlay(context, 0.08),
              ),
            ],
          ),
          child: Row(
            children: [
              const Icon(
                Icons.notifications_rounded,
                color: AppColors.brandGreenDeep,
              ),
              const SizedBox(width: 10),
              Expanded(
                child: Text(
                  i == 0
                      ? 'New listing alert: 3-bedroom in Lekki'
                      : 'Price drop alert: ₦95,000,000 in Ikeja',
                  style: Theme.of(
                    context,
                  ).textTheme.titleSmall?.copyWith(fontWeight: FontWeight.w800),
                ),
              ),
              const Icon(Icons.chevron_right_rounded),
            ],
          ),
        ),
        separatorBuilder: (context, index) => const SizedBox(height: 10),
        itemCount: 6,
      ),
    );
  }
}


// ===== FILE: lib/features/tenant/applications/application_detail_screen.dart =====

import 'package:flutter/material.dart';
import '../../../core/theme/app_spacing.dart';
import '../../../core/ui/scaffold/app_scaffold.dart';
import '../../../core/ui/scaffold/app_top_bar.dart';
import '../../../shared/services/dialog_service.dart';
import '../../../shared/services/toast_service.dart';
import '../../../shared/widgets/primary_button.dart';
import '../../../shared/widgets/status_badge.dart';
import '../../../core/constants/status_badge_map.dart';

class ApplicationDetailScreen extends StatelessWidget {
  const ApplicationDetailScreen({
    super.key,
    required this.appId,
    required this.title,
    required this.status,
  });

  final String appId;
  final String title;
  final String status;

  @override
  Widget build(BuildContext context) {
    final s = status.toLowerCase();

    return AppScaffold(
      topBar: const AppTopBar(
        title: 'Application Detail',
        subtitle: 'Review timeline & actions',
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            title,
            style: Theme.of(
              context,
            ).textTheme.titleLarge?.copyWith(fontWeight: FontWeight.w900),
          ),
          const SizedBox(height: AppSpacing.sm),
          StatusBadge(domain: StatusDomain.purchaseStatus, status: status),
          const SizedBox(height: AppSpacing.lg),

          Text(
            'Timeline',
            style: Theme.of(
              context,
            ).textTheme.titleMedium?.copyWith(fontWeight: FontWeight.w900),
          ),
          const SizedBox(height: AppSpacing.sm),
          const _TimelineItem(
            title: 'Submitted',
            subtitle: 'Your application was submitted',
          ),
          _TimelineItem(title: 'Status', subtitle: 'Current: $status'),
          const SizedBox(height: AppSpacing.lg),

          if (s == 'approved') ...[
            PrimaryButton(
              label: 'Pay Deposit',
              onPressed: () => ToastService.show(
                context,
                'Push to Payments (wire later)',
                success: true,
              ),
            ),
          ] else if (s == 'pending') ...[
            PrimaryButton(
              label: 'Withdraw',
              onPressed: () async {
                final ok = await DialogService.confirm(
                  context,
                  title: 'Withdraw application?',
                  message: 'This action cannot be undone.',
                  confirmText: 'Withdraw',
                  danger: true,
                );
                if (ok && context.mounted) {
                  ToastService.show(context, 'Withdrawn (demo)', success: true);
                  Navigator.of(context).pop();
                }
              },
            ),
          ] else if (s == 'rejected') ...[
            PrimaryButton(
              label: 'Browse similar',
              onPressed: () => ToastService.show(
                context,
                'Browse similar (demo)',
                success: true,
              ),
            ),
          ] else ...[
            PrimaryButton(
              label: 'Message',
              onPressed: () => ToastService.show(
                context,
                'Message (Phase 2)',
                success: true,
              ),
            ),
          ],
        ],
      ),
    );
  }
}

class _TimelineItem extends StatelessWidget {
  const _TimelineItem({required this.title, required this.subtitle});
  final String title;
  final String subtitle;

  @override
  Widget build(BuildContext context) {
    return Padding(
      padding: const EdgeInsets.only(bottom: AppSpacing.md),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          const Icon(Icons.check_circle_outline_rounded, size: 18),
          const SizedBox(width: AppSpacing.sm),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  title,
                  style: Theme.of(
                    context,
                  ).textTheme.labelLarge?.copyWith(fontWeight: FontWeight.w900),
                ),
                const SizedBox(height: 2),
                Text(subtitle, style: Theme.of(context).textTheme.bodyMedium),
              ],
            ),
          ),
        ],
      ),
    );
  }
}


// ===== FILE: lib/features/tenant/applications/applications_screen.dart =====

import 'package:flutter/material.dart';
import '../../../core/theme/app_spacing.dart';
import '../../../core/ui/scaffold/app_scaffold.dart';
import '../../../core/ui/scaffold/app_top_bar.dart';
import '../../../core/ui/states/empty_state.dart';
import '../../../shared/widgets/card_widgets/application_card.dart';
import 'application_detail_screen.dart';

class ApplicationsScreen extends StatefulWidget {
  const ApplicationsScreen({super.key});

  @override
  State<ApplicationsScreen> createState() => _ApplicationsScreenState();
}

class _ApplicationsScreenState extends State<ApplicationsScreen> {
  String _tab = 'All';

  final _items = const [
    _AppRow(
      id: 'a1',
      title: 'Modern 2 Bedroom Apartment',
      status: 'pending',
      date: 'Jan 10, 2026',
    ),
    _AppRow(
      id: 'a2',
      title: 'Family Duplex (4 Beds)',
      status: 'approved',
      date: 'Jan 06, 2026',
    ),
    _AppRow(
      id: 'a3',
      title: 'Studio (Close to Road)',
      status: 'rejected',
      date: 'Dec 29, 2025',
    ),
  ];

  List<_AppRow> get _filtered {
    if (_tab == 'All') {
      return _items;
    }
    return _items
        .where((x) => x.status.toLowerCase() == _tab.toLowerCase())
        .toList();
  }

  @override
  Widget build(BuildContext context) {
    final items = _filtered;

    return AppScaffold(
      topBar: const AppTopBar(
        title: 'My Applications',
        subtitle: 'Track application status',
      ),
      child: Column(
        children: [
          // tabs
          SingleChildScrollView(
            scrollDirection: Axis.horizontal,
            child: Row(
              children: [
                _TabChip(
                  label: 'All',
                  active: _tab == 'All',
                  onTap: () => setState(() => _tab = 'All'),
                ),
                _TabChip(
                  label: 'pending',
                  active: _tab == 'pending',
                  onTap: () => setState(() => _tab = 'pending'),
                ),
                _TabChip(
                  label: 'approved',
                  active: _tab == 'approved',
                  onTap: () => setState(() => _tab = 'approved'),
                ),
                _TabChip(
                  label: 'rejected',
                  active: _tab == 'rejected',
                  onTap: () => setState(() => _tab = 'rejected'),
                ),
              ],
            ),
          ),
          const SizedBox(height: AppSpacing.md),

          Expanded(
            child: items.isEmpty
                ? const EmptyState(
                    title: 'No applications yet',
                    message: 'Explore listings and apply to get started.',
                  )
                : ListView.separated(
                    padding: const EdgeInsets.only(bottom: AppSpacing.xl),
                    itemCount: items.length,
                    separatorBuilder: (_, i) =>
                        const SizedBox(height: AppSpacing.md),
                    itemBuilder: (_, i) {
                      final x = items[i];
                      return ApplicationCard(
                        propertyTitle: x.title,
                        submittedDateText: x.date,
                        status: x.status,
                        onTap: () {
                          Navigator.of(context).push(
                            MaterialPageRoute(
                              builder: (_) => ApplicationDetailScreen(
                                appId: x.id,
                                title: x.title,
                                status: x.status,
                              ),
                            ),
                          );
                        },
                        primaryActionText: x.status == 'approved'
                            ? 'Pay Deposit'
                            : 'View',
                        onPrimaryAction: () {
                          Navigator.of(context).push(
                            MaterialPageRoute(
                              builder: (_) => ApplicationDetailScreen(
                                appId: x.id,
                                title: x.title,
                                status: x.status,
                              ),
                            ),
                          );
                        },
                      );
                    },
                  ),
          ),
        ],
      ),
    );
  }
}

class _TabChip extends StatelessWidget {
  const _TabChip({
    required this.label,
    required this.active,
    required this.onTap,
  });
  final String label;
  final bool active;
  final VoidCallback onTap;

  @override
  Widget build(BuildContext context) {
    return Padding(
      padding: const EdgeInsets.only(right: 10),
      child: ChoiceChip(
        selected: active,
        label: Text(label),
        onSelected: (_) => onTap(),
      ),
    );
  }
}

class _AppRow {
  const _AppRow({
    required this.id,
    required this.title,
    required this.status,
    required this.date,
  });
  final String id;
  final String title;
  final String status;
  final String date;
}


// ===== FILE: lib/features/tenant/explore/explore_screen.dart =====

import 'package:flutter/material.dart';

import '../../../core/theme/app_colors.dart';
import '../../../core/theme/app_radii.dart';
import '../../../core/theme/app_shadows.dart';
import '../../../core/theme/app_spacing.dart';

import '../../../core/ui/scaffold/app_scaffold.dart';
import '../../../core/ui/scaffold/app_top_bar.dart';

import '../../../core/utils/money_format.dart'; // ✅ FIX: shared money formatter

import '../../../shared/models/listing_model.dart';
import '../listing_detail/listing_detail_screen.dart';

enum _ExploreMode { buy, rent, land }

class ExploreScreen extends StatefulWidget {
  const ExploreScreen({super.key});

  @override
  State<ExploreScreen> createState() => _ExploreScreenState();
}

class _ExploreScreenState extends State<ExploreScreen> {
  int _activeChip = 0;

  // ✅ Chips: Buy -> property for sale, Rent -> request viewing, Land -> request inspection
  final List<String> _chips = const [
    'For You',
    'Buy',
    'Rent',
    'Land',
    'Verified',
  ];

  _ExploreMode _mode = _ExploreMode.buy;

  // local saved state (later you’ll wire to backend + Saved tab)
  final Set<String> _savedIds = <String>{};

  void _setModeFromChip(int index) {
    setState(() {
      _activeChip = index;

      // Your rule:
      // Buy -> properties for buy
      // Rent -> properties for rent
      // Land -> landed properties
      if (index == 2) {
        _mode = _ExploreMode.rent;
      } else if (index == 3) {
        _mode = _ExploreMode.land;
      } else {
        // default for "For You", "Buy", "Verified"
        _mode = _ExploreMode.buy;
      }
    });
  }

  String _modeTitle(_ExploreMode m) {
    switch (m) {
      case _ExploreMode.buy:
        return 'Buy';
      case _ExploreMode.rent:
        return 'Rent';
      case _ExploreMode.land:
        return 'Land';
    }
  }

  String _primaryActionLabelFor(_ExploreMode m) {
    switch (m) {
      case _ExploreMode.buy:
        return 'Buy Property';
      case _ExploreMode.rent:
        return 'Request Viewing';
      case _ExploreMode.land:
        return 'Request Inspection';
    }
  }

  String _intentFor(_ExploreMode m) {
    switch (m) {
      case _ExploreMode.buy:
        return 'buy';
      case _ExploreMode.rent:
        return 'viewing';
      case _ExploreMode.land:
        return 'inspection';
    }
  }

  ListingModel _toListingModel(_DemoListing l) {
    // You can later align these fields with your real backend listing fields.
    return ListingModel(
      id: l.id,
      title: l.title,
      price: l.price,
      currency: '₦',
      location: l.location,
      status: 'published',
      beds: l.beds == 0 ? null : l.beds,
      baths: l.baths == 0 ? null : l.baths,
      type: l.type,
      mediaUrls: const [],
      propertyStatus: 'available',
      ownerName: 'RentEase',
      ownerId: 'system',
    );
  }

  void _toggleSaved(String id) {
    setState(() {
      if (_savedIds.contains(id)) {
        _savedIds.remove(id);
      } else {
        _savedIds.add(id);
      }
    });
  }

  void _openListing(_DemoListing demo) {
    final listing = _toListingModel(demo);
    final saved = _savedIds.contains(listing.id);

    Navigator.of(context).push(
      MaterialPageRoute(
        builder: (_) => ListingDetailScreen(
          listing: listing,
          saved: saved,
          onToggleSaved: () => _toggleSaved(listing.id),

          // ✅ mode-based CTA (your rule)
          primaryActionLabel: _primaryActionLabelFor(_mode),
          intent: _intentFor(_mode),
        ),
      ),
    );
  }

  // ---------------- Demo data ----------------
  // We keep 3 buckets and filter by _mode.
  late final List<_DemoListing> _buyListings = List.generate(
    8,
    (i) => _DemoListing(
      id: 'buy_$i',
      title: i.isEven ? 'Premium Family Duplex' : 'Modern 2BR Apartment',
      location: i.isEven ? 'Ikoyi • Lagos' : 'Lekki • Lagos',
      priceLabel: '₦${(115000000 + (i * 2500000)).toString()}',
      badge: i % 3 == 0 ? 'Verified' : 'Hot',
      gradient: i.isEven
          ? AppColors.demoCardGradientA
          : AppColors.demoCardGradientB,
      beds: 3 + (i % 2),
      baths: 2 + (i % 2),
      sqft: 1800 + (i * 40),
      verified: i % 3 == 0,
      type: 'Apartment',
      price: 115000000 + (i * 2500000),
    ),
  );

  late final List<_DemoListing> _rentListings = List.generate(
    8,
    (i) => _DemoListing(
      id: 'rent_$i',
      title: i.isEven ? 'Luxury Studio Apartment' : 'Cozy 1BR Apartment',
      location: i.isEven ? 'Ikeja • Lagos' : 'Yaba • Lagos',
      priceLabel: '₦${(1200000 + (i * 85000)).toString()}/yr',
      badge: i % 4 == 0 ? 'Verified' : 'New',
      gradient: i.isEven
          ? AppColors.demoCardGradientB
          : AppColors.demoCardGradientA,
      beds: 1,
      baths: 1,
      sqft: 650 + (i * 25),
      verified: i % 4 == 0,
      type: 'Rent',
      price: 1200000 + (i * 85000),
    ),
  );

  late final List<_DemoListing> _landListings = List.generate(
    8,
    (i) => _DemoListing(
      id: 'land_$i',
      title: 'Prime Land Plot',
      location: i.isEven ? 'Ajah • Lagos' : 'Gwarinpa • Abuja',
      priceLabel: '₦${(45000000 + (i * 1200000)).toString()}',
      badge: i % 5 == 0 ? 'Verified' : 'Land',
      gradient: i.isEven
          ? AppColors.demoCardGradientA
          : AppColors.demoCardGradientB,
      beds: 0,
      baths: 0,
      sqft: 5000 + (i * 250),
      verified: i % 5 == 0,
      type: 'Land',
      price: 45000000 + (i * 1200000),
    ),
  );

  List<_DemoListing> get _activeListings {
    // Verified chip: show verified of current mode (or buy default)
    final bool onlyVerified = _chips[_activeChip] == 'Verified';

    List<_DemoListing> base;
    switch (_mode) {
      case _ExploreMode.buy:
        base = _buyListings;
        break;
      case _ExploreMode.rent:
        base = _rentListings;
        break;
      case _ExploreMode.land:
        base = _landListings;
        break;
    }

    if (!onlyVerified) return base;
    return base.where((x) => x.verified).toList();
  }

  @override
  Widget build(BuildContext context) {
    final activeTitle = _modeTitle(_mode);

    return AppScaffold(
      backgroundColor: Colors.transparent,
      safeAreaTop: true,
      safeAreaBottom: false,
      appBar: AppTopBar(
        title: 'Explore',
        subtitle: '$activeTitle listings • tap any card',
        actions: [
          Padding(
            padding: const EdgeInsets.only(right: AppSpacing.screenH),
            child: InkWell(
              onTap: () {},
              borderRadius: BorderRadius.circular(999),
              child: Container(
                height: 42,
                width: 42,
                decoration: BoxDecoration(
                  color: AppColors.surface(context).withValues(alpha: 0.92),
                  shape: BoxShape.circle,
                  border: Border.all(color: AppColors.overlay(context, 0.08)),
                  boxShadow:
                      AppShadows.soft(context, blur: 14, y: 8, alpha: 0.08),
                ),
                child: Icon(
                  Icons.notifications_none_rounded,
                  color: AppColors.textMuted(context),
                ),
              ),
            ),
          ),
        ],
      ),
      scroll: true,
      padding: const EdgeInsets.fromLTRB(
        AppSpacing.screenH,
        AppSpacing.sm,
        AppSpacing.screenH,
        140,
      ),
      child: DecoratedBox(
        decoration: BoxDecoration(gradient: AppColors.pageBgGradient(context)),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            const SizedBox(height: AppSpacing.sm),

            _SearchStub(onTap: () {}),

            const SizedBox(height: AppSpacing.md),

            _QuickActionsRow(
              onFilter: () {},
              onMap: () {},
              onSaved: () {},
            ),

            const SizedBox(height: AppSpacing.md),

            _ChipRow(
              chips: _chips,
              activeIndex: _activeChip,
              onTap: _setModeFromChip,
            ),

            const SizedBox(height: AppSpacing.lg),

            Text(
              'Featured',
              style: Theme.of(context).textTheme.titleLarge?.copyWith(
                    fontWeight: FontWeight.w900,
                    color: AppColors.textPrimary(context),
                  ),
            ),
            const SizedBox(height: AppSpacing.sm),

            SizedBox(
              height: 210,
              child: ListView.separated(
                scrollDirection: Axis.horizontal,
                physics: const BouncingScrollPhysics(),
                itemCount: _activeListings.length < 6 ? _activeListings.length : 6, // ✅ FIX
                separatorBuilder: (_, __) => const SizedBox(width: AppSpacing.md),
                itemBuilder: (context, i) {
                  final demo = _activeListings[i];
                  final priceText = demo.type == 'Rent'
                      ? demo.priceLabel
                      : fmtNairaCompact(demo.price); // ✅ FIX

                  return _FeaturedCard(
                    title: demo.title,
                    location: demo.location,
                    price: priceText,
                    badge: demo.verified ? 'Verified' : demo.badge,
                    gradient: demo.gradient,
                    onTap: () => _openListing(demo),
                  );
                },
              ),
            ),

            const SizedBox(height: AppSpacing.lg),

            Row(
              children: [
                Text(
                  'Popular near you',
                  style: Theme.of(context).textTheme.titleMedium?.copyWith(
                        fontWeight: FontWeight.w900,
                        color: AppColors.textPrimary(context),
                      ),
                ),
                const Spacer(),
                TextButton(
                  onPressed: () {},
                  child: const Text('See all  ›'),
                ),
              ],
            ),
            const SizedBox(height: AppSpacing.sm),

            ListView.separated(
              physics: const NeverScrollableScrollPhysics(),
              shrinkWrap: true,
              itemCount: _activeListings.length.clamp(0, 8),
              separatorBuilder: (_, __) => const SizedBox(height: AppSpacing.md),
              itemBuilder: (context, i) {
                final demo = _activeListings[i];

                final meta = demo.beds == 0
                    ? 'Plot size • ${demo.sqft} sqft'
                    : '${demo.beds} Beds • ${demo.baths} Baths • ${demo.sqft} sqft';

                final priceText = demo.type == 'Rent'
                    ? demo.priceLabel
                    : fmtNairaCompact(demo.price); // ✅ FIX

                return _ListingRowCard(
                  title: demo.title,
                  location: demo.location,
                  price: priceText,
                  meta: meta,
                  onTap: () => _openListing(demo),
                );
              },
            ),
          ],
        ),
      ),
    );
  }
}

// ---------------- UI widgets ----------------

class _SearchStub extends StatelessWidget {
  const _SearchStub({required this.onTap});
  final VoidCallback onTap;

  @override
  Widget build(BuildContext context) {
    final muted = AppColors.textMuted(context);

    return InkWell(
      onTap: onTap,
      borderRadius: BorderRadius.circular(AppRadii.button),
      child: Container(
        height: 52,
        padding: const EdgeInsets.symmetric(horizontal: AppSpacing.screenH),
        decoration: BoxDecoration(
          color: AppColors.surface(context).withValues(alpha: 0.85),
          borderRadius: BorderRadius.circular(AppRadii.button),
          border: Border.all(color: AppColors.overlay(context, 0.06)),
          boxShadow: AppShadows.lift(context, blur: 18, y: 10, alpha: 0.08),
        ),
        child: Row(
          children: [
            Icon(Icons.search_rounded, color: muted),
            const SizedBox(width: AppSpacing.sm),
            Expanded(
              child: Text(
                'Search by location, rent, or city...',
                style: Theme.of(context).textTheme.bodyMedium?.copyWith(
                      color: muted,
                      fontWeight: FontWeight.w700,
                    ),
              ),
            ),
            const Icon(Icons.tune_rounded, color: AppColors.brandGreenDeep),
          ],
        ),
      ),
    );
  }
}

class _QuickActionsRow extends StatelessWidget {
  const _QuickActionsRow({
    required this.onFilter,
    required this.onMap,
    required this.onSaved,
  });

  final VoidCallback onFilter;
  final VoidCallback onMap;
  final VoidCallback onSaved;

  @override
  Widget build(BuildContext context) {
    return Row(
      children: [
        Expanded(
          child: _PillButton(
            icon: Icons.filter_alt_rounded,
            text: 'Filters',
            onTap: onFilter,
            filled: true,
          ),
        ),
        const SizedBox(width: AppSpacing.sm),
        Expanded(
          child: _PillButton(
            icon: Icons.map_rounded,
            text: 'Map',
            onTap: onMap,
            filled: false,
          ),
        ),
        const SizedBox(width: AppSpacing.sm),
        Expanded(
          child: _PillButton(
            icon: Icons.bookmark_border_rounded,
            text: 'Saved',
            onTap: onSaved,
            filled: false,
          ),
        ),
      ],
    );
  }
}

class _ChipRow extends StatelessWidget {
  const _ChipRow({
    required this.chips,
    required this.activeIndex,
    required this.onTap,
  });

  final List<String> chips;
  final int activeIndex;
  final ValueChanged<int> onTap;

  @override
  Widget build(BuildContext context) {
    return SizedBox(
      height: 44,
      child: ListView.separated(
        scrollDirection: Axis.horizontal,
        itemCount: chips.length,
        separatorBuilder: (_, __) => const SizedBox(width: AppSpacing.sm),
        itemBuilder: (context, i) {
          final active = i == activeIndex;
          return InkWell(
            onTap: () => onTap(i),
            borderRadius: BorderRadius.circular(AppRadii.chip),
            child: Container(
              padding: const EdgeInsets.symmetric(
                horizontal: AppSpacing.md,
                vertical: AppSpacing.xs,
              ),
              decoration: BoxDecoration(
                gradient: active ? AppColors.brandGradient : null,
                color: active
                    ? null
                    : AppColors.surface(context).withValues(alpha: 0.78),
                borderRadius: BorderRadius.circular(AppRadii.chip),
                border: Border.all(color: AppColors.overlay(context, 0.06)),
              ),
              child: Center(
                child: Text(
                  chips[i],
                  style: TextStyle(
                    fontWeight: FontWeight.w900,
                    color:
                        active ? Colors.white : AppColors.textPrimary(context),
                  ),
                ),
              ),
            ),
          );
        },
      ),
    );
  }
}

class _FeaturedCard extends StatelessWidget {
  const _FeaturedCard({
    required this.title,
    required this.location,
    required this.price,
    required this.badge,
    required this.gradient,
    required this.onTap,
  });

  final String title;
  final String location;
  final String price;
  final String badge;
  final Gradient gradient;
  final VoidCallback onTap;

  @override
  Widget build(BuildContext context) {
    return InkWell(
      onTap: onTap,
      borderRadius: BorderRadius.circular(AppRadii.card),
      child: Container(
        width: 280,
        decoration: BoxDecoration(
          gradient: gradient,
          borderRadius: BorderRadius.circular(AppRadii.card),
          boxShadow: AppShadows.lift(context, blur: 22, y: 12, alpha: 0.10),
        ),
        child: Stack(
          children: [
            Positioned(
              right: AppSpacing.sm,
              top: AppSpacing.sm,
              child: Container(
                padding: const EdgeInsets.symmetric(
                  horizontal: AppSpacing.sm,
                  vertical: 6,
                ),
                decoration: BoxDecoration(
                  color: Colors.white.withValues(alpha: 0.22),
                  borderRadius: BorderRadius.circular(AppRadii.chip),
                  border: Border.all(
                    color: Colors.white.withValues(alpha: 0.25),
                  ),
                ),
                child: Text(
                  badge,
                  style: const TextStyle(
                    fontWeight: FontWeight.w900,
                    color: Colors.white,
                  ),
                ),
              ),
            ),
            Positioned(
              left: AppSpacing.md,
              right: AppSpacing.md,
              bottom: AppSpacing.md,
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    title,
                    maxLines: 1,
                    overflow: TextOverflow.ellipsis,
                    style: Theme.of(context).textTheme.titleMedium?.copyWith(
                          fontWeight: FontWeight.w900,
                          color: Colors.white,
                        ),
                  ),
                  const SizedBox(height: 4),
                  Text(
                    location,
                    maxLines: 1,
                    overflow: TextOverflow.ellipsis,
                    style: Theme.of(context).textTheme.bodySmall?.copyWith(
                          color: Colors.white.withValues(alpha: 0.85),
                          fontWeight: FontWeight.w700,
                        ),
                  ),
                  const SizedBox(height: AppSpacing.sm),
                  Container(
                    padding: const EdgeInsets.symmetric(
                      horizontal: AppSpacing.sm,
                      vertical: 8,
                    ),
                    decoration: BoxDecoration(
                      color: Colors.white.withValues(alpha: 0.18),
                      borderRadius: BorderRadius.circular(AppRadii.button),
                      border: Border.all(
                        color: Colors.white.withValues(alpha: 0.22),
                      ),
                    ),
                    child: Text(
                      price,
                      style: const TextStyle(
                        fontWeight: FontWeight.w900,
                        color: Colors.white,
                      ),
                    ),
                  ),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }
}

class _ListingRowCard extends StatelessWidget {
  const _ListingRowCard({
    required this.title,
    required this.location,
    required this.price,
    required this.meta,
    required this.onTap,
  });

  final String title;
  final String location;
  final String price;
  final String meta;
  final VoidCallback onTap;

  @override
  Widget build(BuildContext context) {
    return InkWell(
      onTap: onTap,
      borderRadius: BorderRadius.circular(AppRadii.card),
      child: Container(
        padding: const EdgeInsets.all(AppSpacing.md),
        decoration: BoxDecoration(
          color: AppColors.surface(context).withValues(alpha: 0.85),
          borderRadius: BorderRadius.circular(AppRadii.card),
          border: Border.all(color: AppColors.overlay(context, 0.06)),
          boxShadow: AppShadows.lift(context, blur: 18, y: 10, alpha: 0.06),
        ),
        child: Row(
          children: [
            Container(
              height: 62,
              width: 62,
              decoration: BoxDecoration(
                color: AppColors.brandBlueSoft.withValues(alpha: 0.12),
                borderRadius: BorderRadius.circular(AppRadii.sm),
                border: Border.all(color: AppColors.overlay(context, 0.06)),
              ),
              child: const Icon(
                Icons.home_rounded,
                color: AppColors.brandBlueSoft,
              ),
            ),
            const SizedBox(width: AppSpacing.md),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    title,
                    maxLines: 1,
                    overflow: TextOverflow.ellipsis,
                    style: Theme.of(context).textTheme.titleSmall?.copyWith(
                          fontWeight: FontWeight.w900,
                          color: AppColors.textPrimary(context),
                        ),
                  ),
                  const SizedBox(height: 2),
                  Text(
                    location,
                    maxLines: 1,
                    overflow: TextOverflow.ellipsis,
                    style: Theme.of(context).textTheme.bodySmall?.copyWith(
                          color: AppColors.textSecondary(context),
                          fontWeight: FontWeight.w700,
                        ),
                  ),
                  const SizedBox(height: AppSpacing.sm),
                  Text(
                    meta,
                    style: Theme.of(context).textTheme.bodySmall?.copyWith(
                          color: AppColors.textMuted(context),
                          fontWeight: FontWeight.w700,
                        ),
                  ),
                ],
              ),
            ),
            const SizedBox(width: AppSpacing.md),
            Column(
              crossAxisAlignment: CrossAxisAlignment.end,
              children: [
                Text(
                  price,
                  style: Theme.of(context).textTheme.titleSmall?.copyWith(
                        fontWeight: FontWeight.w900,
                        color: AppColors.brandGreenDeep,
                      ),
                ),
                const SizedBox(height: AppSpacing.sm),
                Icon(
                  Icons.chevron_right_rounded,
                  color: AppColors.textMuted(context),
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }
}

class _PillButton extends StatelessWidget {
  const _PillButton({
    required this.icon,
    required this.text,
    required this.onTap,
    required this.filled,
  });

  final IconData icon;
  final String text;
  final VoidCallback onTap;
  final bool filled;

  @override
  Widget build(BuildContext context) {
    final fg = filled ? Colors.white : AppColors.brandGreenDeep;
    final bg = filled
        ? AppColors.brandGreenDeep.withValues(alpha: 0.90)
        : AppColors.surface(context).withValues(alpha: 0.78);

    return InkWell(
      onTap: onTap,
      borderRadius: BorderRadius.circular(AppRadii.button),
      child: Container(
        height: 44,
        padding: const EdgeInsets.symmetric(horizontal: AppSpacing.sm),
        decoration: BoxDecoration(
          color: bg,
          borderRadius: BorderRadius.circular(AppRadii.button),
          border: Border.all(color: AppColors.overlay(context, 0.06)),
          boxShadow: AppShadows.soft(context, blur: 14, y: 8, alpha: 0.08),
        ),
        child: Row(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Icon(icon, size: 18, color: fg),
            const SizedBox(width: AppSpacing.sm),
            Flexible(
              child: Text(
                text,
                maxLines: 1,
                overflow: TextOverflow.ellipsis,
                style: TextStyle(
                  color: fg,
                  fontWeight: FontWeight.w900,
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }
}

// ---------------- demo data ----------------

class _DemoListing {
  const _DemoListing({
    required this.id,
    required this.title,
    required this.location,
    required this.priceLabel,
    required this.badge,
    required this.gradient,
    required this.beds,
    required this.baths,
    required this.sqft,
    required this.verified,
    required this.type,
    required this.price,
  });

  final String id;
  final String title;
  final String location;
  final String priceLabel;
  final String badge;
  final Gradient gradient;
  final int beds;
  final int baths;
  final int sqft;
  final bool verified;
  final String type;
  final int price;
}

// ===== FILE: lib/features/tenant/home/home_controller.dart =====

import 'package:flutter/foundation.dart';
import '../../../shared/models/listing_model.dart';

class TenantHomeController extends ChangeNotifier {
  bool loading = false;
  String? error;

  final List<ListingModel> listings = [];

  Future<void> load() async {
    loading = true;
    error = null;
    notifyListeners();

    try {
      await Future<void>.delayed(const Duration(milliseconds: 350));
      listings
        ..clear()
        ..addAll([
          const ListingModel(
            id: 'l1',
            title: 'Modern 2 Bedroom Apartment',
            price: 1200000,
            currency: 'NGN',
            location: 'Lekki, Lagos',
            status: 'active',
            beds: 2,
            baths: 2,
            type: 'Apartment',
            mediaUrls: [],
            propertyStatus: 'available',
          ),
          const ListingModel(
            id: 'l2',
            title: 'Cozy Studio (Close to Main Road)',
            price: 450000,
            currency: 'NGN',
            location: 'Yaba, Lagos',
            status: 'active',
            beds: 1,
            baths: 1,
            type: 'Studio',
            mediaUrls: [],
            propertyStatus: 'maintenance',
          ),
          const ListingModel(
            id: 'l3',
            title: 'Family Duplex (4 Beds) - Promo',
            price: 3500000,
            currency: 'NGN',
            location: 'Ikeja, Lagos',
            status: 'paused',
            beds: 4,
            baths: 4,
            type: 'Duplex',
            mediaUrls: [],
            propertyStatus: 'available',
          ),
        ]);

      loading = false;
      notifyListeners();
    } catch (_) {
      loading = false;
      error = 'Failed to load listings.';
      notifyListeners();
    }
  }
}


// ===== FILE: lib/features/tenant/home/home_screen.dart =====

import 'package:flutter/material.dart';
import '../../../core/ui/scaffold/app_scaffold.dart';
import '../../../core/ui/scaffold/app_top_bar.dart';

class HomeScreen extends StatelessWidget {
  const HomeScreen({super.key});

  @override
  Widget build(BuildContext context) {
    final cs = Theme.of(context).colorScheme;

    return AppScaffold(
      topBar: const AppTopBar(title: 'Home'),
      child: Padding(
        padding: const EdgeInsets.all(16),
        child: ListView(
          children: [
            Container(
              padding: const EdgeInsets.all(14),
              decoration: BoxDecoration(
                color: cs.surfaceContainerHighest.withValues(alpha: 0.25),
                borderRadius: BorderRadius.circular(16),
                border: Border.all(
                  color: cs.outlineVariant.withValues(alpha: 0.4),
                ),
              ),
              child: Row(
                children: [
                  const Icon(Icons.search_rounded),
                  const SizedBox(width: 10),
                  Expanded(
                    child: Text(
                      'Search location, property type, price…',
                      style: TextStyle(color: cs.onSurfaceVariant),
                    ),
                  ),
                ],
              ),
            ),
            const SizedBox(height: 16),
            Text(
              'Featured (Demo)',
              style: Theme.of(
                context,
              ).textTheme.titleLarge?.copyWith(fontWeight: FontWeight.w700),
            ),
            const SizedBox(height: 12),
            _DemoCard(
              title: '2 Bedroom Apartment',
              subtitle: 'Lekki • ₦1,200,000 / year',
              badge: 'available',
            ),
            const SizedBox(height: 10),
            _DemoCard(
              title: 'Studio Apartment',
              subtitle: 'Yaba • ₦650,000 / year',
              badge: 'pending',
            ),
            const SizedBox(height: 10),
            _DemoCard(
              title: '3 Bedroom Duplex',
              subtitle: 'Ikeja • ₦2,400,000 / year',
              badge: 'maintenance',
            ),
          ],
        ),
      ),
    );
  }
}

class _DemoCard extends StatelessWidget {
  const _DemoCard({
    required this.title,
    required this.subtitle,
    required this.badge,
  });
  final String title;
  final String subtitle;
  final String badge;

  @override
  Widget build(BuildContext context) {
    final cs = Theme.of(context).colorScheme;

    Color bg;
    Color fg;
    switch (badge) {
      case 'available':
        bg = cs.primaryContainer;
        fg = cs.onPrimaryContainer;
        break;
      case 'maintenance':
        bg = cs.errorContainer;
        fg = cs.onErrorContainer;
        break;
      default:
        bg = cs.secondaryContainer;
        fg = cs.onSecondaryContainer;
    }

    return Container(
      padding: const EdgeInsets.all(14),
      decoration: BoxDecoration(
        color: cs.surfaceContainerHighest.withValues(alpha: 0.18),
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: cs.outlineVariant.withValues(alpha: (0.35))),
      ),
      child: Row(
        children: [
          Container(
            width: 46,
            height: 46,
            decoration: BoxDecoration(
              color: cs.surfaceContainerHighest.withValues(alpha: 0.35),
              borderRadius: BorderRadius.circular(14),
            ),
            child: const Icon(Icons.home_work_rounded),
          ),
          const SizedBox(width: 12),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  title,
                  style: const TextStyle(fontWeight: FontWeight.w700),
                ),
                const SizedBox(height: 4),
                Text(subtitle, style: TextStyle(color: cs.onSurfaceVariant)),
              ],
            ),
          ),
          const SizedBox(width: 10),
          Container(
            padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 6),
            decoration: BoxDecoration(
              color: bg,
              borderRadius: BorderRadius.circular(999),
            ),
            child: Text(
              badge,
              style: TextStyle(color: fg, fontWeight: FontWeight.w700),
            ),
          ),
        ],
      ),
    );
  }
}


// ===== FILE: lib/features/tenant/listing_detail/listing_detail_screen.dart =====

import 'dart:ui';
import 'package:flutter/material.dart';

import '../../../core/ui/scaffold/app_scaffold.dart';
import '../../../shared/models/listing_model.dart';
import '../../../shared/services/toast_service.dart';

import '../../../core/theme/app_colors.dart';
import '../../../core/theme/app_spacing.dart';
import '../../../core/theme/app_radii.dart';
import '../../../core/theme/app_shadows.dart';

class ListingDetailScreen extends StatefulWidget {
  const ListingDetailScreen({
    super.key,
    required this.listing,
    required this.saved,
    required this.onToggleSaved,

    // ✅ New (optional): lets Explore control CTA mode
    // intent: 'buy' | 'viewing' | 'inspection'
    this.intent,
    this.primaryActionLabel,
  });

  final ListingModel listing;
  final bool saved;
  final VoidCallback onToggleSaved;

  /// 'buy' | 'viewing' | 'inspection' (optional)
  final String? intent;

  /// If passed, it overrides the default CTA label (optional)
  final String? primaryActionLabel;

  @override
  State<ListingDetailScreen> createState() => _ListingDetailScreenState();
}

class _ListingDetailScreenState extends State<ListingDetailScreen> {
  static const _bgTop = AppColors.lightBg;
  static const _bgBottom = AppColors.mist;
  static const _ink = AppColors.navy;
  static const _muted = AppColors.textMutedLight;
  static const _green = AppColors.brandGreenDeep;

  late final PageController _pageCtrl;
  int _page = 0;

  @override
  void initState() {
    super.initState();
    _pageCtrl = PageController();
  }

  @override
  void dispose() {
    _pageCtrl.dispose();
    super.dispose();
  }

  // ---------------- Helpers ----------------

  String _fmtMoney(String currency, num v) {
    final c = currency.trim().toUpperCase();
    final symbol =
        (c == 'NGN' || c == 'NAIRA' || c == '₦') ? '₦' : currency.trim();

    final s = v.toStringAsFixed(0);
    final buf = StringBuffer();
    for (int i = 0; i < s.length; i++) {
      final idxFromEnd = s.length - i;
      buf.write(s[i]);
      if (idxFromEnd > 1 && idxFromEnd % 3 == 1) buf.write(',');
    }
    return symbol.isEmpty ? buf.toString() : '$symbol$buf';
  }

  bool get _ctaDisabled {
    final ps = (widget.listing.propertyStatus ?? '').toLowerCase();
    return ps == 'occupied' || ps == 'maintenance' || ps == 'unavailable';
  }

  String get _ctaDisabledReason {
    final ps = (widget.listing.propertyStatus ?? '').toLowerCase();
    if (ps == 'occupied') return 'Occupied';
    if (ps == 'maintenance') return 'Under maintenance';
    if (ps == 'unavailable') return 'Unavailable';
    return 'Not available';
  }

  bool _isVerifiedDeal(ListingModel l) {
    final s = l.status.toLowerCase();
    return s.contains('verified') || s.contains('approved') || s.contains('active');
  }

  _ListingCategory _inferCategory(ListingModel l) {
    final t = (l.type ?? '').toLowerCase().trim();
    final title = l.title.toLowerCase();
    final status = l.status.toLowerCase();

    if (t.contains('land') || title.contains('land') || title.contains('plot')) {
      return _ListingCategory.land;
    }

    if (t.contains('commercial') ||
        title.contains('office') ||
        title.contains('shop') ||
        title.contains('warehouse') ||
        title.contains('commercial')) {
      return _ListingCategory.commercial;
    }

    if (t.contains('rent') ||
        status.contains('rent') ||
        title.contains('/yr') ||
        title.contains('/mo')) {
      return _ListingCategory.rent;
    }

    return _ListingCategory.buy;
  }

  String _defaultPrimaryCtaLabel(_ListingCategory cat) {
    switch (cat) {
      case _ListingCategory.buy:
        return 'Buy Options';
      case _ListingCategory.rent:
        return 'Pay Rent';
      case _ListingCategory.land:
        return 'Request Inspection';
      case _ListingCategory.commercial:
        return 'Schedule Tour';
    }
  }

  /// ✅ Explore override rules:
  /// - intent=buy -> Buy Property
  /// - intent=viewing -> Request Viewing
  /// - intent=inspection -> Request Inspection
  String _primaryCtaLabelResolved(_ListingCategory cat) {
    final override = (widget.primaryActionLabel ?? '').trim();
    if (override.isNotEmpty) return override;

    final intent = (widget.intent ?? '').trim().toLowerCase();
    if (intent == 'buy') return 'Buy Property';
    if (intent == 'viewing') return 'Request Viewing';
    if (intent == 'inspection') return 'Request Inspection';

    return _defaultPrimaryCtaLabel(cat);
  }

  void _toast(String msg) => ToastService.show(context, msg, success: true);

  // ---------------- UI ----------------

  @override
  Widget build(BuildContext context) {
    final l = widget.listing;

    final cat = _inferCategory(l);
    final isVerified = _isVerifiedDeal(l);

    final priceText = _fmtMoney(l.currency, l.price);

    final isRentLike =
        cat == _ListingCategory.rent || cat == _ListingCategory.commercial;
    final periodSuffix = isRentLike ? ' / yr' : '';

    final media = l.mediaUrls;
    final imageCount = media.isNotEmpty ? media.length : 8;

    final beds = l.beds ?? 0;
    final baths = l.baths ?? 0;
    final typeLabel = (l.type ?? '').trim();

    String metaLine() {
      if (cat == _ListingCategory.land) {
        return typeLabel.isNotEmpty ? typeLabel : 'Land';
      }
      if (cat == _ListingCategory.commercial) {
        return typeLabel.isNotEmpty ? typeLabel : 'Commercial';
      }
      final parts = <String>[];
      if (beds > 0) parts.add('$beds Beds');
      if (baths > 0) parts.add('$baths Baths');
      if (typeLabel.isNotEmpty) parts.add(typeLabel);
      return parts.isEmpty ? '—' : parts.join(' • ');
    }

    final primaryLabel = _primaryCtaLabelResolved(cat);

    return AppScaffold(
      padding: EdgeInsets.zero,
      child: DecoratedBox(
        decoration: const BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [_bgTop, _bgBottom],
          ),
        ),
        child: SafeArea(
          bottom: false,
          child: Stack(
            children: [
              CustomScrollView(
                slivers: [
                  SliverToBoxAdapter(
                    child: _HeroGallery(
                      title: l.title,
                      mediaUrls: media,
                      fallbackCount: imageCount,
                      pageCtrl: _pageCtrl,
                      page: _page,
                      onPage: (i) => setState(() => _page = i),
                      saved: widget.saved,
                      onToggleSaved: widget.onToggleSaved,
                      onBack: () => Navigator.of(context).maybePop(),
                      onShare: () => _toast('Share (wire later)'),
                      isVerified: isVerified,
                      isSponsored: false,
                    ),
                  ),
                  SliverToBoxAdapter(
                    child: Padding(
                      padding: const EdgeInsets.fromLTRB(
                        AppSpacing.md,
                        AppSpacing.md,
                        AppSpacing.md,
                        110,
                      ),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          _FrostCard(
                            child: Padding(
                              padding: const EdgeInsets.all(AppSpacing.md),
                              child: Column(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: [
                                  Text(
                                    '$priceText$periodSuffix',
                                    style: Theme.of(context)
                                        .textTheme
                                        .headlineSmall
                                        ?.copyWith(
                                          fontWeight: FontWeight.w900,
                                          color: _ink,
                                        ),
                                  ),
                                  const SizedBox(height: AppSpacing.sm),
                                  Text(
                                    metaLine(),
                                    style: Theme.of(context)
                                        .textTheme
                                        .bodyMedium
                                        ?.copyWith(
                                          fontWeight: FontWeight.w800,
                                          color: _muted,
                                        ),
                                  ),
                                  const SizedBox(height: AppSpacing.md),
                                  Row(
                                    children: [
                                      const Icon(
                                        Icons.location_on_rounded,
                                        size: 18,
                                        color: _green,
                                      ),
                                      const SizedBox(width: 6),
                                      Expanded(
                                        child: Text(
                                          l.location,
                                          maxLines: 2,
                                          overflow: TextOverflow.ellipsis,
                                          style: Theme.of(context)
                                              .textTheme
                                              .bodyMedium
                                              ?.copyWith(
                                                fontWeight: FontWeight.w900,
                                                color: _ink,
                                              ),
                                        ),
                                      ),
                                    ],
                                  ),
                                  if ((l.propertyStatus ?? '').isNotEmpty) ...[
                                    const SizedBox(height: AppSpacing.md),
                                    Row(
                                      children: [
                                        Icon(
                                          Icons.info_outline_rounded,
                                          size: 18,
                                          color: _muted.withValues(alpha: 0.9),
                                        ),
                                        const SizedBox(width: 8),
                                        Text(
                                          'Availability: ${l.propertyStatus}',
                                          style: Theme.of(context)
                                              .textTheme
                                              .bodySmall
                                              ?.copyWith(
                                                fontWeight: FontWeight.w800,
                                                color: _muted,
                                              ),
                                        ),
                                      ],
                                    ),
                                  ],
                                ],
                              ),
                            ),
                          ),
                          const SizedBox(height: AppSpacing.md),

                          _QuickChipsRow(
                            verified: isVerified,
                            available: !_ctaDisabled,
                            furnished: false,
                            serviced: false,
                            agentListed: true,
                          ),
                          const SizedBox(height: AppSpacing.md),

                          _Section(
                            title: 'Overview',
                            child: _OverviewBlock(
                              text:
                                  'Wire real description later from backend.\n\nOwner: ${(l.ownerName ?? '—')}\nType: ${(l.type ?? '—')}\nStatus: ${l.status}',
                              onReadMore: () => _toast('Read more (wire later)'),
                            ),
                          ),
                          const SizedBox(height: AppSpacing.md),

                          _Section(
                            title: 'Features',
                            child: const _FeaturesGrid(
                              features: [
                                'Parking',
                                'Security',
                                'Water',
                                'Power backup',
                                'CCTV',
                                'Gate house',
                              ],
                            ),
                          ),
                          const SizedBox(height: AppSpacing.md),

                          _Section(
                            title: 'Location',
                            child: _MapCard(
                              locationLabel: l.location,
                              onOpenMaps: () => _toast('Open in Maps (wire later)'),
                            ),
                          ),
                          const SizedBox(height: AppSpacing.md),

                          _Section(
                            title: 'Agent / Landlord',
                            child: _AgentCard(
                              name: (l.ownerName ?? 'Agent'),
                              verified: true,
                              ratingText: '⭐ 4.8',
                              onChat: () => _toast('Chat (wire later)'),
                              onCall: () => _toast('Call (wire later)'),
                            ),
                          ),
                          const SizedBox(height: AppSpacing.md),

                          _Section(
                            title: 'Payment & Fees',
                            child: _PaymentFeesCardSimple(
                              category: cat,
                              priceText: '$priceText$periodSuffix',
                            ),
                          ),
                          const SizedBox(height: AppSpacing.md),

                          _Section(
                            title: 'Similar listings',
                            child: _SimilarListingsRow(
                              onTap: () => _toast('Open similar listing (wire later)'),
                            ),
                          ),

                          const SizedBox(height: AppSpacing.lg),

                          if (_ctaDisabled) ...[
                            Container(
                              width: double.infinity,
                              padding: const EdgeInsets.all(AppSpacing.md),
                              decoration: BoxDecoration(
                                borderRadius: BorderRadius.circular(AppRadii.card),
                                color: Theme.of(context).colorScheme.error.withAlpha(18),
                                border: Border.all(
                                  color: Theme.of(context).colorScheme.error.withAlpha(90),
                                ),
                              ),
                              child: Text('CTAs disabled: $_ctaDisabledReason'),
                            ),
                          ],
                        ],
                      ),
                    ),
                  ),
                ],
              ),

              Align(
                alignment: Alignment.bottomCenter,
                child: _StickyActionBar(
                  primaryLabel: primaryLabel,
                  disabled: _ctaDisabled,
                  onMessage: () => _toast('Message (wire later)'),
                  onCall: () => _toast('Call (wire later)'),
                  onPrimary: _ctaDisabled
                      ? null
                      : () => _toast('$primaryLabel (wire later)'),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}

enum _ListingCategory { buy, rent, land, commercial }

/* ======================== HERO ======================== */

class _HeroGallery extends StatelessWidget {
  const _HeroGallery({
    required this.title,
    required this.mediaUrls,
    required this.fallbackCount,
    required this.pageCtrl,
    required this.page,
    required this.onPage,
    required this.saved,
    required this.onToggleSaved,
    required this.onBack,
    required this.onShare,
    required this.isVerified,
    required this.isSponsored,
  });

  final String title;
  final List<String> mediaUrls;
  final int fallbackCount;

  final PageController pageCtrl;
  final int page;
  final ValueChanged<int> onPage;

  final bool saved;
  final VoidCallback onToggleSaved;

  final VoidCallback onBack;
  final VoidCallback onShare;

  final bool isVerified;
  final bool isSponsored;

  static const _ink = AppColors.navy;
  static const _green = AppColors.brandGreenDeep;

  @override
  Widget build(BuildContext context) {
    final count = mediaUrls.isNotEmpty ? mediaUrls.length : fallbackCount;

    return SizedBox(
      height: 320,
      child: Stack(
        children: [
          PageView.builder(
            controller: pageCtrl,
            itemCount: count,
            onPageChanged: onPage,
            itemBuilder: (_, i) {
              if (mediaUrls.isNotEmpty) {
                final url = mediaUrls[i];
                return _NetworkImageHero(url: url);
              }
              return Container(
                decoration: BoxDecoration(
                  color: const Color(0xFFCFDBEA).withValues(alpha: 0.85),
                ),
                alignment: Alignment.center,
                child: Icon(
                  Icons.photo_rounded,
                  size: 60,
                  color: _ink.withValues(alpha: 0.55),
                ),
              );
            },
          ),

          SafeArea(
            child: Padding(
              padding: const EdgeInsets.fromLTRB(10, 10, 10, 0),
              child: Row(
                children: [
                  _CircleIcon(
                    icon: Icons.arrow_back_ios_new_rounded,
                    onTap: onBack,
                  ),
                  const Spacer(),
                  _CircleIcon(icon: Icons.share_rounded, onTap: onShare),
                  const SizedBox(width: 10),
                  _CircleIcon(
                    icon: saved
                        ? Icons.favorite_rounded
                        : Icons.favorite_border_rounded,
                    onTap: onToggleSaved,
                  ),
                ],
              ),
            ),
          ),

          Positioned(
            left: 14,
            right: 14,
            bottom: 16,
            child: Text(
              title,
              maxLines: 1,
              overflow: TextOverflow.ellipsis,
              style: Theme.of(context).textTheme.titleLarge?.copyWith(
                fontWeight: FontWeight.w900,
                color: Colors.white,
                shadows: [
                  Shadow(
                    blurRadius: 14,
                    color: AppColors.overlay(context, 0.35),
                    offset: const Offset(0, 6),
                  ),
                ],
              ),
            ),
          ),

          Positioned(
            left: 14,
            bottom: 64,
            child: Row(
              children: [
                if (isVerified)
                  const _Badge(
                    icon: Icons.check_rounded,
                    text: 'Verified Deal',
                    color: _green,
                  ),
                if (isSponsored) ...[
                  if (isVerified) const SizedBox(width: 8),
                  const _Badge(
                    icon: Icons.campaign_rounded,
                    text: 'Sponsored',
                    color: _ink,
                    subtle: true,
                  ),
                ],
              ],
            ),
          ),

          Positioned(
            right: 14,
            top: 54,
            child: Container(
              padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 6),
              decoration: BoxDecoration(
                color: AppColors.overlay(context, 0.28),
                borderRadius: BorderRadius.circular(999),
              ),
              child: Text(
                '${page + 1}/$count',
                style: const TextStyle(
                  fontWeight: FontWeight.w900,
                  color: Colors.white,
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }
}

class _NetworkImageHero extends StatelessWidget {
  const _NetworkImageHero({required this.url});
  final String url;

  @override
  Widget build(BuildContext context) {
    return Container(
      color: const Color(0xFFCFDBEA).withValues(alpha: 0.5),
      child: Image.network(
        url,
        fit: BoxFit.cover,
        errorBuilder: (context, error, stackTrace) {
          return Center(
            child: Icon(
              Icons.broken_image_rounded,
              size: 60,
              color: AppColors.overlay(context, 0.35),
            ),
          );
        },
        loadingBuilder: (_, child, progress) {
          if (progress == null) return child;
          return Center(
            child: SizedBox(
              height: 22,
              width: 22,
              child: CircularProgressIndicator(
                strokeWidth: 2.5,
                value: progress.expectedTotalBytes == null
                    ? null
                    : progress.cumulativeBytesLoaded /
                        (progress.expectedTotalBytes ?? 1),
              ),
            ),
          );
        },
      ),
    );
  }
}

class _CircleIcon extends StatelessWidget {
  const _CircleIcon({required this.icon, required this.onTap});
  final IconData icon;
  final VoidCallback onTap;

  @override
  Widget build(BuildContext context) {
    return InkWell(
      onTap: onTap,
      borderRadius: BorderRadius.circular(999),
      child: Container(
        height: 42,
        width: 42,
        decoration: BoxDecoration(
          color: AppColors.surface(context).withValues(alpha: 0.68),
          borderRadius: BorderRadius.circular(999),
          border: Border.all(color: AppColors.overlay(context, 0.08)),
          boxShadow: AppShadows.soft(context, blur: 14, y: 8, alpha: 0.08),
        ),
        child: Icon(icon, size: 20),
      ),
    );
  }
}

class _Badge extends StatelessWidget {
  const _Badge({
    required this.icon,
    required this.text,
    required this.color,
    this.subtle = false,
  });

  final IconData icon;
  final String text;
  final Color color;
  final bool subtle;

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 7),
      decoration: BoxDecoration(
        color: subtle
            ? AppColors.surface(context).withValues(alpha: 0.55)
            : color.withValues(alpha: 0.85),
        borderRadius: BorderRadius.circular(999),
        border: Border.all(
          color: subtle
              ? AppColors.overlay(context, 0.08)
              : AppColors.surface(context).withValues(alpha: 0.35),
        ),
      ),
      child: Row(
        mainAxisSize: MainAxisSize.min,
        children: [
          Icon(icon, size: 16, color: subtle ? color : Colors.white),
          const SizedBox(width: 6),
          Text(
            text,
            style: TextStyle(
              fontWeight: FontWeight.w900,
              color: subtle ? color : Colors.white,
            ),
          ),
        ],
      ),
    );
  }
}

/* ======================== CHIPS ======================== */

class _QuickChipsRow extends StatelessWidget {
  const _QuickChipsRow({
    required this.verified,
    required this.available,
    required this.furnished,
    required this.serviced,
    required this.agentListed,
  });

  final bool verified;
  final bool available;
  final bool furnished;
  final bool serviced;
  final bool agentListed;

  @override
  Widget build(BuildContext context) {
    final chips = <Widget>[
      if (verified) const _Chip(icon: Icons.check_circle_rounded, text: 'Verified'),
      _Chip(
        icon: available ? Icons.event_available_rounded : Icons.event_busy_rounded,
        text: available ? 'Available' : 'Unavailable',
      ),
      if (furnished) const _Chip(icon: Icons.weekend_rounded, text: 'Furnished'),
      if (serviced)
        const _Chip(icon: Icons.home_repair_service_rounded, text: 'Serviced'),
      _Chip(
        icon: agentListed ? Icons.verified_user_rounded : Icons.person_rounded,
        text: agentListed ? 'Agent listed' : 'Direct owner',
      ),
    ];

    return SingleChildScrollView(
      scrollDirection: Axis.horizontal,
      child: Row(
        children: chips
            .map((w) => Padding(padding: const EdgeInsets.only(right: 10), child: w))
            .toList(),
      ),
    );
  }
}

class _Chip extends StatelessWidget {
  const _Chip({required this.icon, required this.text});
  final IconData icon;
  final String text;

  static const _ink = AppColors.navy;
  static const _muted = AppColors.textMutedLight;

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 9),
      decoration: BoxDecoration(
        color: AppColors.surface(context).withValues(alpha: 0.60),
        borderRadius: BorderRadius.circular(999),
        border: Border.all(color: AppColors.overlay(context, 0.06)),
      ),
      child: Row(
        mainAxisSize: MainAxisSize.min,
        children: [
          Icon(icon, size: 16, color: _muted.withValues(alpha: 0.9)),
          const SizedBox(width: 8),
          Text(
            text,
            style: const TextStyle(fontWeight: FontWeight.w900, color: _ink),
          ),
        ],
      ),
    );
  }
}

/* ======================== SECTIONS ======================== */

class _Section extends StatelessWidget {
  const _Section({required this.title, required this.child});
  final String title;
  final Widget child;

  static const _ink = AppColors.navy;

  @override
  Widget build(BuildContext context) {
    return _FrostCard(
      child: Padding(
        padding: const EdgeInsets.all(14),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              title,
              style: Theme.of(context).textTheme.titleMedium?.copyWith(
                    fontWeight: FontWeight.w900,
                    color: _ink,
                  ),
            ),
            const SizedBox(height: 10),
            child,
          ],
        ),
      ),
    );
  }
}

class _OverviewBlock extends StatelessWidget {
  const _OverviewBlock({required this.text, required this.onReadMore});
  final String text;
  final VoidCallback onReadMore;

  static const _muted = AppColors.textMutedLight;
  static const _green = AppColors.brandGreenDeep;

  @override
  Widget build(BuildContext context) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          text,
          maxLines: 5,
          overflow: TextOverflow.ellipsis,
          style: Theme.of(context).textTheme.bodyMedium?.copyWith(
                fontWeight: FontWeight.w800,
                color: _muted.withValues(alpha: 0.95),
                height: 1.35,
              ),
        ),
        const SizedBox(height: 10),
        Align(
          alignment: Alignment.centerRight,
          child: InkWell(
            onTap: onReadMore,
            borderRadius: BorderRadius.circular(999),
            child: const Padding(
              padding: EdgeInsets.symmetric(horizontal: 10, vertical: 6),
              child: Row(
                mainAxisSize: MainAxisSize.min,
                children: [
                  Text(
                    'Read more',
                    style: TextStyle(
                      fontWeight: FontWeight.w900,
                      color: _green,
                    ),
                  ),
                  SizedBox(width: 6),
                  Icon(Icons.chevron_right_rounded, size: 20, color: _green),
                ],
              ),
            ),
          ),
        ),
      ],
    );
  }
}

class _FeaturesGrid extends StatelessWidget {
  const _FeaturesGrid({required this.features});
  final List<String> features;

  static const _muted = AppColors.textMutedLight;

  @override
  Widget build(BuildContext context) {
    final items = features.take(10).toList();
    if (items.isEmpty) {
      return Text(
        'No features listed yet.',
        style: Theme.of(context).textTheme.bodyMedium?.copyWith(
              fontWeight: FontWeight.w800,
              color: _muted,
            ),
      );
    }

    return Wrap(
      spacing: 10,
      runSpacing: 10,
      children: items.map((t) => _FeaturePill(text: t)).toList(),
    );
  }
}

class _FeaturePill extends StatelessWidget {
  const _FeaturePill({required this.text});
  final String text;

  static const _ink = AppColors.navy;

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 10),
      decoration: BoxDecoration(
        color: AppColors.surface(context).withValues(alpha: 0.55),
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: AppColors.overlay(context, 0.06)),
      ),
      child: Text(
        text,
        style: const TextStyle(fontWeight: FontWeight.w900, color: _ink),
      ),
    );
  }
}

class _MapCard extends StatelessWidget {
  const _MapCard({required this.locationLabel, required this.onOpenMaps});
  final String locationLabel;
  final VoidCallback onOpenMaps;

  static const _blue = AppColors.brandBlueSoft;
  static const _muted = AppColors.textMutedLight;

  @override
  Widget build(BuildContext context) {
    return Column(
      children: [
        ClipRRect(
          borderRadius: BorderRadius.circular(AppRadii.card),
          child: Container(
            height: 150,
            color: const Color(0xFFCFDBEA).withValues(alpha: 0.85),
            alignment: Alignment.center,
            child: Text(
              'Map preview (wire later)\n$locationLabel',
              textAlign: TextAlign.center,
              style: Theme.of(context).textTheme.bodySmall?.copyWith(
                    fontWeight: FontWeight.w900,
                    color: _muted,
                  ),
            ),
          ),
        ),
        const SizedBox(height: 10),
        Align(
          alignment: Alignment.centerRight,
          child: InkWell(
            onTap: onOpenMaps,
            borderRadius: BorderRadius.circular(999),
            child: Container(
              padding: const EdgeInsets.symmetric(
                horizontal: AppSpacing.md,
                vertical: AppSpacing.sm,
              ),
              decoration: BoxDecoration(
                color: _blue.withValues(alpha: 0.12),
                borderRadius: BorderRadius.circular(999),
                border: Border.all(color: _blue.withValues(alpha: 0.18)),
              ),
              child: const Row(
                mainAxisSize: MainAxisSize.min,
                children: [
                  Icon(Icons.map_rounded, size: 18, color: _blue),
                  SizedBox(width: 8),
                  Text(
                    'Open in Maps',
                    style: TextStyle(fontWeight: FontWeight.w900, color: _blue),
                  ),
                ],
              ),
            ),
          ),
        ),
      ],
    );
  }
}

class _AgentCard extends StatelessWidget {
  const _AgentCard({
    required this.name,
    required this.verified,
    required this.ratingText,
    required this.onChat,
    required this.onCall,
  });

  final String name;
  final bool verified;
  final String ratingText;
  final VoidCallback onChat;
  final VoidCallback onCall;

  static const _blue = AppColors.brandBlueSoft;
  static const _ink = AppColors.navy;
  static const _muted = AppColors.textMutedLight;
  static const _green = AppColors.brandGreenDeep;

  @override
  Widget build(BuildContext context) {
    return Row(
      children: [
        const CircleAvatar(
          radius: 22,
          backgroundColor: Color(0xFFCFDBEA),
          child: Icon(Icons.person_rounded, color: _blue),
        ),
        const SizedBox(width: 10),
        Expanded(
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text(
                name,
                style: Theme.of(context).textTheme.bodyLarge?.copyWith(
                      fontWeight: FontWeight.w900,
                      color: _ink,
                    ),
              ),
              const SizedBox(height: 4),
              Row(
                children: [
                  if (verified) ...[
                    Container(
                      padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                      decoration: BoxDecoration(
                        color: _green.withValues(alpha: 0.14),
                        borderRadius: BorderRadius.circular(999),
                        border: Border.all(color: _green.withValues(alpha: 0.20)),
                      ),
                      child: const Text(
                        'Verified',
                        style: TextStyle(
                          fontWeight: FontWeight.w900,
                          color: _green,
                          fontSize: 12,
                        ),
                      ),
                    ),
                    const SizedBox(width: 8),
                  ],
                  Text(
                    ratingText,
                    style: const TextStyle(
                      fontWeight: FontWeight.w900,
                      color: _muted,
                    ),
                  ),
                ],
              ),
            ],
          ),
        ),
        const SizedBox(width: 10),
        _IconBtn(icon: Icons.chat_rounded, onTap: onChat),
        const SizedBox(width: 10),
        _IconBtn(icon: Icons.call_rounded, onTap: onCall),
      ],
    );
  }
}

class _IconBtn extends StatelessWidget {
  const _IconBtn({required this.icon, required this.onTap});
  final IconData icon;
  final VoidCallback onTap;

  static const _blue = AppColors.brandBlueSoft;

  @override
  Widget build(BuildContext context) {
    return InkWell(
      onTap: onTap,
      borderRadius: BorderRadius.circular(AppRadii.sm),
      child: Container(
        height: 40,
        width: 40,
        decoration: BoxDecoration(
          color: AppColors.surface(context).withValues(alpha: 0.6),
          borderRadius: BorderRadius.circular(AppRadii.sm),
          border: Border.all(color: AppColors.overlay(context, 0.06)),
        ),
        child: Icon(icon, size: 18, color: _blue),
      ),
    );
  }
}

class _PaymentFeesCardSimple extends StatelessWidget {
  const _PaymentFeesCardSimple({
    required this.category,
    required this.priceText,
  });

  final _ListingCategory category;
  final String priceText;

  static const _muted = AppColors.textMutedLight;
  static const _ink = AppColors.navy;

  @override
  Widget build(BuildContext context) {
    final rows = <_KV>[];

    switch (category) {
      case _ListingCategory.rent:
        rows.add(_KV('Rent', priceText));
        rows.add(const _KV('Caution deposit', '— (wire later)'));
        rows.add(const _KV('Agency fee', '— (wire later)'));
        rows.add(const _KV('Service charge', '— (wire later)'));
        break;

      case _ListingCategory.buy:
        rows.add(_KV('Price', priceText));
        rows.add(const _KV('Escrow supported', 'Yes (wire later)'));
        break;

      case _ListingCategory.land:
        rows.add(_KV('Price', priceText));
        rows.add(const _KV('Documentation', 'C of O / Gazette / Deed (wire later)'));
        break;

      case _ListingCategory.commercial:
        rows.add(_KV('Price', priceText));
        rows.add(const _KV('Power', '— (wire later)'));
        break;
    }

    return Column(
      children: rows
          .map(
            (kv) => Padding(
              padding: const EdgeInsets.only(bottom: 8),
              child: Row(
                children: [
                  Expanded(
                    child: Text(
                      kv.k,
                      style: Theme.of(context).textTheme.bodySmall?.copyWith(
                            fontWeight: FontWeight.w800,
                            color: _muted.withValues(alpha: 0.9),
                          ),
                    ),
                  ),
                  Text(
                    kv.v,
                    style: Theme.of(context).textTheme.bodySmall?.copyWith(
                          fontWeight: FontWeight.w900,
                          color: _ink,
                        ),
                  ),
                ],
              ),
            ),
          )
          .toList(),
    );
  }
}

class _KV {
  const _KV(this.k, this.v);
  final String k;
  final String v;
}

class _SimilarListingsRow extends StatelessWidget {
  const _SimilarListingsRow({required this.onTap});
  final VoidCallback onTap;

  static const _muted = AppColors.textMutedLight;

  @override
  Widget build(BuildContext context) {
    return SizedBox(
      height: 130,
      child: ListView.separated(
        scrollDirection: Axis.horizontal,
        itemCount: 8,
        separatorBuilder: (context, index) => const SizedBox(width: 12),
        itemBuilder: (context, index) {
          return InkWell(
            onTap: onTap,
            borderRadius: BorderRadius.circular(AppRadii.card),
            child: Container(
              width: 170,
              decoration: BoxDecoration(
                color: AppColors.surface(context).withValues(alpha: 0.58),
                borderRadius: BorderRadius.circular(AppRadii.card),
                border: Border.all(color: AppColors.overlay(context, 0.06)),
              ),
              padding: const EdgeInsets.all(AppSpacing.md),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Expanded(
                    child: ClipRRect(
                      borderRadius: BorderRadius.circular(AppRadii.button),
                      child: Container(
                        color: const Color(0xFFCFDBEA).withValues(alpha: 0.85),
                        alignment: Alignment.center,
                        child: const Icon(Icons.home_rounded),
                      ),
                    ),
                  ),
                  const SizedBox(height: AppSpacing.sm),
                  const Text(
                    'Similar listing',
                    maxLines: 1,
                    overflow: TextOverflow.ellipsis,
                    style: TextStyle(fontWeight: FontWeight.w900),
                  ),
                  const SizedBox(height: 4),
                  const Text(
                    'Tap to open (wire later)',
                    maxLines: 1,
                    overflow: TextOverflow.ellipsis,
                    style: TextStyle(
                      fontWeight: FontWeight.w800,
                      color: _muted,
                    ),
                  ),
                ],
              ),
            ),
          );
        },
      ),
    );
  }
}

/* ======================== Sticky Bar ======================== */

class _StickyActionBar extends StatelessWidget {
  const _StickyActionBar({
    required this.primaryLabel,
    required this.disabled,
    required this.onMessage,
    required this.onCall,
    required this.onPrimary,
  });

  final String primaryLabel;
  final bool disabled;
  final VoidCallback onMessage;
  final VoidCallback onCall;
  final VoidCallback? onPrimary;

  static const _green = AppColors.brandGreenDeep;

  @override
  Widget build(BuildContext context) {
    return ClipRRect(
      child: BackdropFilter(
        filter: ImageFilter.blur(sigmaX: 14, sigmaY: 14),
        child: Container(
          padding: const EdgeInsets.fromLTRB(12, 10, 12, 18),
          decoration: BoxDecoration(
            color: AppColors.surface(context).withValues(alpha: 0.62),
            border: Border(
              top: BorderSide(color: AppColors.overlay(context, 0.06)),
            ),
          ),
          child: SafeArea(
            top: false,
            child: Row(
              children: [
                _MiniAction(
                  icon: Icons.message_rounded,
                  label: 'Message',
                  onTap: onMessage,
                ),
                const SizedBox(width: 10),
                _MiniAction(
                  icon: Icons.call_rounded,
                  label: 'Call',
                  onTap: onCall,
                ),
                const SizedBox(width: 10),
                Expanded(
                  child: InkWell(
                    onTap: disabled ? null : onPrimary,
                    borderRadius: BorderRadius.circular(AppRadii.card),
                    child: Container(
                      height: 48,
                      alignment: Alignment.center,
                      decoration: BoxDecoration(
                        color: disabled
                            ? const Color(0xFFB9C1CF).withValues(alpha: 0.45)
                            : _green.withValues(alpha: 0.85),
                        borderRadius: BorderRadius.circular(AppRadii.card),
                        border: Border.all(
                          color: disabled
                              ? AppColors.overlay(context, 0.06)
                              : _green.withValues(alpha: 0.25),
                        ),
                        boxShadow: AppShadows.soft(
                          context,
                          blur: 14,
                          y: 10,
                          alpha: disabled ? 0.02 : 0.10,
                        ),
                      ),
                      child: Text(
                        disabled ? '$primaryLabel (Disabled)' : primaryLabel,
                        style: TextStyle(
                          fontWeight: FontWeight.w900,
                          color: disabled ? AppColors.textMutedLight : Colors.white,
                          fontSize: 16,
                        ),
                      ),
                    ),
                  ),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }
}

class _MiniAction extends StatelessWidget {
  const _MiniAction({
    required this.icon,
    required this.label,
    required this.onTap,
  });

  final IconData icon;
  final String label;
  final VoidCallback onTap;

  static const _blue = AppColors.brandBlueSoft;
  static const _muted = AppColors.textMutedLight;

  @override
  Widget build(BuildContext context) {
    return InkWell(
      onTap: onTap,
      borderRadius: BorderRadius.circular(AppRadii.button),
      child: Container(
        width: 86,
        height: 48,
        decoration: BoxDecoration(
          color: AppColors.surface(context).withValues(alpha: 0.55),
          borderRadius: BorderRadius.circular(AppRadii.button),
          border: Border.all(color: AppColors.overlay(context, 0.06)),
        ),
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Icon(icon, size: 18, color: _blue),
            const SizedBox(height: 4),
            const Text(
              '',
              style: TextStyle(
                fontWeight: FontWeight.w900,
                color: _muted,
                fontSize: 12,
              ),
            ),
            Text(
              label,
              style: const TextStyle(
                fontWeight: FontWeight.w900,
                color: _muted,
                fontSize: 12,
              ),
            ),
          ],
        ),
      ),
    );
  }
}

/* ======================== Frost Card ======================== */

class _FrostCard extends StatelessWidget {
  const _FrostCard({required this.child});
  final Widget child;

  @override
  Widget build(BuildContext context) {
    return Container(
      decoration: BoxDecoration(
        color: AppColors.surface(context).withValues(alpha: 0.62),
        borderRadius: BorderRadius.circular(AppRadii.card),
        border: Border.all(
          color: AppColors.surface(context).withValues(alpha: 0.55),
        ),
        boxShadow: AppShadows.lift(context, blur: 18, y: 10, alpha: 0.08),
      ),
      child: child,
    );
  }
}

/* ======================== Small util ======================== */

String _fmtNairaCompact(num v) {
  final s = v.toInt().toString();
  final buf = StringBuffer();
  for (int i = 0; i < s.length; i++) {
    final idxFromEnd = s.length - i;
    buf.write(s[i]);
    if (idxFromEnd > 1 && idxFromEnd % 3 == 1) buf.write(',');
  }
  return '₦$buf';
}

// ===== FILE: lib/features/tenant/maintenance/create_request_screen.dart =====

// ignore_for_file: deprecated_member_use
import 'package:flutter/material.dart';

import 'maintenance_detail_screen.dart';

import '../../../core/theme/app_spacing.dart';
import '../../../core/ui/scaffold/app_scaffold.dart';
import '../../../core/ui/scaffold/app_top_bar.dart';
import '../../../shared/services/toast_service.dart';

import '../../../core/theme/app_colors.dart';

class CreateMaintenanceRequestScreen extends StatefulWidget {
  const CreateMaintenanceRequestScreen({super.key});

  @override
  State<CreateMaintenanceRequestScreen> createState() =>
      _CreateMaintenanceRequestScreenState();
}

class _CreateMaintenanceRequestScreenState
    extends State<CreateMaintenanceRequestScreen> {
  String _category = 'Plumbing';
  String _priority = 'Medium';
  String _visit = 'Anytime';
  bool _permissionToEnter = false;

  final _titleCtrl = TextEditingController();
  final _descCtrl = TextEditingController();

  @override
  void dispose() {
    _titleCtrl.dispose();
    _descCtrl.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return AppScaffold(
      topBar: const AppTopBar(
        title: 'New Maintenance Request',
        subtitle: 'Create and submit a request',
      ),
      // ✅ Key fix: make the whole page scrollable + keyboard safe
      child: LayoutBuilder(
        builder: (context, constraints) {
          return SingleChildScrollView(
            keyboardDismissBehavior: ScrollViewKeyboardDismissBehavior.onDrag,
            padding: const EdgeInsets.fromLTRB(
              AppSpacing.lg,
              AppSpacing.sm,
              AppSpacing.lg,
              140, // extra bottom so it never overflows behind nav / keyboard
            ),
            child: ConstrainedBox(
              constraints: BoxConstraints(minHeight: constraints.maxHeight),
              child: IntrinsicHeight(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    _Card(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          _H('Category'),
                          const SizedBox(height: AppSpacing.sm),
                          DropdownButtonFormField<String>(
                            value: _category,
                            items: const [
                              DropdownMenuItem(
                                value: 'Plumbing',
                                child: Text('Plumbing'),
                              ),
                              DropdownMenuItem(
                                value: 'Electrical',
                                child: Text('Electrical'),
                              ),
                              DropdownMenuItem(value: 'AC', child: Text('AC')),
                              DropdownMenuItem(
                                value: 'Security',
                                child: Text('Security'),
                              ),
                              DropdownMenuItem(
                                value: 'Other',
                                child: Text('Other'),
                              ),
                            ],
                            onChanged: (v) =>
                                setState(() => _category = v ?? 'Plumbing'),
                            decoration: const InputDecoration(
                              border: OutlineInputBorder(),
                              isDense: true,
                            ),
                          ),
                          const SizedBox(height: AppSpacing.md),

                          _H('Title'),
                          const SizedBox(height: AppSpacing.sm),
                          TextField(
                            controller: _titleCtrl,
                            textInputAction: TextInputAction.next,
                            decoration: const InputDecoration(
                              border: OutlineInputBorder(),
                              hintText: 'e.g. Leaking kitchen pipe',
                              isDense: true,
                            ),
                          ),
                          const SizedBox(height: AppSpacing.md),

                          _H('Description'),
                          const SizedBox(height: AppSpacing.sm),
                          TextField(
                            controller: _descCtrl,
                            minLines: 4,
                            maxLines: 7,
                            decoration: const InputDecoration(
                              border: OutlineInputBorder(),
                              hintText: 'Describe the issue...',
                            ),
                          ),
                          const SizedBox(height: AppSpacing.md),

                          _H('Priority'),
                          const SizedBox(height: AppSpacing.sm),
                          DropdownButtonFormField<String>(
                            value: _priority,
                            items: const [
                              DropdownMenuItem(
                                value: 'Low',
                                child: Text('Low'),
                              ),
                              DropdownMenuItem(
                                value: 'Normal',
                                child: Text('Normal'),
                              ),
                              DropdownMenuItem(
                                value: 'Medium',
                                child: Text('Medium'),
                              ),
                              DropdownMenuItem(
                                value: 'High',
                                child: Text('High'),
                              ),
                            ],
                            onChanged: (v) =>
                                setState(() => _priority = v ?? 'Medium'),
                            decoration: const InputDecoration(
                              border: OutlineInputBorder(),
                              isDense: true,
                            ),
                          ),
                        ],
                      ),
                    ),

                    const SizedBox(height: AppSpacing.md),

                    _Card(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          _H('Photos'),
                          const SizedBox(height: AppSpacing.sm),
                          Row(
                            children: [
                              Expanded(
                                child: Container(
                                  height: 92,
                                  decoration: BoxDecoration(
                                    borderRadius: BorderRadius.circular(16),
                                    color: Theme.of(context)
                                        .colorScheme
                                        .surfaceContainerHighest
                                        .withValues(alpha: 0.75),
                                    border: Border.all(
                                      color: Colors.black.withValues(
                                        alpha: 0.06,
                                      ),
                                    ),
                                  ),
                                  child: InkWell(
                                    borderRadius: BorderRadius.circular(16),
                                    onTap: () => ToastService.show(
                                      context,
                                      'Photo upload (wire later)',
                                      success: true,
                                    ),
                                    child: const Center(
                                      child: Column(
                                        mainAxisSize: MainAxisSize.min,
                                        children: [
                                          Icon(Icons.add_a_photo_rounded),
                                          SizedBox(height: 6),
                                          Text(
                                            'Add photos',
                                            style: TextStyle(
                                              fontWeight: FontWeight.w800,
                                            ),
                                          ),
                                        ],
                                      ),
                                    ),
                                  ),
                                ),
                              ),
                            ],
                          ),
                          const SizedBox(height: AppSpacing.md),

                          _H('Preferred visit time'),
                          const SizedBox(height: AppSpacing.sm),
                          Wrap(
                            spacing: 10,
                            runSpacing: 10,
                            children: [
                              _ChoicePill(
                                text: 'Anytime',
                                selected: _visit == 'Anytime',
                                onTap: () => setState(() => _visit = 'Anytime'),
                              ),
                              _ChoicePill(
                                text: 'Morning',
                                selected: _visit == 'Morning',
                                onTap: () => setState(() => _visit = 'Morning'),
                              ),
                              _ChoicePill(
                                text: 'Afternoon',
                                selected: _visit == 'Afternoon',
                                onTap: () =>
                                    setState(() => _visit = 'Afternoon'),
                              ),
                              _ChoicePill(
                                text: 'Evening',
                                selected: _visit == 'Evening',
                                onTap: () => setState(() => _visit = 'Evening'),
                              ),
                            ],
                          ),
                          const SizedBox(height: AppSpacing.md),

                          Row(
                            children: [
                              Expanded(
                                child: Text(
                                  'Permission to enter if not home',
                                  style: Theme.of(context).textTheme.bodySmall
                                      ?.copyWith(fontWeight: FontWeight.w900),
                                ),
                              ),
                              Switch(
                                value: _permissionToEnter,
                                onChanged: (v) =>
                                    setState(() => _permissionToEnter = v),
                              ),
                            ],
                          ),
                        ],
                      ),
                    ),

                    const SizedBox(height: AppSpacing.lg),

                    SizedBox(
                      width: double.infinity,
                      height: 52,
                      child: FilledButton(
                        onPressed: () {
                          if (_titleCtrl.text.trim().isEmpty ||
                              _descCtrl.text.trim().isEmpty) {
                            ToastService.show(
                              context,
                              'Please enter title + description',
                              success: false,
                            );
                            return;
                          }

                          final now = DateTime.now();
                          const months = <String>[
                            'Jan',
                            'Feb',
                            'Mar',
                            'Apr',
                            'May',
                            'Jun',
                            'Jul',
                            'Aug',
                            'Sep',
                            'Oct',
                            'Nov',
                            'Dec',
                          ];
                          final dateLabel =
                              '${months[now.month - 1]} ${now.day}';

                          ToastService.show(
                            context,
                            'Submitted (demo) • $_category • $_priority • $_visit',
                            success: true,
                          );

                          Navigator.of(context).pushReplacement(
                            MaterialPageRoute(
                              builder: (_) => MaintenanceDetailScreen(
                                requestId: 'new_${now.millisecondsSinceEpoch}',
                                status: 'open',
                                title: _titleCtrl.text.trim(),
                                category: _category,
                                dateLabel: dateLabel,
                                address: '123 Maple St, Apt 2B',
                                priority: _priority,
                              ),
                            ),
                          );
                        },
                        child: const Text('Submit Request'),
                      ),
                    ),

                    const Spacer(), // keeps layout stable on tall screens
                  ],
                ),
              ),
            ),
          );
        },
      ),
    );
  }
}

/* ---------------- UI helpers ---------------- */

class _Card extends StatelessWidget {
  const _Card({required this.child});
  final Widget child;

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.all(AppSpacing.lg),
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(18),
        color: Theme.of(
          context,
        ).colorScheme.surfaceContainerHighest.withValues(alpha: 0.55),
        border: Border.all(color: AppColors.overlay(context, 0.06)),
      ),
      child: child,
    );
  }
}

class _H extends StatelessWidget {
  const _H(this.text);
  final String text;

  @override
  Widget build(BuildContext context) {
    return Text(
      text,
      style: Theme.of(
        context,
      ).textTheme.bodySmall?.copyWith(fontWeight: FontWeight.w900),
    );
  }
}

class _ChoicePill extends StatelessWidget {
  const _ChoicePill({
    required this.text,
    required this.selected,
    required this.onTap,
  });

  final String text;
  final bool selected;
  final VoidCallback onTap;

  @override
  Widget build(BuildContext context) {
    final base = Theme.of(context).colorScheme;
    return InkWell(
      borderRadius: BorderRadius.circular(999),
      onTap: onTap,
      child: Container(
        padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 10),
        decoration: BoxDecoration(
          borderRadius: BorderRadius.circular(999),
          color: selected ? base.primary.withValues(alpha: 0.14) : Colors.white,
          border: Border.all(
            color: selected
                ? base.primary.withValues(alpha: 0.45)
                : AppColors.overlay(context, 0.08),
          ),
        ),
        child: Text(
          text,
          style: Theme.of(context).textTheme.bodyMedium?.copyWith(
            fontWeight: FontWeight.w800,
            color: selected ? base.primary : null,
          ),
        ),
      ),
    );
  }
}


// ===== FILE: lib/features/tenant/maintenance/maintenance_detail_screen.dart =====

import 'package:flutter/material.dart';

import '../../../core/theme/app_spacing.dart';
import '../../../core/ui/scaffold/app_scaffold.dart';
import '../../../core/ui/scaffold/app_top_bar.dart';
import '../../../shared/services/toast_service.dart';
import '../../../shared/widgets/status_badge.dart';
import '../../../core/constants/status_badge_map.dart';

import '../../../core/theme/app_colors.dart';

class MaintenanceDetailScreen extends StatelessWidget {
  const MaintenanceDetailScreen({
    super.key,
    required this.requestId,
    required this.status,
    this.title,
    this.category,
    this.dateLabel,
    this.address,
    this.priority,
    this.description,
    this.permissionToEnter,
  });

  final String requestId;
  final String
  status; // open / in_progress / resolved / rejected (match your badge map)
  final String? title;
  final String? category;
  final String? dateLabel;
  final String? address;
  final String? priority;
  final String? description;
  final bool? permissionToEnter;

  bool get _canCancel => status == 'open';

  @override
  Widget build(BuildContext context) {
    final t = Theme.of(context);

    final safeTitle = (title ?? 'Maintenance Request').trim();
    final safeCategory = (category ?? 'Other').trim();
    final safeDate = (dateLabel ?? '—').trim();
    final safeAddr = (address ?? '—').trim();
    final safePriority = (priority ?? 'Normal').trim();
    final safeDesc =
        (description ??
                'Describe what is wrong (wire to backend later). Photos and scheduling will appear here once connected.')
            .trim();

    return AppScaffold(
      topBar: AppTopBar(title: safeTitle, subtitle: safeAddr),
      child: SingleChildScrollView(
        padding: const EdgeInsets.only(bottom: AppSpacing.lg),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // Header row
            Row(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Expanded(
                  child: Wrap(
                    runSpacing: 6,
                    children: [
                      _MetaChip(
                        icon: Icons.category_rounded,
                        text: safeCategory,
                      ),
                      _MetaChip(icon: Icons.event_rounded, text: safeDate),
                      _MetaChip(icon: Icons.flag_rounded, text: safePriority),
                    ],
                  ),
                ),
                const SizedBox(width: AppSpacing.sm),
                StatusBadge(
                  domain: StatusDomain.maintenance,
                  status: status,
                  compact: false,
                ),
              ],
            ),

            const SizedBox(height: AppSpacing.md),

            // Photo area (safe height -> no overflow)
            Container(
              height: 210,
              width: double.infinity,
              decoration: BoxDecoration(
                borderRadius: BorderRadius.circular(18),
                color: t.colorScheme.surfaceContainerHighest.withValues(
                  alpha: 0.55,
                ),
                border: Border.all(color: AppColors.overlay(context, 0.06)),
              ),
              child: Center(
                child: Text(
                  'Photo(s) (wire later)',
                  style: t.textTheme.bodyMedium?.copyWith(
                    fontWeight: FontWeight.w900,
                  ),
                ),
              ),
            ),

            const SizedBox(height: AppSpacing.lg),

            _SectionTitle('Description'),
            _Card(child: Text(safeDesc, style: t.textTheme.bodyMedium)),

            const SizedBox(height: AppSpacing.lg),

            _SectionTitle('Status timeline'),
            _Card(child: _Timeline(status: status)),

            const SizedBox(height: AppSpacing.lg),

            _SectionTitle('Visit / access'),
            _Card(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  _kv(
                    'Appointment',
                    status == 'in_progress'
                        ? 'Scheduled (demo)'
                        : 'Not scheduled',
                  ),
                  const SizedBox(height: AppSpacing.sm),
                  _kv(
                    'Permission to enter if not home',
                    (permissionToEnter ?? false) ? 'Yes' : 'No',
                  ),
                ],
              ),
            ),

            const SizedBox(height: AppSpacing.lg),

            // Optional actions
            Row(
              children: [
                Expanded(
                  child: OutlinedButton.icon(
                    onPressed: () => ToastService.show(
                      context,
                      'Chat/call landlord/agent (wire later)',
                      success: true,
                    ),
                    icon: const Icon(Icons.chat_bubble_outline_rounded),
                    label: const Text('Chat'),
                  ),
                ),
                const SizedBox(width: AppSpacing.md),
                Expanded(
                  child: OutlinedButton.icon(
                    onPressed: () => ToastService.show(
                      context,
                      'Call (wire later)',
                      success: true,
                    ),
                    icon: const Icon(Icons.call_rounded),
                    label: const Text('Call'),
                  ),
                ),
              ],
            ),

            const SizedBox(height: AppSpacing.lg),

            if (_canCancel)
              SizedBox(
                width: double.infinity,
                height: 52,
                child: FilledButton(
                  onPressed: () => _confirmCancel(context),
                  child: const Text('Cancel Request'),
                ),
              )
            else
              SizedBox(
                width: double.infinity,
                height: 52,
                child: FilledButton(
                  onPressed: null,
                  child: Text(
                    status == 'resolved'
                        ? 'Completed'
                        : status == 'rejected'
                        ? 'Rejected'
                        : 'In Progress',
                  ),
                ),
              ),
          ],
        ),
      ),
    );
  }

  void _confirmCancel(BuildContext context) {
    showDialog(
      context: context,
      builder: (_) => AlertDialog(
        title: const Text('Cancel request?'),
        content: const Text('This will stop the maintenance process (demo).'),
        actions: [
          TextButton(
            onPressed: () => Navigator.of(context).pop(),
            child: const Text('No'),
          ),
          FilledButton(
            onPressed: () {
              Navigator.of(context).pop();
              ToastService.show(
                context,
                'Request cancelled (demo)',
                success: true,
              );
              Navigator.of(context).pop();
            },
            child: const Text('Yes, cancel'),
          ),
        ],
      ),
    );
  }

  Widget _kv(String k, String v) {
    return Row(
      children: [
        Expanded(
          child: Text(k, style: const TextStyle(fontWeight: FontWeight.w900)),
        ),
        const SizedBox(width: 10),
        Text(v),
      ],
    );
  }
}

class _SectionTitle extends StatelessWidget {
  const _SectionTitle(this.text);
  final String text;

  @override
  Widget build(BuildContext context) {
    final t = Theme.of(context);
    return Padding(
      padding: const EdgeInsets.only(bottom: 10),
      child: Text(
        text,
        style: t.textTheme.titleSmall?.copyWith(fontWeight: FontWeight.w900),
      ),
    );
  }
}

class _Card extends StatelessWidget {
  const _Card({required this.child});
  final Widget child;

  @override
  Widget build(BuildContext context) {
    final t = Theme.of(context);
    return Container(
      width: double.infinity,
      padding: const EdgeInsets.all(AppSpacing.md),
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(18),
        color: t.colorScheme.surfaceContainerHighest.withValues(alpha: 0.55),
        border: Border.all(color: AppColors.overlay(context, 0.06)),
      ),
      child: child,
    );
  }
}

class _MetaChip extends StatelessWidget {
  const _MetaChip({required this.icon, required this.text});
  final IconData icon;
  final String text;

  @override
  Widget build(BuildContext context) {
    final t = Theme.of(context);
    final muted = t.textTheme.bodySmall?.color?.withValues(alpha: 0.75);

    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 7),
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(999),
        color: t.colorScheme.surfaceContainerHighest.withValues(alpha: 0.45),
        border: Border.all(color: AppColors.overlay(context, 0.05)),
      ),
      child: Row(
        mainAxisSize: MainAxisSize.min,
        children: [
          Icon(icon, size: 16, color: muted),
          const SizedBox(width: 6),
          Text(
            text,
            style: t.textTheme.bodySmall?.copyWith(
              color: muted,
              fontWeight: FontWeight.w900,
            ),
          ),
        ],
      ),
    );
  }
}

class _Timeline extends StatelessWidget {
  const _Timeline({required this.status});
  final String status;

  int get _step {
    if (status == 'open') return 0;
    if (status == 'in_progress') return 3;
    if (status == 'resolved') return 4;
    if (status == 'rejected') return 0; // show early state
    return 0;
  }

  @override
  Widget build(BuildContext context) {
    final t = Theme.of(context);
    final labels = const [
      'Submitted',
      'Assigned',
      'Scheduled',
      'In progress',
      'Completed',
    ];

    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Wrap(
          spacing: 10,
          runSpacing: 10,
          children: List.generate(labels.length, (i) {
            final done = i <= _step && status != 'rejected';
            final isRejected = status == 'rejected';

            return Container(
              padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
              decoration: BoxDecoration(
                borderRadius: BorderRadius.circular(999),
                color: isRejected
                    ? Colors.redAccent.withValues(alpha: 0.10)
                    : done
                    ? Colors.green.withValues(alpha: 0.12)
                    : t.colorScheme.surfaceContainerHighest.withValues(
                        alpha: 0.45,
                      ),
                border: Border.all(
                  color: isRejected
                      ? Colors.redAccent.withValues(alpha: 0.35)
                      : done
                      ? Colors.green.withValues(alpha: 0.25)
                      : AppColors.overlay(context, 0.06),
                ),
              ),
              child: Text(
                labels[i],
                style: t.textTheme.bodySmall?.copyWith(
                  fontWeight: FontWeight.w900,
                ),
              ),
            );
          }),
        ),
        if (status == 'rejected') ...[
          const SizedBox(height: AppSpacing.md),
          Text(
            'Rejected (demo)',
            style: t.textTheme.bodyMedium?.copyWith(
              fontWeight: FontWeight.w900,
              color: Colors.redAccent,
            ),
          ),
        ],
      ],
    );
  }
}


// ===== FILE: lib/features/tenant/maintenance/maintenance_screen.dart =====

import 'package:flutter/material.dart';

import '../../../core/theme/app_spacing.dart';
import '../../../core/ui/scaffold/app_scaffold.dart';
import '../../../core/ui/scaffold/app_top_bar.dart';
import '../../../shared/services/toast_service.dart';
import '../../../shared/widgets/primary_button.dart';
import '../../../shared/widgets/secondary_button.dart';
import '../../../shared/widgets/card_widgets/maintenance_card.dart';

import 'maintenance_detail_screen.dart';
import 'create_request_screen.dart';

import '../../../core/theme/app_colors.dart';

class MaintenanceScreen extends StatefulWidget {
  const MaintenanceScreen({super.key});

  @override
  State<MaintenanceScreen> createState() => _MaintenanceScreenState();
}

class _MaintenanceScreenState extends State<MaintenanceScreen> {
  // 0=open, 1=in_progress, 2=completed, 3=rejected
  int _tab = 0;

  // Demo data (wire later)
  final List<_Req> _all = const [
    _Req(
      id: 'm1',
      category: 'Plumbing',
      title: 'Leaking kitchen pipe',
      status: 'in_progress',
      dateLabel: 'Jan 24',
      priority: 'High',
      address: '123 Maple St, Apt 2B',
    ),
    _Req(
      id: 'm2',
      category: 'AC',
      title: 'Living room AC not cooling',
      status: 'open',
      dateLabel: 'Jan 21',
      priority: 'Medium',
      address: '123 Maple St, Apt 2B',
    ),
    _Req(
      id: 'm3',
      category: 'Security',
      title: 'Front door lock broken',
      status: 'resolved',
      dateLabel: 'Dec 29',
      priority: 'Normal',
      address: '123 Maple St, Apt 2B',
    ),
    _Req(
      id: 'm4',
      category: 'Electrical',
      title: 'Sockets sparking in kitchen',
      status: 'rejected',
      dateLabel: 'Dec 14',
      priority: 'High',
      address: '123 Maple St, Apt 2B',
    ),
  ];

  List<_Req> get _filtered {
    switch (_tab) {
      case 0:
        return _all.where((x) => x.status == 'open').toList();
      case 1:
        return _all.where((x) => x.status == 'in_progress').toList();
      case 2:
        // completed/resolved
        return _all.where((x) => x.status == 'resolved').toList();
      case 3:
        return _all.where((x) => x.status == 'rejected').toList();
      default:
        return _all;
    }
  }

  String _tabLabel(int i) {
    if (i == 0) return 'Open';
    if (i == 1) return 'In Progress';
    if (i == 2) return 'Completed';
    return 'Rejected';
  }

  void _openDetails(_Req r) {
    Navigator.of(context).push(
      MaterialPageRoute(
        builder: (_) => MaintenanceDetailScreen(
          requestId: r.id,
          status: r.status,
          // optional extra info (safe defaults in screen)
          title: r.title,
          category: r.category,
          dateLabel: r.dateLabel,
          address: r.address,
          priority: r.priority,
        ),
      ),
    );
  }

  void _openNewRequest() {
    Navigator.of(context).push(
      MaterialPageRoute(builder: (_) => const CreateMaintenanceRequestScreen()),
    );
  }

  @override
  Widget build(BuildContext context) {
    final list = _filtered;

    return AppScaffold(
      topBar: const AppTopBar(
        title: 'Maintenance',
        subtitle: 'Report issues in your home and track progress',
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          _SummaryCard(
            tenancyText: '123 Maple St, Apt 2B',
            onRequest: _openNewRequest,
            onEmergency: () => ToastService.show(
              context,
              'Emergency contact (wire later)',
              success: true,
            ),
          ),
          const SizedBox(height: AppSpacing.lg),

          _SegmentTabs(
            value: _tab,
            items: List.generate(4, (i) => _tabLabel(i)),
            onChanged: (v) => setState(() => _tab = v),
          ),
          const SizedBox(height: AppSpacing.md),

          if (list.isEmpty)
            _EmptyState(
              title: 'No requests here',
              subtitle: _tab == 0
                  ? 'You have no open maintenance requests.'
                  : 'Nothing to show in this tab.',
              ctaText: 'Request Maintenance',
              onCta: _openNewRequest,
            )
          else
            ...list.map(
              (x) => Padding(
                padding: const EdgeInsets.only(bottom: AppSpacing.md),
                child: InkWell(
                  onTap: () => _openDetails(x),
                  borderRadius: BorderRadius.circular(18),
                  child: MaintenanceCard(
                    title: x.title,
                    categoryText: x.category,
                    status: x.status,
                    priorityText: 'Priority: ${x.priority}',
                    onTap: () => _openDetails(x),
                  ),
                ),
              ),
            ),
        ],
      ),
    );
  }
}

/* ------------------ Small UI pieces ------------------ */

class _Req {
  const _Req({
    required this.id,
    required this.category,
    required this.title,
    required this.status,
    required this.dateLabel,
    required this.priority,
    required this.address,
  });

  final String id;
  final String category;
  final String title;
  final String status; // open / in_progress / resolved / rejected
  final String dateLabel;
  final String priority; // Low/Normal/Medium/High
  final String address;
}

class _SummaryCard extends StatelessWidget {
  const _SummaryCard({
    required this.tenancyText,
    required this.onRequest,
    required this.onEmergency,
  });

  final String tenancyText;
  final VoidCallback onRequest;
  final VoidCallback onEmergency;

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.all(AppSpacing.md),
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(18),
        color: Theme.of(
          context,
        ).colorScheme.surfaceContainerHighest.withValues(alpha: 0.55),
        border: Border.all(color: AppColors.overlay(context, 0.06)),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            'Maintenance',
            style: Theme.of(
              context,
            ).textTheme.titleLarge?.copyWith(fontWeight: FontWeight.w900),
          ),
          const SizedBox(height: AppSpacing.xs),
          Text(
            'Report issues in your home and track progress',
            style: Theme.of(context).textTheme.bodySmall?.copyWith(
              fontWeight: FontWeight.w700,
              color: AppColors.overlay(context, 0.60),
            ),
          ),
          const SizedBox(height: AppSpacing.md),
          Container(
            width: double.infinity,
            padding: const EdgeInsets.all(AppSpacing.md),
            decoration: BoxDecoration(
              borderRadius: BorderRadius.circular(16),
              color: AppColors.surface(context).withValues(alpha: 0.55),
              border: Border.all(color: AppColors.overlay(context, 0.06)),
            ),
            child: Row(
              children: [
                Icon(
                  Icons.home_rounded,
                  color: AppColors.overlay(context, 0.60),
                ),
                const SizedBox(width: AppSpacing.sm),
                Expanded(
                  child: Text(
                    tenancyText,
                    maxLines: 1,
                    overflow: TextOverflow.ellipsis,
                    style: Theme.of(context).textTheme.bodyMedium?.copyWith(
                      fontWeight: FontWeight.w800,
                    ),
                  ),
                ),
              ],
            ),
          ),
          const SizedBox(height: AppSpacing.md),
          Row(
            children: [
              Expanded(
                child: PrimaryButton(
                  label: 'Request Maintenance',
                  onPressed: onRequest,
                ),
              ),
              const SizedBox(width: AppSpacing.md),
              Expanded(
                child: SecondaryButton(
                  label: 'Emergency Contact',
                  onPressed: onEmergency,
                ),
              ),
            ],
          ),
        ],
      ),
    );
  }
}

class _SegmentTabs extends StatelessWidget {
  const _SegmentTabs({
    required this.value,
    required this.items,
    required this.onChanged,
  });

  final int value;
  final List<String> items;
  final ValueChanged<int> onChanged;

  @override
  Widget build(BuildContext context) {
    return Container(
      height: 44,
      padding: const EdgeInsets.all(4),
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(14),
        color: AppColors.surface(context).withValues(alpha: 0.60),
        border: Border.all(color: AppColors.overlay(context, 0.06)),
      ),
      child: Row(
        children: List.generate(items.length, (i) {
          final active = i == value;
          return Expanded(
            child: InkWell(
              onTap: () => onChanged(i),
              borderRadius: BorderRadius.circular(12),
              child: Container(
                alignment: Alignment.center,
                decoration: BoxDecoration(
                  borderRadius: BorderRadius.circular(12),
                  color: active
                      ? Theme.of(
                          context,
                        ).colorScheme.primary.withValues(alpha: 0.14)
                      : Colors.transparent,
                  border: Border.all(
                    color: active
                        ? Theme.of(
                            context,
                          ).colorScheme.primary.withValues(alpha: 0.22)
                        : Colors.transparent,
                  ),
                ),
                child: Text(
                  items[i],
                  maxLines: 1,
                  overflow: TextOverflow.ellipsis,
                  style: Theme.of(
                    context,
                  ).textTheme.bodySmall?.copyWith(fontWeight: FontWeight.w900),
                ),
              ),
            ),
          );
        }),
      ),
    );
  }
}

class _EmptyState extends StatelessWidget {
  const _EmptyState({
    required this.title,
    required this.subtitle,
    required this.ctaText,
    required this.onCta,
  });

  final String title;
  final String subtitle;
  final String ctaText;
  final VoidCallback onCta;

  @override
  Widget build(BuildContext context) {
    return Container(
      padding: const EdgeInsets.all(AppSpacing.lg),
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(18),
        color: AppColors.surface(context).withValues(alpha: 0.55),
        border: Border.all(color: AppColors.overlay(context, 0.06)),
      ),
      child: Column(
        children: [
          Icon(
            Icons.build_rounded,
            size: 34,
            color: AppColors.overlay(context, 0.60),
          ),
          const SizedBox(height: AppSpacing.sm),
          Text(
            title,
            style: Theme.of(
              context,
            ).textTheme.titleMedium?.copyWith(fontWeight: FontWeight.w900),
          ),
          const SizedBox(height: AppSpacing.xs),
          Text(
            subtitle,
            textAlign: TextAlign.center,
            style: Theme.of(context).textTheme.bodySmall?.copyWith(
              fontWeight: FontWeight.w700,
              color: AppColors.overlay(context, 0.60),
            ),
          ),
          const SizedBox(height: AppSpacing.md),
          PrimaryButton(label: ctaText, onPressed: onCta),
        ],
      ),
    );
  }
}


// ===== FILE: lib/features/tenant/messages/messages_screen.dart =====

import 'package:flutter/material.dart';

import '../../../core/ui/scaffold/app_scaffold.dart';

class MessagesScreen extends StatelessWidget {
  const MessagesScreen({super.key});

  @override
  Widget build(BuildContext context) {
    return const AppScaffold(
      child: SafeArea(child: Center(child: Text('Messages (placeholder)'))),
    );
  }
}


// ===== FILE: lib/features/tenant/more/more_screen.dart =====

import "package:flutter/material.dart";

import "../profile/settings_screen.dart";

import "../maintenance/maintenance_screen.dart";
import "../renting_tools/renting_tools_screen.dart";
import "../viewings/viewings_screen.dart";
import '../../../core/ui/scaffold/app_scaffold.dart';
import '../../../core/ui/scaffold/app_top_bar.dart';

import '../../../core/theme/app_colors.dart';

class MoreScreen extends StatelessWidget {
  const MoreScreen({super.key});

  static const _bgTop = AppColors.lightBg;
  static const _bgBottom = AppColors.mist;
  static const _green = AppColors.brandGreenDeep;
  static const _blue = AppColors.brandBlueSoft;
  static const _muted = AppColors.textMutedLight;

  @override
  Widget build(BuildContext context) {
    return AppScaffold(
      topBar: const AppTopBar(title: 'More'),
      child: DecoratedBox(
        decoration: const BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [_bgTop, _bgBottom],
          ),
        ),
        child: SafeArea(
          bottom: false,
          child: SingleChildScrollView(
            padding: const EdgeInsets.fromLTRB(14, 10, 14, 140),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const _TopHeader(),
                const SizedBox(height: 14),
                const _ProfileCard(),
                const SizedBox(height: 16),

                _MenuTile(
                  icon: Icons.account_balance_wallet_rounded,
                  iconBg: const Color(0xFFCFDBEA),
                  iconFg: _blue,
                  title: "Payments",
                  onTap: () {},
                ),
                const SizedBox(height: 10),

                _MenuTile(
                  icon: Icons.construction_rounded,
                  iconBg: const Color(0xFFD7E6DD),
                  iconFg: _green,
                  title: "Renting Tools",
                  subtitle: "Tenancies • Applications • Viewings",
                  onTap: () {
                    Navigator.of(context).push(
                      MaterialPageRoute(
                        builder: (_) => const RentingToolsScreen(),
                      ),
                    );
                  },
                ),
                const SizedBox(height: 10),

                _MenuTile(
                  icon: Icons.event_rounded,
                  iconBg: const Color(0xFFE7E3D1),
                  iconFg: const Color(0xFF6B6B6B),
                  title: "My Viewings",
                  onTap: () {
                    Navigator.of(context).push(
                      MaterialPageRoute(builder: (_) => const ViewingsScreen()),
                    );
                  },
                ),
                const SizedBox(height: 10),

                _MenuTile(
                  icon: Icons.description_rounded,
                  iconBg: const Color(0xFFCFDBEA),
                  iconFg: _blue,
                  title: "Documents",
                  onTap: () {},
                ),
                const SizedBox(height: 10),

                _MenuTile(
                  icon: Icons.build_rounded,
                  iconBg: const Color(0xFFD7E6DD),
                  iconFg: _green,
                  title: "Maintenance",
                  onTap: () {
                    Navigator.of(context).push(
                      MaterialPageRoute(
                        builder: (_) => const MaintenanceScreen(),
                      ),
                    );
                  },
                ),
                const SizedBox(height: 10),

                _MenuTile(
                  icon: Icons.help_outline_rounded,
                  iconBg: const Color(0xFFE7E3D1),
                  iconFg: const Color(0xFF6B6B6B),
                  title: "Support",
                  onTap: () {},
                ),
                const SizedBox(height: 10),

                _MenuTile(
                  icon: Icons.settings_rounded,
                  iconBg: const Color(0xFFD9D9D9),
                  iconFg: const Color(0xFF6B6B6B),
                  title: "Settings",
                  onTap: () {
                    Navigator.of(context).push(
                      MaterialPageRoute(builder: (_) => const SettingsScreen()),
                    );
                  },
                ),

                const SizedBox(height: 18),
                Center(
                  child: Text(
                    "HomeStead v1.0.0",
                    style: Theme.of(context).textTheme.bodySmall?.copyWith(
                      color: _muted.withValues(alpha: 0.65),
                      fontWeight: FontWeight.w700,
                    ),
                  ),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }
}

class _TopHeader extends StatelessWidget {
  const _TopHeader();

  static const _green = AppColors.brandGreenDeep;

  @override
  Widget build(BuildContext context) {
    return Row(
      children: [
        Container(
          height: 34,
          width: 34,
          decoration: BoxDecoration(
            color: AppColors.surface(context).withValues(alpha: 0.92),
            shape: BoxShape.circle,
            boxShadow: [
              BoxShadow(
                blurRadius: 14,
                offset: const Offset(0, 8),
                color: AppColors.overlay(context, 0.08),
              ),
            ],
          ),
          child: const Icon(Icons.location_on_rounded, color: _green, size: 20),
        ),
        const SizedBox(width: 10),
        Text(
          "HomeStead",
          style: Theme.of(context).textTheme.titleMedium?.copyWith(
            fontWeight: FontWeight.w900,
            letterSpacing: 0.2,
          ),
        ),
      ],
    );
  }
}

class _ProfileCard extends StatelessWidget {
  const _ProfileCard();

  static const _inactive = AppColors.textMutedLight;

  @override
  Widget build(BuildContext context) {
    return _FrostCard(
      child: Padding(
        padding: const EdgeInsets.all(14),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              "Michael Johnson",
              style: Theme.of(context).textTheme.titleMedium?.copyWith(
                fontWeight: FontWeight.w900,
                color: AppColors.navy,
              ),
            ),
            const SizedBox(height: 4),
            Text(
              "michael.j@email.com",
              style: Theme.of(context).textTheme.bodyMedium?.copyWith(
                color: _inactive.withValues(alpha: 0.85),
                fontWeight: FontWeight.w700,
              ),
            ),
            const SizedBox(height: 10),
            Align(
              alignment: Alignment.centerLeft,
              child: _OutlinePillButton(text: "View Profile  ›", onTap: () {}),
            ),
          ],
        ),
      ),
    );
  }
}

class _MenuTile extends StatelessWidget {
  const _MenuTile({
    required this.icon,
    required this.iconBg,
    required this.iconFg,
    required this.title,
    required this.onTap,
    this.subtitle,
  });

  final IconData icon;
  final Color iconBg;
  final Color iconFg;
  final String title;
  final String? subtitle;
  final VoidCallback onTap;

  @override
  Widget build(BuildContext context) {
    return _FrostCard(
      child: InkWell(
        onTap: onTap,
        borderRadius: BorderRadius.circular(18),
        child: Padding(
          padding: const EdgeInsets.fromLTRB(14, 12, 12, 12),
          child: Row(
            children: [
              _IconChip(icon: icon, bg: iconBg, fg: iconFg),
              const SizedBox(width: 12),
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      title,
                      style: Theme.of(context).textTheme.titleMedium?.copyWith(
                        fontWeight: FontWeight.w900,
                        color: AppColors.navy,
                      ),
                    ),
                    if (subtitle != null) ...[
                      const SizedBox(height: 2),
                      Text(
                        subtitle!,
                        style: Theme.of(context).textTheme.bodySmall?.copyWith(
                          fontWeight: FontWeight.w700,
                          color: const Color(
                            0xFF6F7785,
                          ).withValues(alpha: 0.85),
                        ),
                      ),
                    ],
                  ],
                ),
              ),
              Icon(
                Icons.chevron_right_rounded,
                color: AppColors.textMutedLight.withValues(alpha: 0.75),
              ),
            ],
          ),
        ),
      ),
    );
  }
}

class _IconChip extends StatelessWidget {
  const _IconChip({required this.icon, required this.bg, required this.fg});
  final IconData icon;
  final Color bg;
  final Color fg;

  @override
  Widget build(BuildContext context) {
    return Container(
      height: 36,
      width: 48,
      alignment: Alignment.center,
      decoration: BoxDecoration(
        color: bg.withValues(alpha: 0.65),
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: AppColors.overlay(context, 0.05)),
      ),
      child: Icon(icon, color: fg, size: 20),
    );
  }
}

class _OutlinePillButton extends StatelessWidget {
  const _OutlinePillButton({required this.text, required this.onTap});
  final String text;
  final VoidCallback onTap;

  @override
  Widget build(BuildContext context) {
    return Material(
      color: AppColors.surface(context).withValues(alpha: 0.55),
      borderRadius: BorderRadius.circular(14),
      child: InkWell(
        onTap: onTap,
        borderRadius: BorderRadius.circular(14),
        child: Padding(
          padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
          child: Text(
            text,
            style: Theme.of(context).textTheme.bodySmall?.copyWith(
              fontWeight: FontWeight.w900,
              color: AppColors.navy,
            ),
          ),
        ),
      ),
    );
  }
}

class _FrostCard extends StatelessWidget {
  const _FrostCard({required this.child});
  final Widget child;

  @override
  Widget build(BuildContext context) {
    return Material(
      color: AppColors.surface(context).withValues(alpha: 0.62),
      borderRadius: BorderRadius.circular(18),
      child: Container(
        decoration: BoxDecoration(
          borderRadius: BorderRadius.circular(18),
          border: Border.all(
            color: AppColors.surface(context).withValues(alpha: 0.55),
          ),
          boxShadow: [
            BoxShadow(
              blurRadius: 18,
              offset: const Offset(0, 10),
              color: AppColors.overlay(context, 0.08),
            ),
          ],
        ),
        child: child,
      ),
    );
  }
}


// ===== FILE: lib/features/tenant/payments/payment_detail_screen.dart =====

import 'package:flutter/material.dart';
import '../../../core/constants/status_badge_map.dart';
import '../../../core/theme/app_spacing.dart';
import '../../../core/ui/scaffold/app_scaffold.dart';
import '../../../core/ui/scaffold/app_top_bar.dart';
import '../../../shared/services/toast_service.dart';
import '../../../shared/widgets/primary_button.dart';
import '../../../shared/widgets/status_badge.dart';
import 'payment_methods/bank_transfer_screen.dart';
import 'payment_methods/card_payment_screen.dart';
import 'payment_methods/wallet_payment_screen.dart';
import 'receipt/receipt_screen.dart';

class PaymentDetailScreen extends StatelessWidget {
  const PaymentDetailScreen({
    super.key,
    required this.paymentId,
    required this.status,
  });

  final String paymentId;
  final String status;

  @override
  Widget build(BuildContext context) {
    final s = status.toLowerCase();

    return AppScaffold(
      topBar: const AppTopBar(
        title: 'Payment Detail',
        subtitle: 'Breakdown & actions',
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            'Payment #$paymentId',
            style: Theme.of(
              context,
            ).textTheme.titleLarge?.copyWith(fontWeight: FontWeight.w900),
          ),
          const SizedBox(height: AppSpacing.sm),
          StatusBadge(domain: StatusDomain.payment, status: status),
          const SizedBox(height: AppSpacing.lg),

          const Text(
            'Breakdown (demo)\n• Amount: NGN 250,000\n• Purpose: Deposit\n• Ref: 10113-2481-2026',
          ),
          const SizedBox(height: AppSpacing.lg),

          if (s == 'successful') ...[
            PrimaryButton(
              label: 'View receipt',
              onPressed: () {
                Navigator.of(context).push(
                  MaterialPageRoute(builder: (_) => const ReceiptScreen()),
                );
              },
            ),
          ] else if (s == 'failed') ...[
            PrimaryButton(
              label: 'Retry payment',
              onPressed: () => ToastService.show(
                context,
                'Choose payment method',
                success: true,
              ),
            ),
            const SizedBox(height: AppSpacing.md),
            _MethodRow(
              onCard: () => Navigator.of(context).push(
                MaterialPageRoute(builder: (_) => const CardPaymentScreen()),
              ),
              onWallet: () => Navigator.of(context).push(
                MaterialPageRoute(builder: (_) => const WalletPaymentScreen()),
              ),
              onBank: () => Navigator.of(context).push(
                MaterialPageRoute(builder: (_) => const BankTransferScreen()),
              ),
            ),
          ] else ...[
            PrimaryButton(
              label: 'Continue payment',
              onPressed: () => ToastService.show(
                context,
                'Choose payment method',
                success: true,
              ),
            ),
            const SizedBox(height: AppSpacing.md),
            _MethodRow(
              onCard: () => Navigator.of(context).push(
                MaterialPageRoute(builder: (_) => const CardPaymentScreen()),
              ),
              onWallet: () => Navigator.of(context).push(
                MaterialPageRoute(builder: (_) => const WalletPaymentScreen()),
              ),
              onBank: () => Navigator.of(context).push(
                MaterialPageRoute(builder: (_) => const BankTransferScreen()),
              ),
            ),
          ],
        ],
      ),
    );
  }
}

class _MethodRow extends StatelessWidget {
  const _MethodRow({
    required this.onCard,
    required this.onWallet,
    required this.onBank,
  });
  final VoidCallback onCard;
  final VoidCallback onWallet;
  final VoidCallback onBank;

  @override
  Widget build(BuildContext context) {
    return Column(
      children: [
        OutlinedButton.icon(
          onPressed: onCard,
          icon: const Icon(Icons.credit_card_rounded),
          label: const Text('Card'),
        ),
        const SizedBox(height: 10),
        OutlinedButton.icon(
          onPressed: onWallet,
          icon: const Icon(Icons.account_balance_wallet_rounded),
          label: const Text('Wallet'),
        ),
        const SizedBox(height: 10),
        OutlinedButton.icon(
          onPressed: onBank,
          icon: const Icon(Icons.account_balance_rounded),
          label: const Text('Bank Transfer'),
        ),
      ],
    );
  }
}


// ===== FILE: lib/features/tenant/payments/payment_methods/bank_transfer_screen.dart =====

import 'package:flutter/material.dart';
import '../../../../core/theme/app_spacing.dart';
import '../../../../core/ui/scaffold/app_scaffold.dart';
import '../../../../core/ui/scaffold/app_top_bar.dart';
import '../../../../shared/services/toast_service.dart';
import '../../../../shared/widgets/primary_button.dart';

class BankTransferScreen extends StatelessWidget {
  const BankTransferScreen({super.key});

  @override
  Widget build(BuildContext context) {
    return AppScaffold(
      topBar: const AppTopBar(
        title: 'Bank Transfer',
        subtitle: 'Pay using bank transfer',
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          const Text(
            'Bank: RentEase Demo Bank\nAccount: 1234567890\nReference: PAY-10113-2481',
          ),
          const SizedBox(height: AppSpacing.lg),
          PrimaryButton(
            label: "I've paid",
            onPressed: () => ToastService.show(
              context,
              'Marked as paid (pending verification)',
              success: true,
            ),
          ),
        ],
      ),
    );
  }
}


// ===== FILE: lib/features/tenant/payments/payment_methods/card_payment_screen.dart =====

import 'package:flutter/material.dart';
import '../../../../core/theme/app_spacing.dart';
import '../../../../core/ui/scaffold/app_scaffold.dart';
import '../../../../core/ui/scaffold/app_top_bar.dart';
import '../../../../shared/services/toast_service.dart';
import '../../../../shared/widgets/primary_button.dart';

class CardPaymentScreen extends StatelessWidget {
  const CardPaymentScreen({super.key});

  @override
  Widget build(BuildContext context) {
    return AppScaffold(
      topBar: const AppTopBar(
        title: 'Card Payment',
        subtitle: 'Secure card checkout',
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          const Text('MVP UI only — wire tokenized checkout (Paystack/Squad).'),
          const SizedBox(height: AppSpacing.lg),
          PrimaryButton(
            label: 'Pay now',
            onPressed: () => ToastService.show(
              context,
              'Processing... (demo)',
              success: true,
            ),
          ),
        ],
      ),
    );
  }
}


// ===== FILE: lib/features/tenant/payments/payment_methods/wallet_payment_screen.dart =====

import 'package:flutter/material.dart';
import '../../../../core/theme/app_spacing.dart';
import '../../../../core/ui/scaffold/app_scaffold.dart';
import '../../../../core/ui/scaffold/app_top_bar.dart';
import '../../../../shared/services/toast_service.dart';
import '../../../../shared/widgets/primary_button.dart';

class WalletPaymentScreen extends StatelessWidget {
  const WalletPaymentScreen({super.key});

  @override
  Widget build(BuildContext context) {
    return AppScaffold(
      topBar: const AppTopBar(
        title: 'Wallet Payment',
        subtitle: 'Use available balance',
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          const Text('Wallet balance: NGN 80,000 (demo)'),
          const SizedBox(height: AppSpacing.lg),
          PrimaryButton(
            label: 'Confirm payment',
            onPressed: () => ToastService.show(
              context,
              'Insufficient balance (demo)',
              success: false,
            ),
          ),
        ],
      ),
    );
  }
}


// ===== FILE: lib/features/tenant/payments/payments_screen.dart =====

import 'package:flutter/material.dart';
import '../../../core/theme/app_spacing.dart';
import '../../../core/ui/scaffold/app_scaffold.dart';
import '../../../core/ui/scaffold/app_top_bar.dart';
import '../../../core/ui/states/empty_state.dart';
import '../../../shared/widgets/card_widgets/payment_card.dart';
import 'payment_detail_screen.dart';

class PaymentsScreen extends StatefulWidget {
  const PaymentsScreen({super.key});

  @override
  State<PaymentsScreen> createState() => _PaymentsScreenState();
}

class _PaymentsScreenState extends State<PaymentsScreen> {
  String _tab = 'All';

  final _items = const [
    _PayRow(
      id: 'p1',
      purpose: 'Rent Payment',
      amount: 'NGN 1,200,000',
      date: 'Jan 12, 2026',
      status: 'successful',
    ),
    _PayRow(
      id: 'p2',
      purpose: 'Deposit',
      amount: 'NGN 250,000',
      date: 'Jan 11, 2026',
      status: 'pending',
    ),
    _PayRow(
      id: 'p3',
      purpose: 'Rent Payment',
      amount: 'NGN 1,200,000',
      date: 'Dec 10, 2025',
      status: 'failed',
    ),
  ];

  List<_PayRow> get _filtered {
    if (_tab == 'All') {
      return _items;
    }
    return _items.where((x) => x.status == _tab.toLowerCase()).toList();
  }

  @override
  Widget build(BuildContext context) {
    final items = _filtered;

    return AppScaffold(
      topBar: const AppTopBar(
        title: 'Payments',
        subtitle: 'History & receipts',
      ),
      child: Column(
        children: [
          SingleChildScrollView(
            scrollDirection: Axis.horizontal,
            child: Row(
              children: [
                _TabChip(
                  label: 'All',
                  active: _tab == 'All',
                  onTap: () => setState(() => _tab = 'All'),
                ),
                _TabChip(
                  label: 'pending',
                  active: _tab == 'pending',
                  onTap: () => setState(() => _tab = 'pending'),
                ),
                _TabChip(
                  label: 'successful',
                  active: _tab == 'successful',
                  onTap: () => setState(() => _tab = 'successful'),
                ),
                _TabChip(
                  label: 'failed',
                  active: _tab == 'failed',
                  onTap: () => setState(() => _tab = 'failed'),
                ),
              ],
            ),
          ),
          const SizedBox(height: AppSpacing.md),
          Expanded(
            child: items.isEmpty
                ? const EmptyState(
                    title: 'No payments yet',
                    message: 'Your payment history will appear here.',
                  )
                : ListView.separated(
                    padding: const EdgeInsets.only(bottom: AppSpacing.xl),
                    itemCount: items.length,
                    separatorBuilder: (_, i) =>
                        const SizedBox(height: AppSpacing.md),
                    itemBuilder: (_, i) {
                      final x = items[i];
                      return PaymentCard(
                        purposeText: x.purpose,
                        amountText: x.amount,
                        dateText: x.date,
                        status: x.status,
                        onTap: () {
                          Navigator.of(context).push(
                            MaterialPageRoute(
                              builder: (_) => PaymentDetailScreen(
                                paymentId: x.id,
                                status: x.status,
                              ),
                            ),
                          );
                        },
                        primaryActionText: x.status == 'failed'
                            ? 'Retry'
                            : 'View',
                        onPrimaryAction: () {
                          Navigator.of(context).push(
                            MaterialPageRoute(
                              builder: (_) => PaymentDetailScreen(
                                paymentId: x.id,
                                status: x.status,
                              ),
                            ),
                          );
                        },
                      );
                    },
                  ),
          ),
        ],
      ),
    );
  }
}

class _TabChip extends StatelessWidget {
  const _TabChip({
    required this.label,
    required this.active,
    required this.onTap,
  });
  final String label;
  final bool active;
  final VoidCallback onTap;

  @override
  Widget build(BuildContext context) {
    return Padding(
      padding: const EdgeInsets.only(right: 10),
      child: ChoiceChip(
        selected: active,
        label: Text(label),
        onSelected: (_) => onTap(),
      ),
    );
  }
}

class _PayRow {
  const _PayRow({
    required this.id,
    required this.purpose,
    required this.amount,
    required this.date,
    required this.status,
  });
  final String id;
  final String purpose;
  final String amount;
  final String date;
  final String status;
}


// ===== FILE: lib/features/tenant/payments/receipt/receipt_screen.dart =====

import 'package:flutter/material.dart';
import '../../../../core/theme/app_spacing.dart';
import '../../../../core/ui/scaffold/app_scaffold.dart';
import '../../../../core/ui/scaffold/app_top_bar.dart';

class ReceiptScreen extends StatelessWidget {
  const ReceiptScreen({super.key});

  @override
  Widget build(BuildContext context) {
    return AppScaffold(
      topBar: const AppTopBar(title: 'Receipt', subtitle: 'Download / share'),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            'Receipt (demo)',
            style: Theme.of(
              context,
            ).textTheme.titleLarge?.copyWith(fontWeight: FontWeight.w900),
          ),
          const SizedBox(height: AppSpacing.md),
          const Text(
            '• Amount: NGN 250,000\n• Purpose: Deposit\n• Status: successful\n• Ref: 10113-2481-2026',
          ),
          const SizedBox(height: AppSpacing.lg),
          Row(
            children: [
              Expanded(
                child: OutlinedButton.icon(
                  onPressed: () {},
                  icon: const Icon(Icons.download_rounded),
                  label: const Text('Download'),
                ),
              ),
              const SizedBox(width: AppSpacing.md),
              Expanded(
                child: OutlinedButton.icon(
                  onPressed: () {},
                  icon: const Icon(Icons.share_rounded),
                  label: const Text('Share'),
                ),
              ),
            ],
          ),
        ],
      ),
    );
  }
}


// ===== FILE: lib/features/tenant/profile/documents/document_detail_screen.dart =====

import 'package:flutter/material.dart';
import '../../../../core/constants/status_badge_map.dart';
import '../../../../core/theme/app_spacing.dart';
import '../../../../core/ui/scaffold/app_scaffold.dart';
import '../../../../core/ui/scaffold/app_top_bar.dart';
import '../../../../shared/widgets/status_badge.dart';
import 'upload_document_screen.dart';

class DocumentDetailScreen extends StatelessWidget {
  const DocumentDetailScreen({
    super.key,
    required this.docId,
    required this.type,
    required this.status,
  });

  final String docId;
  final String type;
  final String status;

  @override
  Widget build(BuildContext context) {
    return AppScaffold(
      topBar: const AppTopBar(
        title: 'Document Detail',
        subtitle: 'Preview & status',
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            type,
            style: Theme.of(
              context,
            ).textTheme.titleLarge?.copyWith(fontWeight: FontWeight.w900),
          ),
          const SizedBox(height: AppSpacing.sm),
          StatusBadge(domain: StatusDomain.verified, status: status),
          const SizedBox(height: AppSpacing.lg),
          Container(
            height: 220,
            width: double.infinity,
            decoration: BoxDecoration(
              borderRadius: BorderRadius.circular(18),
              color: Theme.of(context).colorScheme.surfaceContainerHighest,
            ),
            child: const Center(child: Text('Preview (image/pdf)')),
          ),
          const SizedBox(height: AppSpacing.lg),
          OutlinedButton.icon(
            onPressed: () => Navigator.of(context).push(
              MaterialPageRoute(builder: (_) => const UploadDocumentScreen()),
            ),
            icon: const Icon(Icons.refresh_rounded),
            label: const Text('Resubmit'),
          ),
        ],
      ),
    );
  }
}


// ===== FILE: lib/features/tenant/profile/documents/documents_list_screen.dart =====

import 'package:flutter/material.dart';
import '../../../../core/constants/status_badge_map.dart';
import '../../../../core/theme/app_spacing.dart';
import '../../../../core/ui/scaffold/app_scaffold.dart';
import '../../../../core/ui/scaffold/app_top_bar.dart';
import '../../../../core/ui/states/empty_state.dart';
import '../../../../shared/widgets/status_badge.dart';
import 'document_detail_screen.dart';
import 'upload_document_screen.dart';

class DocumentsListScreen extends StatelessWidget {
  const DocumentsListScreen({super.key});

  @override
  Widget build(BuildContext context) {
    const docs = [
      _DocRow(
        id: 'd1',
        type: 'ID Card',
        status: 'pending',
        date: 'Jan 15, 2026',
      ),
      _DocRow(
        id: 'd2',
        type: 'Utility Bill',
        status: 'verified',
        date: 'Dec 28, 2025',
      ),
    ];

    return AppScaffold(
      topBar: AppTopBar(
        title: 'Documents',
        subtitle: 'Upload & track review',
        actions: [
          IconButton(
            onPressed: () => Navigator.of(context).push(
              MaterialPageRoute(builder: (_) => const UploadDocumentScreen()),
            ),
            icon: const Icon(Icons.upload_file_rounded),
          ),
        ],
      ),
      child: docs.isEmpty
          ? const EmptyState(
              title: 'No documents',
              message: 'Upload your first document to begin verification.',
            )
          : ListView.separated(
              padding: const EdgeInsets.only(bottom: AppSpacing.xl),
              itemCount: docs.length,
              separatorBuilder: (_, i) => const SizedBox(height: AppSpacing.md),
              itemBuilder: (_, i) {
                final d = docs[i];
                return ListTile(
                  contentPadding: EdgeInsets.zero,
                  leading: const CircleAvatar(
                    child: Icon(Icons.description_rounded),
                  ),
                  title: Text(
                    d.type,
                    style: Theme.of(context).textTheme.titleSmall?.copyWith(
                      fontWeight: FontWeight.w900,
                    ),
                  ),
                  subtitle: Text('Uploaded: ${d.date}'),
                  trailing: StatusBadge(
                    domain: StatusDomain.verified,
                    status: d.status,
                    compact: true,
                  ),
                  onTap: () => Navigator.of(context).push(
                    MaterialPageRoute(
                      builder: (_) => DocumentDetailScreen(
                        docId: d.id,
                        type: d.type,
                        status: d.status,
                      ),
                    ),
                  ),
                );
              },
            ),
    );
  }
}

class _DocRow {
  const _DocRow({
    required this.id,
    required this.type,
    required this.status,
    required this.date,
  });
  final String id;
  final String type;
  final String status;
  final String date;
}


// ===== FILE: lib/features/tenant/profile/documents/upload_document_screen.dart =====

import 'package:flutter/material.dart';
import '../../../../core/theme/app_spacing.dart';
import '../../../../core/ui/scaffold/app_scaffold.dart';
import '../../../../core/ui/scaffold/app_top_bar.dart';
import '../../../../shared/services/toast_service.dart';
import '../../../../shared/widgets/primary_button.dart';

class UploadDocumentScreen extends StatefulWidget {
  const UploadDocumentScreen({super.key});

  @override
  State<UploadDocumentScreen> createState() => _UploadDocumentScreenState();
}

class _UploadDocumentScreenState extends State<UploadDocumentScreen> {
  String _type = 'ID Card';

  void _upload() {
    ToastService.show(context, 'Uploaded (demo)', success: true);
    Navigator.of(context).pop(true);
  }

  @override
  Widget build(BuildContext context) {
    return AppScaffold(
      topBar: const AppTopBar(
        title: 'Upload Document',
        subtitle: 'KYC / verification',
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text('Document type', style: Theme.of(context).textTheme.labelLarge),
          const SizedBox(height: AppSpacing.xs),
          DropdownButtonFormField<String>(
            // ignore: deprecated_member_use
            value: _type,
            items: const [
              DropdownMenuItem(value: 'ID Card', child: Text('ID Card')),
              DropdownMenuItem(value: 'Passport', child: Text('Passport')),
              DropdownMenuItem(
                value: 'Utility Bill',
                child: Text('Utility Bill'),
              ),
            ],
            onChanged: (v) => setState(() => _type = v ?? 'ID Card'),
          ),
          const SizedBox(height: AppSpacing.lg),
          OutlinedButton.icon(
            onPressed: () =>
                ToastService.show(context, 'Pick file (demo)', success: true),
            icon: const Icon(Icons.attach_file_rounded),
            label: const Text('Choose file'),
          ),
          const SizedBox(height: AppSpacing.lg),
          PrimaryButton(label: 'Upload', onPressed: _upload),
        ],
      ),
    );
  }
}


// ===== FILE: lib/features/tenant/profile/edit_profile_screen.dart =====

import 'package:flutter/material.dart';
import '../../../core/theme/app_spacing.dart';
import '../../../core/ui/scaffold/app_scaffold.dart';
import '../../../core/ui/scaffold/app_top_bar.dart';
import '../../../core/utils/validators.dart';
import '../../../shared/services/toast_service.dart';
import '../../../shared/widgets/form_field.dart';
import '../../../shared/widgets/primary_button.dart';

class EditProfileScreen extends StatefulWidget {
  const EditProfileScreen({super.key});

  @override
  State<EditProfileScreen> createState() => _EditProfileScreenState();
}

class _EditProfileScreenState extends State<EditProfileScreen> {
  final _formKey = GlobalKey<FormState>();
  final _name = TextEditingController(text: 'Treco Philippe');
  final _phone = TextEditingController(text: '+234...');
  final _email = TextEditingController(text: 'you@example.com');

  @override
  void dispose() {
    _name.dispose();
    _phone.dispose();
    _email.dispose();
    super.dispose();
  }

  void _save() {
    FocusScope.of(context).unfocus();
    if (!(_formKey.currentState?.validate() ?? false)) return;
    ToastService.show(context, 'Profile updated (demo)', success: true);
    Navigator.of(context).pop();
  }

  @override
  Widget build(BuildContext context) {
    return AppScaffold(
      topBar: const AppTopBar(
        title: 'Edit Profile',
        subtitle: 'Update your details',
      ),
      child: Form(
        key: _formKey,
        child: Column(
          children: [
            AppFormField(
              controller: _name,
              label: 'Full name',
              validator: (v) => Validators.requiredField(v),
              prefixIcon: Icons.person_rounded,
            ),
            const SizedBox(height: AppSpacing.lg),
            AppFormField(
              controller: _phone,
              label: 'Phone',
              validator: (v) => Validators.requiredField(v),
              prefixIcon: Icons.phone_rounded,
              keyboardType: TextInputType.phone,
            ),
            const SizedBox(height: AppSpacing.lg),
            AppFormField(
              controller: _email,
              label: 'Email',
              validator: (v) => Validators.requiredField(v),
              prefixIcon: Icons.alternate_email_rounded,
              keyboardType: TextInputType.emailAddress,
            ),
            const SizedBox(height: AppSpacing.lg),
            PrimaryButton(label: 'Save changes', onPressed: _save),
          ],
        ),
      ),
    );
  }
}


// ===== FILE: lib/features/tenant/profile/profile_screen.dart =====

import 'package:flutter/material.dart';
import '../../../core/theme/app_spacing.dart';
import '../../../core/ui/scaffold/app_scaffold.dart';
import '../../../core/ui/scaffold/app_top_bar.dart';
import '../../../shared/services/dialog_service.dart';
import '../../../shared/services/toast_service.dart';
import '../../../shared/widgets/primary_button.dart';
import 'documents/documents_list_screen.dart';
import 'edit_profile_screen.dart';
import 'settings_screen.dart';
import 'verification_screen.dart';

class ProfileScreen extends StatelessWidget {
  const ProfileScreen({super.key});

  @override
  Widget build(BuildContext context) {
    return AppScaffold(
      topBar: const AppTopBar(title: 'Profile', subtitle: 'Account & settings'),
      child: Column(
        children: [
          Row(
            children: [
              const CircleAvatar(radius: 28, child: Icon(Icons.person_rounded)),
              const SizedBox(width: AppSpacing.md),
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      'Treco Philippe',
                      style: Theme.of(context).textTheme.titleMedium?.copyWith(
                        fontWeight: FontWeight.w900,
                      ),
                    ),
                    const SizedBox(height: 2),
                    Text(
                      'you@example.com',
                      style: Theme.of(context).textTheme.bodyMedium,
                    ),
                  ],
                ),
              ),
            ],
          ),
          const SizedBox(height: AppSpacing.lg),

          _Tile(
            icon: Icons.edit_rounded,
            title: 'Edit Profile',
            onTap: () => Navigator.of(context).push(
              MaterialPageRoute(builder: (_) => const EditProfileScreen()),
            ),
          ),
          _Tile(
            icon: Icons.settings_rounded,
            title: 'Settings',
            onTap: () => Navigator.of(
              context,
            ).push(MaterialPageRoute(builder: (_) => const SettingsScreen())),
          ),
          _Tile(
            icon: Icons.verified_user_rounded,
            title: 'Verification',
            onTap: () => Navigator.of(context).push(
              MaterialPageRoute(builder: (_) => const VerificationScreen()),
            ),
          ),
          _Tile(
            icon: Icons.folder_rounded,
            title: 'Documents',
            onTap: () => Navigator.of(context).push(
              MaterialPageRoute(builder: (_) => const DocumentsListScreen()),
            ),
          ),

          const SizedBox(height: AppSpacing.lg),
          PrimaryButton(
            label: 'Logout',
            onPressed: () async {
              final ok = await DialogService.confirm(
                context,
                title: 'Logout?',
                message: 'You will need to login again.',
                confirmText: 'Logout',
                danger: true,
              );
              if (ok && context.mounted) {
                ToastService.show(context, 'Logged out (demo)', success: true);
              }
            },
          ),
        ],
      ),
    );
  }
}

class _Tile extends StatelessWidget {
  const _Tile({required this.icon, required this.title, required this.onTap});
  final IconData icon;
  final String title;
  final VoidCallback onTap;

  @override
  Widget build(BuildContext context) {
    return Padding(
      padding: const EdgeInsets.only(bottom: AppSpacing.md),
      child: ListTile(
        onTap: onTap,
        contentPadding: EdgeInsets.zero,
        leading: CircleAvatar(child: Icon(icon)),
        title: Text(
          title,
          style: Theme.of(
            context,
          ).textTheme.titleSmall?.copyWith(fontWeight: FontWeight.w900),
        ),
        trailing: const Icon(Icons.chevron_right_rounded),
      ),
    );
  }
}


// ===== FILE: lib/features/tenant/profile/settings_screen.dart =====

// ignore_for_file: deprecated_member_use
import 'package:flutter/material.dart';
import '../../../core/theme/app_spacing.dart';
import '../../../core/ui/scaffold/app_scaffold.dart';
import '../../../core/ui/scaffold/app_top_bar.dart';
import '../../../shared/services/toast_service.dart';

import '../../../core/theme/app_colors.dart';

class SettingsScreen extends StatefulWidget {
  const SettingsScreen({super.key});

  @override
  State<SettingsScreen> createState() => _SettingsScreenState();
}

class _SettingsScreenState extends State<SettingsScreen> {
  // NOTE: local-only (wire to persistence later)
  ThemeMode _appearance = ThemeMode.system;
  String _language = 'English';
  String _currency = 'NGN';
  bool _allowLocation = true;
  String _defaultCity = 'Lagos';

  // Notifications
  bool _push = true;
  bool _email = false;
  bool _sms = false;

  // Privacy & Security
  bool _biometric = true;

  // Data & Storage
  bool _wifiOnly = true;

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    final muted = theme.textTheme.bodySmall?.color?.withValues(alpha: 0.70);

    return AppScaffold(
      topBar: const AppTopBar(
        title: 'Settings',
        subtitle: 'Manage preferences and privacy',
      ),
      child: SingleChildScrollView(
        padding: const EdgeInsets.only(bottom: AppSpacing.lg),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            _SectionTitle('Preferences'),
            _GroupCard(
              children: [
                _NavTile(
                  icon: Icons.brightness_6_rounded,
                  title: 'App Appearance',
                  trailingText: _appearanceLabel(_appearance),
                  onTap: () => _openAppearancePicker(context),
                ),
                _DividerLine(),
                _NavTile(
                  icon: Icons.language_rounded,
                  title: 'Language',
                  trailingText: _language,
                  onTap: () => _openPicker(
                    context,
                    title: 'Language',
                    current: _language,
                    options: const ['English', 'Yoruba', 'Igbo', 'Hausa'],
                    onPick: (v) => setState(() => _language = v),
                  ),
                ),
                _DividerLine(),
                _NavTile(
                  icon: Icons.payments_rounded,
                  title: 'Currency',
                  trailingText: _currency,
                  onTap: () => _openPicker(
                    context,
                    title: 'Currency',
                    current: _currency,
                    options: const ['NGN', 'USD'],
                    onPick: (v) => setState(() => _currency = v),
                  ),
                ),
                _DividerLine(),
                _NavTile(
                  icon: Icons.location_on_rounded,
                  title: 'Location Settings',
                  onTap: () => Navigator.of(context).push(
                    MaterialPageRoute(
                      builder: (_) => LocationSettingsScreen(
                        allowLocation: _allowLocation,
                        defaultCity: _defaultCity,
                        onChanged: (allow, city) {
                          setState(() {
                            _allowLocation = allow;
                            _defaultCity = city;
                          });
                        },
                      ),
                    ),
                  ),
                ),
              ],
            ),
            const SizedBox(height: AppSpacing.lg),

            _SectionTitle('Notifications'),
            _GroupCard(
              children: [
                _NavTile(
                  icon: Icons.notifications_active_rounded,
                  title: 'Notification Preferences',
                  onTap: () => Navigator.of(context).push(
                    MaterialPageRoute(
                      builder: (_) => NotificationPreferencesScreen(
                        push: _push,
                        email: _email,
                        sms: _sms,
                        onChanged: (p, e, s) {
                          setState(() {
                            _push = p;
                            _email = e;
                            _sms = s;
                          });
                        },
                      ),
                    ),
                  ),
                ),
              ],
            ),
            const SizedBox(height: AppSpacing.lg),

            _SectionTitle('Privacy & Security'),
            _GroupCard(
              children: [
                _NavTile(
                  icon: Icons.lock_rounded,
                  title: 'Change Password',
                  onTap: () => ToastService.show(
                    context,
                    'Change password (wire later)',
                    success: true,
                  ),
                ),
                _DividerLine(),
                _SwitchTile(
                  icon: Icons.fingerprint_rounded,
                  title: 'Use Biometric Lock',
                  value: _biometric,
                  onChanged: (v) => setState(() => _biometric = v),
                ),
                _DividerLine(),
                _NavTile(
                  icon: Icons.devices_rounded,
                  title: 'Login Devices',
                  onTap: () => ToastService.show(
                    context,
                    'Login devices / sessions (wire later)',
                    success: true,
                  ),
                ),
                _DividerLine(),
                _NavTile(
                  icon: Icons.verified_user_rounded,
                  title: '2FA',
                  trailingText: 'Later',
                  onTap: () => ToastService.show(
                    context,
                    '2FA (Phase 2)',
                    success: true,
                  ),
                ),
              ],
            ),
            const SizedBox(height: AppSpacing.lg),

            _SectionTitle('Data & Storage'),
            _GroupCard(
              children: [
                _NavTile(
                  icon: Icons.cleaning_services_rounded,
                  title: 'Clear Cache',
                  onTap: () => _confirm(
                    context,
                    title: 'Clear cache?',
                    message:
                        'This will remove temporary files and cached data.',
                    confirmText: 'Clear',
                    isDanger: false,
                    onConfirm: () => ToastService.show(
                      context,
                      'Cache cleared (demo)',
                      success: true,
                    ),
                  ),
                ),
                _DividerLine(),
                _SwitchTile(
                  icon: Icons.wifi_rounded,
                  title: 'Wi-Fi Only Downloads',
                  value: _wifiOnly,
                  onChanged: (v) => setState(() => _wifiOnly = v),
                ),
                _DividerLine(),
                _NavTile(
                  icon: Icons.delete_sweep_rounded,
                  title: 'Delete Downloaded Documents',
                  onTap: () => _confirm(
                    context,
                    title: 'Delete downloads?',
                    message: 'This removes downloaded files from this device.',
                    confirmText: 'Delete',
                    isDanger: true,
                    onConfirm: () => ToastService.show(
                      context,
                      'Downloads deleted (demo)',
                      success: true,
                    ),
                  ),
                ),
              ],
            ),
            const SizedBox(height: AppSpacing.lg),

            _SectionTitle('About'),
            _GroupCard(
              children: [
                _InfoTile(
                  icon: Icons.info_outline_rounded,
                  title: 'App Version',
                  value: 'HomeStead v1.0.0',
                ),
                _DividerLine(),
                _NavTile(
                  icon: Icons.star_rate_rounded,
                  title: 'Rate HomeStead',
                  onTap: () => ToastService.show(
                    context,
                    'Open store rating (wire later)',
                    success: true,
                  ),
                ),
                _DividerLine(),
                _NavTile(
                  icon: Icons.description_rounded,
                  title: 'Terms',
                  onTap: () => ToastService.show(
                    context,
                    'Open Terms (wire later)',
                    success: true,
                  ),
                ),
                _DividerLine(),
                _NavTile(
                  icon: Icons.privacy_tip_rounded,
                  title: 'Privacy Policy',
                  onTap: () => ToastService.show(
                    context,
                    'Open Privacy Policy (wire later)',
                    success: true,
                  ),
                ),
              ],
            ),
            const SizedBox(height: AppSpacing.lg),

            _SectionTitle('Danger zone'),
            _GroupCard(
              danger: true,
              children: [
                _NavTile(
                  icon: Icons.delete_forever_rounded,
                  iconColor: Colors.redAccent,
                  title: 'Delete Account',
                  titleColor: Colors.redAccent,
                  onTap: () => _confirm(
                    context,
                    title: 'Delete account?',
                    message:
                        'This action is permanent. Your account and data may be removed.',
                    confirmText: 'Delete',
                    isDanger: true,
                    onConfirm: () => ToastService.show(
                      context,
                      'Account deleted (demo)',
                      success: true,
                    ),
                  ),
                ),
              ],
            ),
            const SizedBox(height: AppSpacing.lg),
            Text(
              'Some settings are demo-only (wire to backend/local storage later).',
              style: theme.textTheme.bodySmall?.copyWith(color: muted),
            ),
            const SizedBox(height: AppSpacing.lg),
          ],
        ),
      ),
    );
  }

  String _appearanceLabel(ThemeMode m) {
    switch (m) {
      case ThemeMode.light:
        return 'Light';
      case ThemeMode.dark:
        return 'Dark';
      case ThemeMode.system:
        return 'System';
    }
  }

  Future<void> _openAppearancePicker(BuildContext context) async {
    final picked = await showModalBottomSheet<ThemeMode>(
      context: context,
      showDragHandle: true,
      builder: (_) => _PickerSheet<ThemeMode>(
        title: 'App Appearance',
        current: _appearance,
        options: const [
          _PickOption(value: ThemeMode.system, label: 'System'),
          _PickOption(value: ThemeMode.light, label: 'Light'),
          _PickOption(value: ThemeMode.dark, label: 'Dark'),
        ],
      ),
    );
    if (picked != null) setState(() => _appearance = picked);
  }

  Future<void> _openPicker(
    BuildContext context, {
    required String title,
    required String current,
    required List<String> options,
    required ValueChanged<String> onPick,
  }) async {
    final picked = await showModalBottomSheet<String>(
      context: context,
      showDragHandle: true,
      builder: (_) => _PickerSheet<String>(
        title: title,
        current: current,
        options: options
            .map((x) => _PickOption<String>(value: x, label: x))
            .toList(),
      ),
    );
    if (picked != null) onPick(picked);
  }

  void _confirm(
    BuildContext context, {
    required String title,
    required String message,
    required String confirmText,
    required bool isDanger,
    required VoidCallback onConfirm,
  }) {
    showDialog(
      context: context,
      builder: (_) => AlertDialog(
        title: Text(title),
        content: Text(message),
        actions: [
          TextButton(
            onPressed: () => Navigator.of(context).pop(),
            child: const Text('Cancel'),
          ),
          FilledButton(
            onPressed: () {
              Navigator.of(context).pop();
              onConfirm();
            },
            style: isDanger
                ? FilledButton.styleFrom(backgroundColor: Colors.redAccent)
                : null,
            child: Text(confirmText),
          ),
        ],
      ),
    );
  }
}

/* ---------------- Sub Screens ---------------- */

class NotificationPreferencesScreen extends StatefulWidget {
  const NotificationPreferencesScreen({
    super.key,
    required this.push,
    required this.email,
    required this.sms,
    required this.onChanged,
  });

  final bool push;
  final bool email;
  final bool sms;
  final void Function(bool push, bool email, bool sms) onChanged;

  @override
  State<NotificationPreferencesScreen> createState() =>
      _NotificationPreferencesScreenState();
}

class _NotificationPreferencesScreenState
    extends State<NotificationPreferencesScreen> {
  late bool _push = widget.push;
  late bool _email = widget.email;
  late bool _sms = widget.sms;

  @override
  Widget build(BuildContext context) {
    return AppScaffold(
      topBar: const AppTopBar(
        title: 'Notification Preferences',
        subtitle: 'Choose how you want to be notified',
      ),
      child: Column(
        children: [
          _SectionTitle('Channels'),
          _GroupCard(
            children: [
              _SwitchTile(
                icon: Icons.notifications_active_rounded,
                title: 'Push Notifications',
                value: _push,
                onChanged: (v) {
                  setState(() => _push = v);
                  widget.onChanged(_push, _email, _sms);
                },
              ),
              _DividerLine(),
              _SwitchTile(
                icon: Icons.email_rounded,
                title: 'Email Notifications',
                value: _email,
                onChanged: (v) {
                  setState(() => _email = v);
                  widget.onChanged(_push, _email, _sms);
                },
              ),
              _DividerLine(),
              _SwitchTile(
                icon: Icons.sms_rounded,
                title: 'SMS Notifications',
                value: _sms,
                onChanged: (v) {
                  setState(() => _sms = v);
                  widget.onChanged(_push, _email, _sms);
                },
              ),
            ],
          ),
          const SizedBox(height: AppSpacing.lg),
          _SectionTitle('Tip'),
          _GroupCard(
            children: const [
              Padding(
                padding: EdgeInsets.all(AppSpacing.md),
                child: Text(
                  'Push is best for instant alerts (payments, approvals, viewings). Email/SMS can be used as backup.',
                ),
              ),
            ],
          ),
        ],
      ),
    );
  }
}

class LocationSettingsScreen extends StatefulWidget {
  const LocationSettingsScreen({
    super.key,
    required this.allowLocation,
    required this.defaultCity,
    required this.onChanged,
  });

  final bool allowLocation;
  final String defaultCity;
  final void Function(bool allowLocation, String defaultCity) onChanged;

  @override
  State<LocationSettingsScreen> createState() => _LocationSettingsScreenState();
}

class _LocationSettingsScreenState extends State<LocationSettingsScreen> {
  late bool _allow = widget.allowLocation;
  late String _city = widget.defaultCity;

  @override
  Widget build(BuildContext context) {
    return AppScaffold(
      topBar: const AppTopBar(
        title: 'Location Settings',
        subtitle: 'Control location usage and default city',
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          _SectionTitle('Location'),
          _GroupCard(
            children: [
              _SwitchTile(
                icon: Icons.location_on_rounded,
                title: 'Allow Location',
                value: _allow,
                onChanged: (v) {
                  setState(() => _allow = v);
                  widget.onChanged(_allow, _city);
                },
              ),
              _DividerLine(),
              Padding(
                padding: const EdgeInsets.all(AppSpacing.md),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      'Default City',
                      style: Theme.of(context).textTheme.bodySmall?.copyWith(
                        fontWeight: FontWeight.w900,
                      ),
                    ),
                    const SizedBox(height: AppSpacing.sm),

                    DropdownButtonFormField<String>(
                      value: _city,
                      items: const [
                        DropdownMenuItem(value: 'Lagos', child: Text('Lagos')),
                        DropdownMenuItem(value: 'Abuja', child: Text('Abuja')),
                        DropdownMenuItem(
                          value: 'Port Harcourt',
                          child: Text('Port Harcourt'),
                        ),
                        DropdownMenuItem(
                          value: 'Ibadan',
                          child: Text('Ibadan'),
                        ),
                      ],
                      onChanged: (v) {
                        setState(() => _city = v ?? 'Lagos');
                        widget.onChanged(_allow, _city);
                      },
                      decoration: const InputDecoration(
                        border: OutlineInputBorder(),
                        isDense: true,
                      ),
                    ),
                  ],
                ),
              ),
            ],
          ),
          const SizedBox(height: AppSpacing.lg),
          _SectionTitle('Note'),
          _GroupCard(
            children: const [
              Padding(
                padding: EdgeInsets.all(AppSpacing.md),
                child: Text(
                  'We use location to improve search results and show nearby listings. You can turn it off anytime.',
                ),
              ),
            ],
          ),
        ],
      ),
    );
  }
}

/* ---------------- UI Components ---------------- */

class _SectionTitle extends StatelessWidget {
  const _SectionTitle(this.text);
  final String text;

  @override
  Widget build(BuildContext context) {
    final t = Theme.of(context);
    return Padding(
      padding: const EdgeInsets.only(bottom: 10),
      child: Text(
        text,
        style: t.textTheme.titleSmall?.copyWith(
          fontWeight: FontWeight.w900,
          letterSpacing: 0.2,
        ),
      ),
    );
  }
}

class _GroupCard extends StatelessWidget {
  const _GroupCard({required this.children, this.danger = false});
  final List<Widget> children;
  final bool danger;

  @override
  Widget build(BuildContext context) {
    final theme = Theme.of(context);
    final bg = theme.colorScheme.surfaceContainerHighest.withValues(
      alpha: 0.55,
    );

    return Container(
      width: double.infinity,
      decoration: BoxDecoration(
        color: bg,
        borderRadius: BorderRadius.circular(18),
        border: Border.all(
          color: (danger ? Colors.redAccent : Colors.black).withValues(
            alpha: 0.08,
          ),
        ),
      ),
      child: Column(children: children),
    );
  }
}

class _DividerLine extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Divider(
      height: 1,
      thickness: 1,
      color: AppColors.overlay(context, 0.06),
    );
  }
}

class _NavTile extends StatelessWidget {
  const _NavTile({
    required this.icon,
    required this.title,
    required this.onTap,
    this.trailingText,
    this.iconColor,
    this.titleColor,
  });

  final IconData icon;
  final String title;
  final VoidCallback onTap;
  final String? trailingText;
  final Color? iconColor;
  final Color? titleColor;

  @override
  Widget build(BuildContext context) {
    final t = Theme.of(context);
    final muted = t.textTheme.bodySmall?.color?.withValues(alpha: 0.70);

    return InkWell(
      onTap: onTap,
      child: Padding(
        padding: const EdgeInsets.symmetric(
          horizontal: AppSpacing.md,
          vertical: 12,
        ),
        child: Row(
          children: [
            Icon(icon, size: 20, color: iconColor ?? muted),
            const SizedBox(width: 12),
            Expanded(
              child: Text(
                title,
                style: t.textTheme.bodyLarge?.copyWith(
                  fontWeight: FontWeight.w800,
                  color: titleColor,
                ),
              ),
            ),
            if (trailingText != null) ...[
              Text(
                trailingText!,
                style: t.textTheme.bodyMedium?.copyWith(
                  color: muted,
                  fontWeight: FontWeight.w800,
                ),
              ),
              const SizedBox(width: 6),
            ],
            Icon(Icons.chevron_right_rounded, color: muted),
          ],
        ),
      ),
    );
  }
}

class _SwitchTile extends StatelessWidget {
  const _SwitchTile({
    required this.icon,
    required this.title,
    required this.value,
    required this.onChanged,
  });

  final IconData icon;
  final String title;
  final bool value;
  final ValueChanged<bool> onChanged;

  @override
  Widget build(BuildContext context) {
    final t = Theme.of(context);
    final muted = t.textTheme.bodySmall?.color?.withValues(alpha: 0.70);

    return Padding(
      padding: const EdgeInsets.symmetric(
        horizontal: AppSpacing.md,
        vertical: 10,
      ),
      child: Row(
        children: [
          Icon(icon, size: 20, color: muted),
          const SizedBox(width: 12),
          Expanded(
            child: Text(
              title,
              style: t.textTheme.bodyLarge?.copyWith(
                fontWeight: FontWeight.w800,
              ),
            ),
          ),
          Switch(value: value, onChanged: onChanged),
        ],
      ),
    );
  }
}

class _InfoTile extends StatelessWidget {
  const _InfoTile({
    required this.icon,
    required this.title,
    required this.value,
  });

  final IconData icon;
  final String title;
  final String value;

  @override
  Widget build(BuildContext context) {
    final t = Theme.of(context);
    final muted = t.textTheme.bodySmall?.color?.withValues(alpha: 0.70);

    return Padding(
      padding: const EdgeInsets.symmetric(
        horizontal: AppSpacing.md,
        vertical: 12,
      ),
      child: Row(
        children: [
          Icon(icon, size: 20, color: muted),
          const SizedBox(width: 12),
          Expanded(
            child: Text(
              title,
              style: t.textTheme.bodyLarge?.copyWith(
                fontWeight: FontWeight.w800,
              ),
            ),
          ),
          Text(
            value,
            style: t.textTheme.bodyMedium?.copyWith(
              color: muted,
              fontWeight: FontWeight.w800,
            ),
          ),
        ],
      ),
    );
  }
}

/* ------------- Bottom sheet picker ------------- */

class _PickOption<T> {
  const _PickOption({required this.value, required this.label});
  final T value;
  final String label;
}

class _PickerSheet<T> extends StatelessWidget {
  const _PickerSheet({
    required this.title,
    required this.current,
    required this.options,
  });

  final String title;
  final T current;
  final List<_PickOption<T>> options;

  @override
  Widget build(BuildContext context) {
    final t = Theme.of(context);

    return SafeArea(
      child: Padding(
        padding: const EdgeInsets.fromLTRB(14, 10, 14, 18),
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            Text(
              title,
              style: t.textTheme.titleMedium?.copyWith(
                fontWeight: FontWeight.w900,
              ),
            ),
            const SizedBox(height: 12),
            ...options.map((o) {
              final selected = o.value == current;
              return ListTile(
                title: Text(
                  o.label,
                  style: t.textTheme.bodyLarge?.copyWith(
                    fontWeight: selected ? FontWeight.w900 : FontWeight.w700,
                  ),
                ),
                trailing: selected
                    ? const Icon(Icons.check_rounded)
                    : const SizedBox.shrink(),
                onTap: () => Navigator.of(context).pop(o.value),
              );
            }),
          ],
        ),
      ),
    );
  }
}


// ===== FILE: lib/features/tenant/profile/verification_screen.dart =====

import 'package:flutter/material.dart';
import '../../../core/constants/status_badge_map.dart';
import '../../../core/theme/app_spacing.dart';
import '../../../core/ui/scaffold/app_scaffold.dart';
import '../../../core/ui/scaffold/app_top_bar.dart';
import '../../../shared/services/toast_service.dart';
import '../../../shared/widgets/primary_button.dart';
import '../../../shared/widgets/status_badge.dart';
import 'documents/upload_document_screen.dart';

class VerificationScreen extends StatelessWidget {
  const VerificationScreen({super.key});

  @override
  Widget build(BuildContext context) {
    const status = 'pending';

    return AppScaffold(
      topBar: const AppTopBar(title: 'Verification', subtitle: 'KYC status'),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text('Status', style: Theme.of(context).textTheme.labelLarge),
          const SizedBox(height: AppSpacing.sm),
          const StatusBadge(domain: StatusDomain.verified, status: status),
          const SizedBox(height: AppSpacing.lg),
          const Text('Upload your ID or documents to complete verification.'),
          const SizedBox(height: AppSpacing.lg),
          PrimaryButton(
            label: 'Upload document',
            onPressed: () => Navigator.of(context).push(
              MaterialPageRoute(builder: (_) => const UploadDocumentScreen()),
            ),
          ),
          const SizedBox(height: AppSpacing.md),
          OutlinedButton.icon(
            onPressed: () =>
                ToastService.show(context, 'Support (demo)', success: true),
            icon: const Icon(Icons.support_agent_rounded),
            label: const Text('Contact support'),
          ),
        ],
      ),
    );
  }
}


// ===== FILE: lib/features/tenant/renting_tools/renting_tools_screen.dart =====

import 'package:flutter/material.dart';

import '../tenancies/tenancies_screen.dart';
import '../viewings/viewings_screen.dart';

import '../../../core/ui/scaffold/app_scaffold.dart';

import '../../../core/theme/app_colors.dart';

class RentingToolsScreen extends StatefulWidget {
  const RentingToolsScreen({super.key});

  @override
  State<RentingToolsScreen> createState() => _RentingToolsScreenState();
}

class _RentingToolsScreenState extends State<RentingToolsScreen> {
  static const _bgTop = AppColors.lightBg;
  static const _bgBottom = AppColors.mist;
  static const _muted = AppColors.textMutedLight;
  static const _blue = AppColors.brandBlueSoft;
  static const _green = AppColors.brandGreenDeep;

  final PageController _pc = PageController(viewportFraction: 0.92);
  int _idx = 0;

  final _tenancies = const [
    _TenancyCardData(
      title: 'Lekki Phase 1 • Unit 3B',
      dueText: 'Due May 1',
      amount: 50000,
    ),
    _TenancyCardData(
      title: 'Marina Garden • Unit A9',
      dueText: 'Due May 3',
      amount: 120000,
    ),
    _TenancyCardData(
      title: 'Ikoyi Villa • Room 5C',
      dueText: 'Due May 10',
      amount: 220000,
    ),
  ];

  String _fmtNaira(int v) {
    final s = v.toString();
    final buf = StringBuffer();
    for (int i = 0; i < s.length; i++) {
      final idxFromEnd = s.length - i;
      buf.write(s[i]);
      if (idxFromEnd > 1 && idxFromEnd % 3 == 1) buf.write(',');
    }
    return '₦$buf';
  }

  @override
  void dispose() {
    _pc.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final activeCount = _tenancies.length;

    return DecoratedBox(
      decoration: const BoxDecoration(
        gradient: LinearGradient(
          begin: Alignment.topCenter,
          end: Alignment.bottomCenter,
          colors: [_bgTop, _bgBottom],
        ),
      ),
      child: SafeArea(
        bottom: false,
        child: AppScaffold(
          child: ListView(
            padding: const EdgeInsets.fromLTRB(14, 8, 14, 110),
            children: [
              _TopBar(
                title: 'Renting Tools',
                onBack: () => Navigator.of(context).maybePop(),
              ),
              const SizedBox(height: 10),
              Text(
                'Active Tenancies ($activeCount)',
                style: Theme.of(context).textTheme.titleMedium?.copyWith(
                  fontWeight: FontWeight.w900,
                  color: AppColors.navy,
                ),
              ),
              const SizedBox(height: 10),

              SizedBox(
                height: 210,
                child: PageView.builder(
                  controller: _pc,
                  onPageChanged: (i) => setState(() => _idx = i),
                  itemCount: _tenancies.length,
                  itemBuilder: (_, i) {
                    final t = _tenancies[i];
                    return Padding(
                      padding: const EdgeInsets.only(right: 10),
                      child: _FrostCard(
                        child: Padding(
                          padding: const EdgeInsets.all(12),
                          child: Row(
                            children: [
                              ClipRRect(
                                borderRadius: BorderRadius.circular(16),
                                child: Container(
                                  width: 110,
                                  height: double.infinity,
                                  color: const Color(
                                    0xFFCFDBEA,
                                  ).withValues(alpha: 0.80),
                                  child: const Icon(
                                    Icons.home_rounded,
                                    size: 34,
                                    color: AppColors.brandBlueSoft,
                                  ),
                                ),
                              ),
                              const SizedBox(width: 12),
                              Expanded(
                                child: Column(
                                  mainAxisSize: MainAxisSize.max,
                                  mainAxisAlignment:
                                      MainAxisAlignment.spaceBetween,
                                  crossAxisAlignment: CrossAxisAlignment.start,
                                  children: [
                                    Column(
                                      crossAxisAlignment:
                                          CrossAxisAlignment.start,
                                      children: [
                                        Text(
                                          t.title,
                                          maxLines: 2,
                                          overflow: TextOverflow.ellipsis,
                                          style: Theme.of(context)
                                              .textTheme
                                              .titleSmall
                                              ?.copyWith(
                                                fontWeight: FontWeight.w900,
                                                color: AppColors.navy,
                                              ),
                                        ),
                                        const SizedBox(height: 8),
                                        Row(
                                          children: [
                                            const Icon(
                                              Icons.event_rounded,
                                              size: 16,
                                              color: Color(0xFFB24A5A),
                                            ),
                                            const SizedBox(width: 6),
                                            Expanded(
                                              child: Text(
                                                t.dueText,
                                                maxLines: 1,
                                                overflow: TextOverflow.ellipsis,
                                                style: Theme.of(context)
                                                    .textTheme
                                                    .bodyMedium
                                                    ?.copyWith(
                                                      fontWeight:
                                                          FontWeight.w900,
                                                      color: const Color(
                                                        0xFF1E2A3A,
                                                      ),
                                                    ),
                                              ),
                                            ),
                                          ],
                                        ),
                                      ],
                                    ),
                                    Column(
                                      children: [
                                        Row(
                                          children: [
                                            Expanded(
                                              child: _PillButton(
                                                text: 'View  ›',
                                                color: _blue,
                                                onTap: () {
                                                  Navigator.of(context).push(
                                                    MaterialPageRoute(
                                                      builder: (_) =>
                                                          TenanciesScreen(),
                                                    ),
                                                  );
                                                },
                                              ),
                                            ),
                                            const SizedBox(width: 10),
                                            Expanded(
                                              child: _PillButton(
                                                text:
                                                    'Pay ${_fmtNaira(t.amount)}',
                                                color: _green,
                                                onTap: () {
                                                  ScaffoldMessenger.of(
                                                    context,
                                                  ).showSnackBar(
                                                    const SnackBar(
                                                      content: Text(
                                                        'Pay flow will be wired from Tenancies screen',
                                                      ),
                                                    ),
                                                  );
                                                },
                                              ),
                                            ),
                                          ],
                                        ),
                                        const SizedBox(height: 10),
                                        Align(
                                          alignment: Alignment.centerRight,
                                          child: Text(
                                            '${_idx + 1}/${_tenancies.length}',
                                            style: Theme.of(context)
                                                .textTheme
                                                .bodySmall
                                                ?.copyWith(
                                                  fontWeight: FontWeight.w800,
                                                  color: _muted.withValues(
                                                    alpha: 0.80,
                                                  ),
                                                ),
                                          ),
                                        ),
                                      ],
                                    ),
                                  ],
                                ),
                              ),
                            ],
                          ),
                        ),
                      ),
                    );
                  },
                ),
              ),

              const SizedBox(height: 18),
              Text(
                'Quick Actions',
                style: Theme.of(context).textTheme.titleMedium?.copyWith(
                  fontWeight: FontWeight.w900,
                  color: AppColors.navy,
                ),
              ),
              const SizedBox(height: 10),
              _FrostCard(
                child: Column(
                  children: [
                    _TileRow(
                      icon: Icons.event_available_rounded,
                      title: 'My Viewings',
                      subtitle: 'Appointments and visits',
                      onTap: () {
                        Navigator.of(context).push(
                          MaterialPageRoute(
                            builder: (_) => const ViewingsScreen(),
                          ),
                        );
                      },
                    ),
                    const Divider(height: 1),
                    _TileRow(
                      icon: Icons.home_work_rounded,
                      title: 'My Tenancies',
                      subtitle: 'Active & past tenancies',
                      onTap: () {
                        Navigator.of(context).push(
                          MaterialPageRoute(builder: (_) => TenanciesScreen()),
                        );
                      },
                    ),
                  ],
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}

class _TopBar extends StatelessWidget {
  const _TopBar({required this.title, required this.onBack});
  final String title;
  final VoidCallback onBack;

  @override
  Widget build(BuildContext context) {
    return Row(
      children: [
        Material(
          color: AppColors.surface(context).withValues(alpha: 0.70),
          borderRadius: BorderRadius.circular(14),
          child: InkWell(
            borderRadius: BorderRadius.circular(14),
            onTap: onBack,
            child: const Padding(
              padding: EdgeInsets.all(10),
              child: Icon(Icons.arrow_back_rounded),
            ),
          ),
        ),
        const SizedBox(width: 12),
        Expanded(
          child: Text(
            title,
            style: Theme.of(context).textTheme.titleLarge?.copyWith(
              fontWeight: FontWeight.w900,
              color: AppColors.navy,
            ),
          ),
        ),
      ],
    );
  }
}

class _TileRow extends StatelessWidget {
  const _TileRow({
    required this.icon,
    required this.title,
    required this.subtitle,
    required this.onTap,
  });
  final IconData icon;
  final String title;
  final String subtitle;
  final VoidCallback onTap;

  @override
  Widget build(BuildContext context) {
    return Material(
      color: Colors.transparent,
      child: InkWell(
        onTap: onTap,
        child: Padding(
          padding: const EdgeInsets.fromLTRB(12, 12, 12, 12),
          child: Row(
            children: [
              Container(
                width: 40,
                height: 40,
                decoration: BoxDecoration(
                  color: AppColors.surface(context).withValues(alpha: 0.85),
                  borderRadius: BorderRadius.circular(14),
                ),
                child: Icon(icon, color: AppColors.brandBlueSoft),
              ),
              const SizedBox(width: 10),
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      title,
                      style: Theme.of(context).textTheme.titleSmall?.copyWith(
                        fontWeight: FontWeight.w900,
                        color: AppColors.navy,
                      ),
                    ),
                    const SizedBox(height: 2),
                    Text(
                      subtitle,
                      style: Theme.of(context).textTheme.bodySmall?.copyWith(
                        fontWeight: FontWeight.w700,
                        color: AppColors.textMutedLight,
                      ),
                    ),
                  ],
                ),
              ),
              const Icon(Icons.chevron_right_rounded),
            ],
          ),
        ),
      ),
    );
  }
}

class _PillButton extends StatelessWidget {
  const _PillButton({
    required this.text,
    required this.onTap,
    required this.color,
  });
  final String text;
  final VoidCallback onTap;
  final Color color;

  @override
  Widget build(BuildContext context) {
    return Material(
      color: color.withValues(alpha: 0.85),
      borderRadius: BorderRadius.circular(14),
      child: InkWell(
        borderRadius: BorderRadius.circular(14),
        onTap: onTap,
        child: Padding(
          padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 10),
          child: Center(
            child: Text(
              text,
              maxLines: 1,
              overflow: TextOverflow.ellipsis,
              style: const TextStyle(
                color: Colors.white,
                fontWeight: FontWeight.w900,
              ),
            ),
          ),
        ),
      ),
    );
  }
}

class _FrostCard extends StatelessWidget {
  const _FrostCard({required this.child});
  final Widget child;

  @override
  Widget build(BuildContext context) {
    return Material(
      color: AppColors.surface(context).withValues(alpha: 0.68),
      borderRadius: BorderRadius.circular(18),
      child: Container(
        decoration: BoxDecoration(
          borderRadius: BorderRadius.circular(18),
          border: Border.all(color: AppColors.overlay(context, 0.05)),
          boxShadow: [
            BoxShadow(
              blurRadius: 18,
              offset: const Offset(0, 10),
              color: AppColors.overlay(context, 0.08),
            ),
          ],
        ),
        child: ClipRRect(borderRadius: BorderRadius.circular(18), child: child),
      ),
    );
  }
}

class _TenancyCardData {
  const _TenancyCardData({
    required this.title,
    required this.dueText,
    required this.amount,
  });
  final String title;
  final String dueText;
  final int amount;
}


// ===== FILE: lib/features/tenant/saved/saved_screen.dart =====

import 'package:flutter/material.dart';
import '../../../core/ui/scaffold/app_scaffold.dart';

class SavedScreen extends StatelessWidget {
  const SavedScreen({super.key});

  @override
  Widget build(BuildContext context) {
    return const AppScaffold(child: Center(child: Text('Saved (placeholder)')));
  }
}


// ===== FILE: lib/features/tenant/search/search_screen.dart =====

import 'package:flutter/material.dart';

import '../../../core/theme/app_colors.dart';
import '../../../core/theme/app_radii.dart';
import '../../../core/theme/app_shadows.dart';
import '../../../core/theme/app_spacing.dart';
import '../../../core/ui/scaffold/app_scaffold.dart';
import '../../../core/ui/scaffold/app_top_bar.dart';

class SearchScreen extends StatefulWidget {
  const SearchScreen({super.key});

  @override
  State<SearchScreen> createState() => _SearchScreenState();
}

class _SearchScreenState extends State<SearchScreen> {
  RangeValues _price = const RangeValues(20_000_000, 500_000_000);
  int _propertyTab = 0; // 0 residential, 1 commercial, 2 land
  bool _buy = true;

  String _fmtNaira(num v) {
    final s = v.toInt().toString();
    final buf = StringBuffer();
    for (int i = 0; i < s.length; i++) {
      final idxFromEnd = s.length - i;
      buf.write(s[i]);
      if (idxFromEnd > 1 && idxFromEnd % 3 == 1) buf.write(',');
    }
    return '₦$buf';
  }

  @override
  Widget build(BuildContext context) {
    final cs = Theme.of(context).colorScheme;
    const bottomPad = 140.0;

    return AppScaffold(
      backgroundColor: Colors.transparent,
      safeAreaTop: true,
      safeAreaBottom: false,
      appBar: AppTopBar(
        title: 'HomeStead',
        leading: Padding(
          padding: const EdgeInsets.only(left: AppSpacing.screenH),
          child: _CircleIcon(
            bg: AppColors.surface(context).withValues(alpha: 0.92),
            fg: AppColors.brandGreenDeep,
            icon: Icons.eco_rounded,
          ),
        ),
        actions: [
          Padding(
            padding: const EdgeInsets.only(right: AppSpacing.screenH),
            child: InkWell(
              onTap: () {},
              borderRadius: BorderRadius.circular(999),
              child: _CircleIcon(
                bg: AppColors.surface(context).withValues(alpha: 0.92),
                fg: AppColors.textMuted(context),
                icon: Icons.person_rounded,
                border: AppColors.overlay(context, 0.08),
              ),
            ),
          ),
        ],
      ),
      scroll: true,
      padding: const EdgeInsets.fromLTRB(
        AppSpacing.screenH,
        AppSpacing.sm,
        AppSpacing.screenH,
        bottomPad,
      ),
      child: DecoratedBox(
        decoration: BoxDecoration(
          gradient: AppColors.pageBgGradient(context),
        ),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            const SizedBox(height: AppSpacing.sm),
            _SearchBar(onTap: () {}),
            const SizedBox(height: AppSpacing.md),

            Row(
              children: [
                Expanded(
                  child: _PillButton(
                    icon: Icons.filter_alt_rounded,
                    text: 'Advanced Filters',
                    onTap: () {},
                    filled: true,
                  ),
                ),
                const SizedBox(width: AppSpacing.sm),
                TextButton(
                  onPressed: () {
                    setState(() {
                      _price = const RangeValues(20_000_000, 500_000_000);
                      _propertyTab = 0;
                      _buy = true;
                    });
                  },
                  child: const Text('Reset All  ›'),
                ),
              ],
            ),

            const SizedBox(height: AppSpacing.sm),

            Text(
              '${_fmtNaira(_price.start)}                                ${_fmtNaira(_price.end)}',
              style: Theme.of(context).textTheme.titleSmall?.copyWith(
                    fontWeight: FontWeight.w900,
                    color: AppColors.textPrimary(context),
                  ),
            ),
            const SizedBox(height: AppSpacing.xs),
            RangeSlider(
              values: _price,
              min: 20_000_000,
              max: 1_000_000_000,
              divisions: 40,
              onChanged: (v) => setState(() => _price = v),
            ),
            Text(
              '${_fmtNaira(20_000_000)}  -  ${_fmtNaira(1_000_000_000)}',
              style: Theme.of(context).textTheme.bodySmall?.copyWith(
                    color: cs.onSurface.withValues(alpha: 0.65),
                    fontWeight: FontWeight.w700,
                  ),
            ),

            const SizedBox(height: AppSpacing.lg),

            Row(
              children: [
                Expanded(
                  child: _Segment(
                    label: 'Residential',
                    active: _propertyTab == 0,
                    onTap: () => setState(() => _propertyTab = 0),
                  ),
                ),
                const SizedBox(width: AppSpacing.sm),
                Expanded(
                  child: _Segment(
                    label: 'Commercial',
                    active: _propertyTab == 1,
                    onTap: () => setState(() => _propertyTab = 1),
                  ),
                ),
                const SizedBox(width: AppSpacing.sm),
                Expanded(
                  child: _Segment(
                    label: 'Land',
                    active: _propertyTab == 2,
                    onTap: () => setState(() => _propertyTab = 2),
                  ),
                ),
              ],
            ),

            const SizedBox(height: AppSpacing.md),

            Row(
              children: [
                Text(
                  'Buy',
                  style: Theme.of(context).textTheme.titleMedium?.copyWith(
                        color: AppColors.brandGreenDeep,
                        fontWeight: FontWeight.w900,
                      ),
                ),
                const Spacer(),
                Text(
                  'Rent',
                  style: Theme.of(context).textTheme.titleMedium?.copyWith(
                        color: AppColors.brandGreenDeep,
                        fontWeight: FontWeight.w900,
                      ),
                ),
              ],
            ),
            const SizedBox(height: AppSpacing.sm),

            _BuyRentToggle(
              buy: _buy,
              onChanged: (v) => setState(() => _buy = v),
            ),

            const SizedBox(height: AppSpacing.sm),

            const Row(
              children: [
                Expanded(child: _MiniDrop(text: 'Min Beds  ›')),
                SizedBox(width: AppSpacing.sm),
                Expanded(child: _MiniDrop(text: 'Min Baths')),
              ],
            ),
            const SizedBox(height: AppSpacing.sm),
            const _MiniDrop(text: 'Min Plot Size (sqft)'),

            const SizedBox(height: AppSpacing.md),

            _MapPreview(
              onMapTap: () {},
            ),

            const SizedBox(height: AppSpacing.lg),

            Center(
              child: SizedBox(
                width: 280,
                height: 56,
                child: ElevatedButton(
                  onPressed: () => Navigator.of(context).maybePop(),
                  style: ElevatedButton.styleFrom(
                    backgroundColor: AppColors.brandGreenDeep,
                    foregroundColor: Colors.white,
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(AppRadii.card),
                    ),
                    elevation: 10,
                    shadowColor: AppColors.overlay(context, 0.20),
                  ),
                  child: const Text(
                    'Apply Filters',
                    style: TextStyle(
                      fontWeight: FontWeight.w900,
                      fontSize: 18,
                    ),
                  ),
                ),
              ),
            ),
          ],
        ),
      ),
    );
  }
}

class _CircleIcon extends StatelessWidget {
  const _CircleIcon({
    required this.bg,
    required this.fg,
    required this.icon,
    this.border,
  });

  final Color bg;
  final Color fg;
  final IconData icon;
  final Color? border;

  @override
  Widget build(BuildContext context) {
    return Container(
      height: 42,
      width: 42,
      decoration: BoxDecoration(
        color: bg,
        shape: BoxShape.circle,
        border: border == null ? null : Border.all(color: border!),
        boxShadow: [
          BoxShadow(
            blurRadius: 14,
            offset: const Offset(0, 8),
            color: AppColors.overlay(context, 0.08),
          ),
        ],
      ),
      child: Icon(icon, color: fg),
    );
  }
}

class _SearchBar extends StatelessWidget {
  const _SearchBar({required this.onTap});
  final VoidCallback onTap;

  @override
  Widget build(BuildContext context) {
    final muted = AppColors.textMuted(context);

    return InkWell(
      onTap: onTap,
      borderRadius: BorderRadius.circular(AppRadii.button),
      child: Container(
        height: 52,
        padding: const EdgeInsets.symmetric(horizontal: AppSpacing.screenH),
        decoration: BoxDecoration(
          color: AppColors.surface(context).withValues(alpha: 0.85),
          borderRadius: BorderRadius.circular(AppRadii.button),
          border: Border.all(color: AppColors.overlay(context, 0.06)),
          boxShadow: AppShadows.lift(context, blur: 18, y: 10, alpha: 0.08),
        ),
        child: Row(
          children: [
            Icon(Icons.search_rounded, color: muted),
            const SizedBox(width: AppSpacing.sm),
            Expanded(
              child: Text(
                'Search location, price, or city...',
                style: Theme.of(context).textTheme.bodyMedium?.copyWith(
                      color: muted,
                      fontWeight: FontWeight.w700,
                    ),
              ),
            ),
            const Icon(
              Icons.chevron_right_rounded,
              color: AppColors.brandGreenDeep,
            ),
          ],
        ),
      ),
    );
  }
}

class _PillButton extends StatelessWidget {
  const _PillButton({
    required this.icon,
    required this.text,
    required this.onTap,
    required this.filled,
  });

  final IconData icon;
  final String text;
  final VoidCallback onTap;
  final bool filled;

  @override
  Widget build(BuildContext context) {
    final fg = filled ? Colors.white : AppColors.brandGreenDeep;
    final bg = filled
        ? AppColors.brandGreenDeep.withValues(alpha: 0.88)
        : AppColors.surface(context).withValues(alpha: 0.78);

    return InkWell(
      onTap: onTap,
      borderRadius: BorderRadius.circular(AppRadii.button),
      child: Container(
        height: 44,
        padding: const EdgeInsets.symmetric(horizontal: AppSpacing.screenH),
        decoration: BoxDecoration(
          color: bg,
          borderRadius: BorderRadius.circular(AppRadii.button),
          border: Border.all(color: AppColors.overlay(context, 0.06)),
          boxShadow: [
            BoxShadow(
              blurRadius: 14,
              offset: const Offset(0, 8),
              color: AppColors.overlay(context, 0.08),
            ),
          ],
        ),
        child: Row(
          mainAxisSize: MainAxisSize.min,
          children: [
            Icon(icon, color: fg),
            const SizedBox(width: AppSpacing.sm),
            Text(
              text,
              style: TextStyle(
                color: filled ? Colors.white : AppColors.textPrimary(context),
                fontWeight: FontWeight.w900,
              ),
            ),
          ],
        ),
      ),
    );
  }
}

class _Segment extends StatelessWidget {
  const _Segment({
    required this.label,
    required this.active,
    required this.onTap,
  });

  final String label;
  final bool active;
  final VoidCallback onTap;

  @override
  Widget build(BuildContext context) {
    final activeBg = AppColors.brandBlueSoft.withValues(alpha: 0.92);
    final inactiveBg = AppColors.surface(context).withValues(alpha: 0.75);

    return InkWell(
      onTap: onTap,
      borderRadius: BorderRadius.circular(AppRadii.button),
      child: Container(
        height: 46,
        alignment: Alignment.center,
        decoration: BoxDecoration(
          color: active ? activeBg : inactiveBg,
          borderRadius: BorderRadius.circular(AppRadii.button),
          border: Border.all(color: AppColors.overlay(context, 0.06)),
        ),
        child: Text(
          label,
          style: TextStyle(
            color: active ? Colors.white : AppColors.textPrimary(context),
            fontWeight: FontWeight.w900,
          ),
        ),
      ),
    );
  }
}

class _BuyRentToggle extends StatelessWidget {
  const _BuyRentToggle({required this.buy, required this.onChanged});

  final bool buy;
  final ValueChanged<bool> onChanged;

  @override
  Widget build(BuildContext context) {
    return Container(
      height: 52,
      decoration: BoxDecoration(
        color: AppColors.surface(context).withValues(alpha: 0.75),
        borderRadius: BorderRadius.circular(AppRadii.button),
        border: Border.all(color: AppColors.overlay(context, 0.06)),
      ),
      child: Row(
        children: [
          Expanded(
            child: InkWell(
              onTap: () => onChanged(true),
              borderRadius: BorderRadius.circular(AppRadii.button),
              child: Container(
                alignment: Alignment.center,
                decoration: BoxDecoration(
                  color: buy ? AppColors.brandGreenDeep : Colors.transparent,
                  borderRadius: BorderRadius.circular(AppRadii.button),
                ),
                child: Text(
                  'Buy',
                  style: TextStyle(
                    color: buy ? Colors.white : AppColors.textMuted(context),
                    fontWeight: FontWeight.w900,
                    fontSize: 16,
                  ),
                ),
              ),
            ),
          ),
          Expanded(
            child: InkWell(
              onTap: () => onChanged(false),
              borderRadius: BorderRadius.circular(AppRadii.button),
              child: Container(
                alignment: Alignment.center,
                decoration: BoxDecoration(
                  color: !buy ? AppColors.brandGreenDeep : Colors.transparent,
                  borderRadius: BorderRadius.circular(AppRadii.button),
                ),
                child: Text(
                  'Rent',
                  style: TextStyle(
                    color: !buy ? Colors.white : AppColors.textMuted(context),
                    fontWeight: FontWeight.w900,
                    fontSize: 16,
                  ),
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }
}

class _MiniDrop extends StatelessWidget {
  const _MiniDrop({required this.text});
  final String text;

  @override
  Widget build(BuildContext context) {
    final muted = AppColors.textMuted(context);

    return Container(
      height: 48,
      padding: const EdgeInsets.symmetric(horizontal: AppSpacing.screenH),
      decoration: BoxDecoration(
        color: AppColors.surface(context).withValues(alpha: 0.75),
        borderRadius: BorderRadius.circular(AppRadii.button),
        border: Border.all(color: AppColors.overlay(context, 0.06)),
      ),
      child: Row(
        children: [
          Expanded(
            child: Text(
              text,
              style: Theme.of(context).textTheme.bodyMedium?.copyWith(
                    fontWeight: FontWeight.w800,
                    color: muted,
                  ),
            ),
          ),
          Icon(
            Icons.keyboard_arrow_down_rounded,
            color: muted,
          ),
        ],
      ),
    );
  }
}

class _MapPreview extends StatelessWidget {
  const _MapPreview({required this.onMapTap});
  final VoidCallback onMapTap;

  @override
  Widget build(BuildContext context) {
    final cs = Theme.of(context).colorScheme;

    final mapBg = AppColors.isDark(context)
        ? AppColors.surface2(context).withValues(alpha: 0.55)
        : AppColors.brandBlueSoft.withValues(alpha: 0.10);

    return Stack(
      children: [
        Container(
          height: 180,
          width: double.infinity,
          decoration: BoxDecoration(
            color: mapBg,
            borderRadius: BorderRadius.circular(AppRadii.card),
            border: Border.all(
              color: AppColors.overlay(context, 0.06),
            ),
          ),
          child: Center(
            child: Text(
              'Map Preview (demo)',
              style: Theme.of(context).textTheme.titleSmall?.copyWith(
                    fontWeight: FontWeight.w800,
                    color: cs.onSurface.withValues(alpha: 0.60),
                  ),
            ),
          ),
        ),
        Positioned(
          right: AppSpacing.sm,
          top: AppSpacing.sm,
          child: _PillButton(
            icon: Icons.map_rounded,
            text: 'Map',
            onTap: onMapTap,
            filled: false,
          ),
        ),
      ],
    );
  }
}

// ===== FILE: lib/features/tenant/shell/tenant_app_shell.dart =====

import 'package:flutter/material.dart';
import '../../../core/ui/scaffold/app_scaffold.dart';
import '../home/home_screen.dart';
import '../applications/applications_screen.dart';
import '../viewings/viewings_screen.dart';
import '../payments/payments_screen.dart';
import '../profile/profile_screen.dart';

class TenantAppShell extends StatefulWidget {
  const TenantAppShell({super.key});

  @override
  State<TenantAppShell> createState() => _TenantAppShellState();
}

class _TenantAppShellState extends State<TenantAppShell> {
  int _index = 0;

  final _pages = const <Widget>[
    HomeScreen(), // Explore
    ApplicationsScreen(), // Applications
    ViewingsScreen(), // Viewings
    PaymentsScreen(), // Payments
    ProfileScreen(), // Profile
  ];

  @override
  Widget build(BuildContext context) {
    return AppScaffold(
      child: Column(
        children: [
          Expanded(child: _pages[_index]),
          NavigationBar(
            selectedIndex: _index,
            onDestinationSelected: (i) => setState(() => _index = i),
            destinations: const [
              NavigationDestination(
                icon: Icon(Icons.explore_rounded),
                label: 'Explore',
              ),
              NavigationDestination(
                icon: Icon(Icons.description_rounded),
                label: 'Applications',
              ),
              NavigationDestination(
                icon: Icon(Icons.event_available_rounded),
                label: 'Viewings',
              ),
              NavigationDestination(
                icon: Icon(Icons.payments_rounded),
                label: 'Payments',
              ),
              NavigationDestination(
                icon: Icon(Icons.person_rounded),
                label: 'Profile',
              ),
            ],
          ),
        ],
      ),
    );
  }
}


// ===== FILE: lib/features/tenant/shell/tenant_shell.dart =====

import 'package:flutter/material.dart';

import '../../../core/ui/nav/tenant_bottom_nav.dart';
import '../../../core/ui/nav/tenant_nav_scope.dart';

import '../explore/explore_screen.dart';
import '../search/search_screen.dart';
import '../saved/saved_screen.dart';
import '../messages/messages_screen.dart';
import '../more/more_screen.dart';

class TenantShell extends StatefulWidget {
  const TenantShell({super.key, this.initialIndex = 0});
  final int initialIndex;

  @override
  State<TenantShell> createState() => _TenantShellState();
}

class _TenantShellState extends State<TenantShell> {
  late int _index;

  @override
  void initState() {
    super.initState();
    _index = widget.initialIndex;
  }

  void _setIndex(int i) => setState(() => _index = i);

  @override
  Widget build(BuildContext context) {
    final pages = <Widget>[
      const ExploreScreen(),
      const SearchScreen(),
      const SavedScreen(),
      const MessagesScreen(),
      const MoreScreen(),
    ];

    return TenantNavScope(
      index: _index,
      setIndex: _setIndex,
      child: Scaffold(
        extendBody: true, // nav floats over background like mock
        body: IndexedStack(index: _index, children: pages),
        bottomNavigationBar: TenantBottomNav(
          index: _index,
          messagesBadgeCount: 3,
          onChanged: _setIndex,
        ),
      ),
    );
  }
}


// ===== FILE: lib/features/tenant/tenancies/tenancies_screen.dart =====

import 'package:flutter/material.dart';

import "../maintenance/create_request_screen.dart";
import "../tenancy/pay_rent/pay_rent_sheet.dart";

import '../../../core/ui/scaffold/app_scaffold.dart';

import '../../../core/theme/app_colors.dart';

// ✅ Shared colors for this file (top-level)
const Color _blue = AppColors.brandBlueSoft;
const Color _muted = AppColors.textMutedLight;

class TenanciesScreen extends StatefulWidget {
  const TenanciesScreen({super.key});

  @override
  State<TenanciesScreen> createState() => TenanciesScreenState();
}

class TenanciesScreenState extends State<TenanciesScreen> {
  static const _bgTop = AppColors.lightBg;
  static const _bgBottom = AppColors.mist;
  static const _green = AppColors.brandGreenDeep;

  static const _blue = AppColors.brandBlueSoft;

  int _tab = 0; // 0=Active, 1=Past

  // Demo data (wire later)
  final List<_Tenancy> _active = const [
    _Tenancy(
      id: 't1',
      title: 'Lekki Phase 1 • Unit 3B',
      location: 'Lekki, Lagos',
      rent: 50000,
      dueLabel: 'May 1',
      startLabel: 'Jan 2026',
      endLabel: 'Jan 2027',
      statusLabel: 'Active',
    ),
    _Tenancy(
      id: 't2',
      title: 'Marina Garden • Unit A9',
      location: 'Victoria Island, Lagos',
      rent: 75000,
      dueLabel: 'May 6',
      startLabel: 'Feb 2026',
      endLabel: 'Feb 2027',
      statusLabel: 'Active',
    ),
    _Tenancy(
      id: 't3',
      title: 'Ikoyi Villa • Room 5C',
      location: 'Ikoyi, Lagos',
      rent: 120000,
      dueLabel: 'May 12',
      startLabel: 'Mar 2026',
      endLabel: 'Mar 2027',
      statusLabel: 'Active',
    ),
  ];

  final List<_Tenancy> _past = const [
    _Tenancy(
      id: 'p1',
      title: 'Yaba Heights • Flat 2A',
      location: 'Yaba, Lagos',
      rent: 35000,
      dueLabel: '-',
      startLabel: 'Jan 2024',
      endLabel: 'Jan 2025',
      statusLabel: 'Completed',
    ),
    _Tenancy(
      id: 'p2',
      title: 'Ajah Prime • Unit 1C',
      location: 'Ajah, Lagos',
      rent: 42000,
      dueLabel: '-',
      startLabel: 'Feb 2023',
      endLabel: 'Dec 2023',
      statusLabel: 'Terminated',
    ),
  ];

  String _fmtNaira(int v) {
    final s = v.toString();
    final buf = StringBuffer();
    for (int i = 0; i < s.length; i++) {
      final idxFromEnd = s.length - i;
      buf.write(s[i]);
      if (idxFromEnd > 1 && idxFromEnd % 3 == 1) buf.write(',');
    }
    return '₦$buf';
  }

  void _openDetails(_Tenancy t) {
    Navigator.of(context).push(
      MaterialPageRoute(builder: (_) => _TenancyDetailsScreen(tenancy: t)),
    );
  }

  void _openPaySheet(_Tenancy t) {
    PayRentSheet.open(context, title: t.title, amountNgn: t.rent);
  }

  @override
  Widget build(BuildContext context) {
    final list = _tab == 0 ? _active : _past;
    final activeCount = _active.length;

    return DecoratedBox(
      decoration: const BoxDecoration(
        gradient: LinearGradient(
          begin: Alignment.topCenter,
          end: Alignment.bottomCenter,
          colors: [_bgTop, _bgBottom],
        ),
      ),
      child: SafeArea(
        bottom: false,
        child: AppScaffold(
          safeAreaBottom: false,
          backgroundColor: Colors.transparent,
          appBar: AppBar(
            backgroundColor: Colors.transparent,
            elevation: 0,
            title: const Text('My Tenancies'),
            centerTitle: true,
            actions: [
              IconButton(
                onPressed: () {
                  ScaffoldMessenger.of(context).showSnackBar(
                    const SnackBar(content: Text('Documents (wire later)')),
                  );
                },
                icon: const Icon(Icons.description_rounded),
              ),
            ],
          ),
          child: ListView(
            padding: const EdgeInsets.fromLTRB(14, 8, 14, 24),
            children: [
              _SegmentTabs(
                left: _tab == 0 ? 'Active ($activeCount)' : 'Active',
                right: 'Past',
                value: _tab,
                onChanged: (v) => setState(() => _tab = v),
              ),
              const SizedBox(height: 12),
              ...list.map((t) {
                final isActive = _tab == 0;
                final pillColor = isActive ? _green : const Color(0xFF6B6B6B);

                return Padding(
                  padding: const EdgeInsets.only(bottom: 12),
                  child: _FrostCard(
                    child: Padding(
                      padding: const EdgeInsets.all(12),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Row(
                            children: [
                              ClipRRect(
                                borderRadius: BorderRadius.circular(12),
                                child: Container(
                                  height: 62,
                                  width: 72,
                                  color: const Color(
                                    0xFFCFDBEA,
                                  ).withValues(alpha: 0.85),
                                  alignment: Alignment.center,
                                  child: const Icon(
                                    Icons.home_rounded,
                                    color: _blue,
                                    size: 26,
                                  ),
                                ),
                              ),
                              const SizedBox(width: 12),
                              Expanded(
                                child: Column(
                                  crossAxisAlignment: CrossAxisAlignment.start,
                                  children: [
                                    Text(
                                      t.title,
                                      maxLines: 1,
                                      overflow: TextOverflow.ellipsis,
                                      style: Theme.of(context)
                                          .textTheme
                                          .titleMedium
                                          ?.copyWith(
                                            fontWeight: FontWeight.w900,
                                            color: AppColors.navy,
                                          ),
                                    ),
                                    const SizedBox(height: 4),
                                    Text(
                                      '${t.location} • ${t.startLabel} – ${t.endLabel}',
                                      maxLines: 1,
                                      overflow: TextOverflow.ellipsis,
                                      style: Theme.of(context)
                                          .textTheme
                                          .bodySmall
                                          ?.copyWith(
                                            fontWeight: FontWeight.w700,
                                            color: _muted.withValues(
                                              alpha: 0.85,
                                            ),
                                          ),
                                    ),
                                  ],
                                ),
                              ),
                              const SizedBox(width: 10),
                              Container(
                                padding: const EdgeInsets.symmetric(
                                  horizontal: 10,
                                  vertical: 6,
                                ),
                                decoration: BoxDecoration(
                                  color: pillColor.withValues(alpha: 0.18),
                                  borderRadius: BorderRadius.circular(999),
                                  border: Border.all(
                                    color: pillColor.withValues(alpha: 0.25),
                                  ),
                                ),
                                child: Text(
                                  t.statusLabel,
                                  style: const TextStyle(
                                    fontWeight: FontWeight.w900,
                                    color: AppColors.navy,
                                  ),
                                ),
                              ),
                            ],
                          ),
                          const SizedBox(height: 10),

                          // Key info row
                          Row(
                            children: [
                              _MiniInfo(
                                icon: Icons.payments_rounded,
                                text: '${_fmtNaira(t.rent)} / month',
                              ),
                              const SizedBox(width: 10),
                              _MiniInfo(
                                icon: Icons.event_rounded,
                                text: isActive
                                    ? 'Next due: ${t.dueLabel}'
                                    : '${t.startLabel} – ${t.endLabel}',
                              ),
                            ],
                          ),
                          const SizedBox(height: 12),

                          // Actions
                          Row(
                            children: [
                              Expanded(
                                child: _PillButton(
                                  text: isActive ? 'Pay rent' : 'View details',
                                  filled: true,
                                  color: isActive ? _blue : _green,
                                  onTap: () => isActive
                                      ? _openPaySheet(t)
                                      : _openDetails(t),
                                ),
                              ),
                              const SizedBox(width: 10),
                              Expanded(
                                child: _PillButton(
                                  text: 'View details',
                                  filled: false,
                                  color: _blue,
                                  onTap: () => _openDetails(t),
                                ),
                              ),
                            ],
                          ),
                          const SizedBox(height: 10),

                          // Links row
                          Wrap(
                            spacing: 12,
                            runSpacing: 8,
                            children: [
                              _LinkChip(
                                icon: Icons.description_rounded,
                                text: 'Lease documents',
                                onTap: () {},
                              ),
                              _LinkChip(
                                icon: Icons.build_rounded,
                                text: 'Request maintenance',
                                onTap: () {},
                              ),
                              _LinkChip(
                                icon: Icons.chat_rounded,
                                text: 'Contact landlord/agent',
                                onTap: () {},
                              ),
                            ],
                          ),
                        ],
                      ),
                    ),
                  ),
                );
              }),
            ],
          ),
        ),
      ),
    );
  }
}

class _TenancyDetailsScreen extends StatelessWidget {
  const _TenancyDetailsScreen({required this.tenancy});
  final _Tenancy tenancy;

  static const _bgTop = AppColors.lightBg;
  static const _bgBottom = AppColors.mist;
  static const _green = AppColors.brandGreenDeep;
  static const _muted = AppColors.textMutedLight;

  String _fmtNaira(int v) {
    final s = v.toString();
    final buf = StringBuffer();
    for (int i = 0; i < s.length; i++) {
      final idxFromEnd = s.length - i;
      buf.write(s[i]);
      if (idxFromEnd > 1 && idxFromEnd % 3 == 1) buf.write(',');
    }
    return '₦$buf';
  }

  @override
  Widget build(BuildContext context) {
    return DecoratedBox(
      decoration: const BoxDecoration(
        gradient: LinearGradient(
          begin: Alignment.topCenter,
          end: Alignment.bottomCenter,
          colors: [_bgTop, _bgBottom],
        ),
      ),
      child: SafeArea(
        bottom: false,
        child: AppScaffold(
          safeAreaBottom: false,
          backgroundColor: Colors.transparent,
          appBar: AppBar(
            backgroundColor: Colors.transparent,
            elevation: 0,
            title: Text(tenancy.title),
            centerTitle: true,
          ),
          body: ListView(
            padding: const EdgeInsets.fromLTRB(14, 10, 14, 24),
            children: [
              ClipRRect(
                borderRadius: BorderRadius.circular(18),
                child: Container(
                  height: 190,
                  color: const Color(0xFFCFDBEA).withValues(alpha: 0.85),
                  alignment: Alignment.center,
                  child: Icon(Icons.home_rounded, size: 56, color: _blue),
                ),
              ),
              const SizedBox(height: 12),

              _Section(
                title: 'Overview',
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      tenancy.location,
                      style: Theme.of(context).textTheme.bodyMedium?.copyWith(
                        fontWeight: FontWeight.w800,
                        color: AppColors.navy,
                      ),
                    ),
                    const SizedBox(height: 8),
                    Row(
                      children: [
                        const CircleAvatar(
                          radius: 18,
                          backgroundColor: Color(0xFFCFDBEA),
                          child: Icon(Icons.person_rounded, color: _blue),
                        ),
                        const SizedBox(width: 10),
                        Expanded(
                          child: Text(
                            'Landlord / Agent\nDaniel (wire later)',
                            style: Theme.of(context).textTheme.bodySmall
                                ?.copyWith(
                                  fontWeight: FontWeight.w800,
                                  color: AppColors.navy,
                                ),
                          ),
                        ),
                        _IconBubble(icon: Icons.call_rounded, onTap: () {}),
                        const SizedBox(width: 10),
                        _IconBubble(icon: Icons.chat_rounded, onTap: () {}),
                      ],
                    ),
                  ],
                ),
              ),
              const SizedBox(height: 12),

              _Section(
                title: 'Rent & Payments',
                child: Column(
                  children: [
                    _KVRow(
                      label: 'Monthly rent',
                      value: '${_fmtNaira(tenancy.rent)} / month',
                    ),
                    _KVRow(
                      label: 'Next due date',
                      value: tenancy.dueLabel == '-' ? '—' : tenancy.dueLabel,
                    ),
                    _KVRow(label: 'Status', value: tenancy.statusLabel),
                    const SizedBox(height: 10),
                    _PillButton(
                      text: 'Pay now',
                      filled: true,
                      color: _green,
                      onTap: () {
                        showModalBottomSheet(
                          context: context,
                          backgroundColor: Colors.transparent,
                          isScrollControlled: true,
                          builder: (_) => _PayRentSheet(
                            title: tenancy.title,
                            amount: tenancy.rent,
                            dueLabel: tenancy.dueLabel,
                            onContinue: () {
                              Navigator.of(context).pop();
                              ScaffoldMessenger.of(context).showSnackBar(
                                const SnackBar(
                                  content: Text(
                                    'Continue to payment (wire later)',
                                  ),
                                ),
                              );
                            },
                          ),
                        );
                      },
                    ),
                    const SizedBox(height: 10),
                    Text(
                      'Recent transactions (wire later)',
                      style: Theme.of(context).textTheme.bodySmall?.copyWith(
                        color: _muted.withValues(alpha: 0.85),
                        fontWeight: FontWeight.w800,
                      ),
                    ),
                  ],
                ),
              ),
              const SizedBox(height: 12),

              _Section(
                title: 'Lease',
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      '${tenancy.startLabel} – ${tenancy.endLabel}',
                      style: Theme.of(context).textTheme.bodyMedium?.copyWith(
                        fontWeight: FontWeight.w800,
                        color: AppColors.navy,
                      ),
                    ),
                    const SizedBox(height: 8),
                    _PillButton(
                      text: 'View lease document',
                      filled: false,
                      color: _blue,
                      onTap: () {},
                    ),
                  ],
                ),
              ),
              const SizedBox(height: 12),

              _Section(
                title: 'Maintenance',
                child: Column(
                  children: [
                    const _KVRow(label: 'Open requests', value: '0'),
                    const SizedBox(height: 10),
                    _PillButton(
                      text: 'Request maintenance',
                      filled: true,
                      color: _blue,
                      onTap: () {
                        Navigator.of(context).push(
                          MaterialPageRoute(
                            builder: (_) =>
                                const CreateMaintenanceRequestScreen(),
                          ),
                        );
                      },
                    ),
                  ],
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}

/* ---------------------- UI bits ---------------------- */

class _Tenancy {
  const _Tenancy({
    required this.id,
    required this.title,
    required this.location,
    required this.rent,
    required this.dueLabel,
    required this.startLabel,
    required this.endLabel,
    required this.statusLabel,
  });

  final String id;
  final String title;
  final String location;
  final int rent;
  final String dueLabel;
  final String startLabel;
  final String endLabel;
  final String statusLabel;
}

class _SegmentTabs extends StatelessWidget {
  const _SegmentTabs({
    required this.left,
    required this.right,
    required this.value,
    required this.onChanged,
  });

  final String left;
  final String right;
  final int value;
  final ValueChanged<int> onChanged;

  @override
  Widget build(BuildContext context) {
    return Container(
      height: 44,
      padding: const EdgeInsets.all(4),
      decoration: BoxDecoration(
        color: AppColors.surface(context).withValues(alpha: 0.65),
        borderRadius: BorderRadius.circular(14),
        border: Border.all(color: AppColors.overlay(context, 0.05)),
      ),
      child: Row(
        children: [
          Expanded(
            child: _SegBtn(
              text: left,
              active: value == 0,
              onTap: () => onChanged(0),
            ),
          ),
          const SizedBox(width: 6),
          Expanded(
            child: _SegBtn(
              text: right,
              active: value == 1,
              onTap: () => onChanged(1),
            ),
          ),
        ],
      ),
    );
  }
}

class _SegBtn extends StatelessWidget {
  const _SegBtn({
    required this.text,
    required this.active,
    required this.onTap,
  });
  final String text;
  final bool active;
  final VoidCallback onTap;

  @override
  Widget build(BuildContext context) {
    return InkWell(
      onTap: onTap,
      borderRadius: BorderRadius.circular(12),
      child: Container(
        alignment: Alignment.center,
        decoration: BoxDecoration(
          color: active ? _blue.withValues(alpha: 0.18) : Colors.transparent,
          borderRadius: BorderRadius.circular(12),
          border: Border.all(
            color: active ? _blue.withValues(alpha: 0.25) : Colors.transparent,
          ),
        ),
        child: Text(
          text,
          maxLines: 1,
          overflow: TextOverflow.ellipsis,
          style: Theme.of(context).textTheme.bodyMedium?.copyWith(
            fontWeight: FontWeight.w900,
            color: AppColors.navy,
          ),
        ),
      ),
    );
  }
}

class _MiniInfo extends StatelessWidget {
  const _MiniInfo({required this.icon, required this.text});
  final IconData icon;
  final String text;

  static const _muted = AppColors.textMutedLight;

  @override
  Widget build(BuildContext context) {
    return Expanded(
      child: Row(
        children: [
          Icon(icon, size: 18, color: _muted.withValues(alpha: 0.85)),
          const SizedBox(width: 8),
          Expanded(
            child: Text(
              text,
              maxLines: 1,
              overflow: TextOverflow.ellipsis,
              style: Theme.of(context).textTheme.bodySmall?.copyWith(
                fontWeight: FontWeight.w800,
                color: AppColors.navy,
              ),
            ),
          ),
        ],
      ),
    );
  }
}

class _LinkChip extends StatelessWidget {
  const _LinkChip({
    required this.icon,
    required this.text,
    required this.onTap,
  });
  final IconData icon;
  final String text;
  final VoidCallback onTap;

  static const _muted = AppColors.textMutedLight;

  @override
  Widget build(BuildContext context) {
    return InkWell(
      onTap: onTap,
      borderRadius: BorderRadius.circular(999),
      child: Container(
        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
        decoration: BoxDecoration(
          color: AppColors.surface(context).withValues(alpha: 0.55),
          borderRadius: BorderRadius.circular(999),
          border: Border.all(color: AppColors.overlay(context, 0.06)),
        ),
        child: Row(
          mainAxisSize: MainAxisSize.min,
          children: [
            Icon(icon, size: 16, color: _muted.withValues(alpha: 0.85)),
            const SizedBox(width: 8),
            Text(
              text,
              style: Theme.of(context).textTheme.bodySmall?.copyWith(
                fontWeight: FontWeight.w900,
                color: AppColors.navy,
              ),
            ),
          ],
        ),
      ),
    );
  }
}

class _Section extends StatelessWidget {
  const _Section({required this.title, required this.child});
  final String title;
  final Widget child;

  @override
  Widget build(BuildContext context) {
    return _FrostCard(
      child: Padding(
        padding: const EdgeInsets.all(14),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              title,
              style: Theme.of(context).textTheme.titleMedium?.copyWith(
                fontWeight: FontWeight.w900,
                color: AppColors.navy,
              ),
            ),
            const SizedBox(height: 10),
            child,
          ],
        ),
      ),
    );
  }
}

class _KVRow extends StatelessWidget {
  const _KVRow({required this.label, required this.value});
  final String label;
  final String value;

  static const _muted = AppColors.textMutedLight;

  @override
  Widget build(BuildContext context) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 8),
      child: Row(
        children: [
          Expanded(
            child: Text(
              label,
              style: Theme.of(context).textTheme.bodySmall?.copyWith(
                fontWeight: FontWeight.w800,
                color: _muted.withValues(alpha: 0.85),
              ),
            ),
          ),
          Text(
            value,
            style: Theme.of(context).textTheme.bodySmall?.copyWith(
              fontWeight: FontWeight.w900,
              color: AppColors.navy,
            ),
          ),
        ],
      ),
    );
  }
}

class _PayRentSheet extends StatefulWidget {
  const _PayRentSheet({
    required this.title,
    required this.amount,
    required this.dueLabel,
    required this.onContinue,
  });

  final String title;
  final int amount;
  final String dueLabel;
  final VoidCallback onContinue;

  @override
  State<_PayRentSheet> createState() => _PayRentSheetState();
}

class _PayRentSheetState extends State<_PayRentSheet> {
  static const _muted = AppColors.textMutedLight;

  bool _full = true;
  bool _includeService = false;
  final TextEditingController _partCtrl = TextEditingController();

  String _fmtNaira(int v) {
    final s = v.toString();
    final buf = StringBuffer();
    for (int i = 0; i < s.length; i++) {
      final idxFromEnd = s.length - i;
      buf.write(s[i]);
      if (idxFromEnd > 1 && idxFromEnd % 3 == 1) buf.write(',');
    }
    return '₦$buf';
  }

  @override
  void dispose() {
    _partCtrl.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final bottom = MediaQuery.of(context).viewInsets.bottom;

    return Padding(
      padding: EdgeInsets.only(bottom: bottom),
      child: Container(
        decoration: BoxDecoration(
          color: AppColors.surface(context).withValues(alpha: 0.92),
          borderRadius: const BorderRadius.vertical(top: Radius.circular(22)),
          boxShadow: [
            BoxShadow(
              blurRadius: 28,
              offset: const Offset(0, -12),
              color: AppColors.overlay(context, 0.12),
            ),
          ],
        ),
        child: SafeArea(
          top: false,
          child: Padding(
            padding: const EdgeInsets.fromLTRB(14, 12, 14, 14),
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                Container(
                  height: 5,
                  width: 44,
                  decoration: BoxDecoration(
                    color: const Color(0xFFCFDBEA).withValues(alpha: 0.9),
                    borderRadius: BorderRadius.circular(99),
                  ),
                ),
                const SizedBox(height: 12),
                Row(
                  children: [
                    Expanded(
                      child: Text(
                        'Pay Rent',
                        style: Theme.of(context).textTheme.titleLarge?.copyWith(
                          fontWeight: FontWeight.w900,
                          color: AppColors.navy,
                        ),
                      ),
                    ),
                    IconButton(
                      onPressed: () => Navigator.of(context).pop(),
                      icon: const Icon(Icons.close_rounded),
                    ),
                  ],
                ),
                const SizedBox(height: 8),

                Row(
                  children: [
                    ClipRRect(
                      borderRadius: BorderRadius.circular(12),
                      child: Container(
                        height: 58,
                        width: 70,
                        color: const Color(0xFFCFDBEA).withValues(alpha: 0.85),
                        alignment: Alignment.center,
                        child: Icon(Icons.home_rounded, color: _blue),
                      ),
                    ),
                    const SizedBox(width: 12),
                    Expanded(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text(
                            widget.title,
                            maxLines: 1,
                            overflow: TextOverflow.ellipsis,
                            style: Theme.of(context).textTheme.titleMedium
                                ?.copyWith(
                                  fontWeight: FontWeight.w900,
                                  color: AppColors.navy,
                                ),
                          ),
                          const SizedBox(height: 4),
                          Text(
                            'Due ${widget.dueLabel}',
                            style: Theme.of(context).textTheme.bodySmall
                                ?.copyWith(
                                  fontWeight: FontWeight.w800,
                                  color: _muted.withValues(alpha: 0.85),
                                ),
                          ),
                        ],
                      ),
                    ),
                  ],
                ),
                const SizedBox(height: 14),

                _ChoiceTile(
                  active: _full,
                  title: 'Full rent (${_fmtNaira(widget.amount)})',
                  onTap: () => setState(() => _full = true),
                ),
                const SizedBox(height: 10),
                _ChoiceTile(
                  active: !_full,
                  title: 'Part payment',
                  onTap: () => setState(() => _full = false),
                  trailing: !_full
                      ? SizedBox(
                          width: 120,
                          child: TextField(
                            controller: _partCtrl,
                            keyboardType: TextInputType.number,
                            decoration: const InputDecoration(
                              isDense: true,
                              hintText: 'Amount',
                              border: OutlineInputBorder(),
                            ),
                          ),
                        )
                      : null,
                ),

                const SizedBox(height: 12),
                Row(
                  children: [
                    Expanded(
                      child: Text(
                        'Include service charge?',
                        style: Theme.of(context).textTheme.bodySmall?.copyWith(
                          fontWeight: FontWeight.w800,
                          color: AppColors.navy,
                        ),
                      ),
                    ),
                    Switch(
                      value: _includeService,
                      onChanged: (v) => setState(() => _includeService = v),
                    ),
                  ],
                ),

                const SizedBox(height: 10),
                _PillButton(
                  text: 'Continue',
                  filled: true,
                  color: _blue,
                  onTap: widget.onContinue,
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }
}

class _ChoiceTile extends StatelessWidget {
  const _ChoiceTile({
    required this.active,
    required this.title,
    required this.onTap,
    this.trailing,
  });

  final bool active;
  final String title;
  final VoidCallback onTap;
  final Widget? trailing;

  @override
  Widget build(BuildContext context) {
    return InkWell(
      onTap: onTap,
      borderRadius: BorderRadius.circular(14),
      child: Container(
        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 12),
        decoration: BoxDecoration(
          color: active
              ? _blue.withValues(alpha: 0.12)
              : AppColors.surface(context).withValues(alpha: 0.6),
          borderRadius: BorderRadius.circular(14),
          border: Border.all(
            color: active
                ? _blue.withValues(alpha: 0.25)
                : AppColors.overlay(context, 0.06),
          ),
        ),
        child: Row(
          children: [
            Expanded(
              child: Text(
                title,
                style: Theme.of(context).textTheme.bodyMedium?.copyWith(
                  fontWeight: FontWeight.w900,
                  color: AppColors.navy,
                ),
              ),
            ),
            if (trailing != null) ...[const SizedBox(width: 10), trailing!],
            const SizedBox(width: 10),
            Container(
              height: 22,
              width: 22,
              decoration: BoxDecoration(
                color: active ? _blue : Colors.transparent,
                borderRadius: BorderRadius.circular(6),
                border: Border.all(
                  color: active ? _blue : AppColors.overlay(context, 0.2),
                ),
              ),
              child: active
                  ? const Icon(
                      Icons.check_rounded,
                      color: Colors.white,
                      size: 16,
                    )
                  : null,
            ),
          ],
        ),
      ),
    );
  }
}

class _IconBubble extends StatelessWidget {
  const _IconBubble({required this.icon, required this.onTap});
  final IconData icon;
  final VoidCallback onTap;

  @override
  Widget build(BuildContext context) {
    return InkWell(
      onTap: onTap,
      borderRadius: BorderRadius.circular(12),
      child: Container(
        height: 38,
        width: 38,
        decoration: BoxDecoration(
          color: AppColors.surface(context).withValues(alpha: 0.6),
          borderRadius: BorderRadius.circular(12),
          border: Border.all(color: AppColors.overlay(context, 0.06)),
        ),
        child: Icon(icon, color: AppColors.brandBlueSoft, size: 18),
      ),
    );
  }
}

class _PillButton extends StatelessWidget {
  const _PillButton({
    required this.text,
    required this.onTap,
    required this.filled,
    required this.color,
  });

  final String text;
  final VoidCallback? onTap;
  final bool filled;
  final Color color;

  @override
  Widget build(BuildContext context) {
    final disabled = onTap == null;
    return InkWell(
      onTap: onTap,
      borderRadius: BorderRadius.circular(16),
      child: Container(
        height: 48,
        alignment: Alignment.center,
        decoration: BoxDecoration(
          color: disabled
              ? const Color(0xFFB9C1CF).withValues(alpha: 0.35)
              : (filled ? color.withValues(alpha: 0.80) : Colors.transparent),
          borderRadius: BorderRadius.circular(16),
          border: Border.all(
            color: disabled
                ? AppColors.overlay(context, 0.06)
                : color.withValues(alpha: 0.25),
          ),
        ),
        child: Text(
          text,
          style: Theme.of(context).textTheme.bodyMedium?.copyWith(
            fontWeight: FontWeight.w900,
            color: disabled
                ? const Color(0xFF9AA2AF)
                : (filled ? Colors.white : AppColors.navy),
          ),
        ),
      ),
    );
  }
}

class _FrostCard extends StatelessWidget {
  const _FrostCard({required this.child});
  final Widget child;

  @override
  Widget build(BuildContext context) {
    return Container(
      decoration: BoxDecoration(
        color: AppColors.surface(context).withValues(alpha: 0.62),
        borderRadius: BorderRadius.circular(18),
        border: Border.all(
          color: AppColors.surface(context).withValues(alpha: 0.55),
        ),
        boxShadow: [
          BoxShadow(
            blurRadius: 18,
            offset: const Offset(0, 10),
            color: AppColors.overlay(context, 0.08),
          ),
        ],
      ),
      child: child,
    );
  }
}


// ===== FILE: lib/features/tenant/tenancy/pay_rent/confirm_payment_screen.dart =====

import "package:flutter/material.dart";

import '../../../../core/ui/scaffold/app_top_bar.dart';
import "payment_success_screen.dart";
import '../../../../core/ui/scaffold/app_scaffold.dart';

import '../../../../core/theme/app_colors.dart';

class ConfirmPaymentScreen extends StatefulWidget {
  const ConfirmPaymentScreen({
    super.key,
    required this.title,
    required this.amountNgn,
    required this.includeServiceCharge,
    required this.methodLabel,
  });

  final String title;
  final int amountNgn;
  final bool includeServiceCharge;
  final String methodLabel;

  @override
  State<ConfirmPaymentScreen> createState() => _ConfirmPaymentScreenState();
}

class _ConfirmPaymentScreenState extends State<ConfirmPaymentScreen> {
  bool _full = true;

  String _fmt(int v) {
    final s = v.toString();
    final buf = StringBuffer();
    for (int i = 0; i < s.length; i++) {
      final idxFromEnd = s.length - i;
      buf.write(s[i]);
      if (idxFromEnd > 1 && idxFromEnd % 3 == 1) buf.write(",");
    }
    return "₦$buf";
  }

  int get _fee =>
      widget.includeServiceCharge ? 0 : 0; // demo (keep ₦0 like mock)
  int get _total => widget.amountNgn + _fee;

  @override
  Widget build(BuildContext context) {
    return AppScaffold(
      topBar: const AppTopBar(title: 'Confirm Payment'),
      child: DecoratedBox(
        decoration: const BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [Color(0xFFF1F3F8), Color(0xFFE9ECF4)],
          ),
        ),
        child: SafeArea(
          bottom: false,
          child: Column(
            children: [
              Padding(
                padding: const EdgeInsets.fromLTRB(10, 8, 10, 8),
                child: Row(
                  children: [
                    IconButton(
                      onPressed: () => Navigator.of(context).maybePop(),
                      icon: const Icon(Icons.arrow_back_ios_new_rounded),
                    ),
                    Expanded(
                      child: Text(
                        "Confirm Payment",
                        textAlign: TextAlign.center,
                        style: Theme.of(context).textTheme.titleMedium
                            ?.copyWith(
                              fontWeight: FontWeight.w900,
                              color: AppColors.navy,
                            ),
                      ),
                    ),
                    const SizedBox(width: 44),
                  ],
                ),
              ),
              Expanded(
                child: ListView(
                  padding: const EdgeInsets.fromLTRB(14, 10, 14, 120),
                  children: [
                    _Card(
                      child: Padding(
                        padding: const EdgeInsets.all(14),
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(
                              "Rent",
                              style: Theme.of(context).textTheme.titleSmall
                                  ?.copyWith(
                                    fontWeight: FontWeight.w900,
                                    color: AppColors.navy,
                                  ),
                            ),
                            const SizedBox(height: 12),
                            _RowLine(
                              left: "Tenancy:",
                              right: _fmt(widget.amountNgn),
                            ),
                            const SizedBox(height: 10),
                            _RowLine(left: "Tenancy", right: widget.title),
                            const SizedBox(height: 10),
                            _RowLine(left: "Fees:", right: _fmt(_fee)),
                            const SizedBox(height: 10),
                            _RowLine(left: "Total:", right: _fmt(_total)),
                            const SizedBox(height: 10),
                            _RowLine(
                              left: "Method:",
                              right: widget.methodLabel,
                            ),
                          ],
                        ),
                      ),
                    ),
                    const SizedBox(height: 16),
                    Text(
                      "Choose what to pay",
                      style: Theme.of(context).textTheme.bodyMedium?.copyWith(
                        fontWeight: FontWeight.w900,
                        color: AppColors.navy,
                      ),
                    ),
                    const SizedBox(height: 10),
                    _Choice(
                      label: "Full rent (${_fmt(widget.amountNgn)})",
                      selected: _full,
                      onTap: () => setState(() => _full = true),
                    ),
                    const SizedBox(height: 10),
                    _Choice(
                      label: "Part payment",
                      selected: !_full,
                      onTap: () => setState(() => _full = false),
                    ),
                    const SizedBox(height: 18),
                    SizedBox(
                      width: double.infinity,
                      child: ElevatedButton(
                        onPressed: () {
                          Navigator.of(context).pushReplacement(
                            MaterialPageRoute(
                              builder: (_) => PaymentSuccessScreen(
                                receiptId: "6300121679",
                                title: widget.title,
                                amountNgn: _total,
                              ),
                            ),
                          );
                        },
                        style: ElevatedButton.styleFrom(
                          backgroundColor: const Color(0xFF6E8E7A),
                          padding: const EdgeInsets.symmetric(vertical: 14),
                          shape: RoundedRectangleBorder(
                            borderRadius: BorderRadius.circular(12),
                          ),
                        ),
                        child: const Text(
                          "Confirm & Pay",
                          style: TextStyle(fontWeight: FontWeight.w900),
                        ),
                      ),
                    ),
                  ],
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}

class _RowLine extends StatelessWidget {
  const _RowLine({required this.left, required this.right});
  final String left;
  final String right;

  @override
  Widget build(BuildContext context) {
    return Row(
      children: [
        Expanded(
          child: Text(
            left,
            style: Theme.of(context).textTheme.bodySmall?.copyWith(
              fontWeight: FontWeight.w800,
              color: AppColors.textMutedLight,
            ),
          ),
        ),
        Expanded(
          child: Text(
            right,
            textAlign: TextAlign.right,
            style: Theme.of(context).textTheme.bodyMedium?.copyWith(
              fontWeight: FontWeight.w900,
              color: AppColors.navy,
            ),
          ),
        ),
      ],
    );
  }
}

class _Choice extends StatelessWidget {
  const _Choice({
    required this.label,
    required this.selected,
    required this.onTap,
  });
  final String label;
  final bool selected;
  final VoidCallback onTap;

  @override
  Widget build(BuildContext context) {
    return Material(
      color: selected
          ? const Color(0xFF6E87B8).withValues(alpha: 0.22)
          : AppColors.surface(context).withValues(alpha: 0.55),
      borderRadius: BorderRadius.circular(14),
      child: InkWell(
        onTap: onTap,
        borderRadius: BorderRadius.circular(14),
        child: Padding(
          padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 12),
          child: Row(
            children: [
              Expanded(
                child: Text(
                  label,
                  style: Theme.of(context).textTheme.bodyMedium?.copyWith(
                    fontWeight: FontWeight.w900,
                    color: AppColors.navy,
                  ),
                ),
              ),
              Container(
                height: 22,
                width: 22,
                decoration: BoxDecoration(
                  color: selected
                      ? const Color(0xFF6E87B8)
                      : Colors.transparent,
                  borderRadius: BorderRadius.circular(6),
                  border: Border.all(
                    color: selected
                        ? const Color(0xFF6E87B8)
                        : const Color(0xFFB9C1CF),
                  ),
                ),
                child: selected
                    ? const Icon(
                        Icons.check_rounded,
                        size: 16,
                        color: Colors.white,
                      )
                    : null,
              ),
            ],
          ),
        ),
      ),
    );
  }
}

class _Card extends StatelessWidget {
  const _Card({required this.child});
  final Widget child;

  @override
  Widget build(BuildContext context) {
    return Material(
      color: AppColors.surface(context).withValues(alpha: 0.62),
      borderRadius: BorderRadius.circular(18),
      child: Container(
        decoration: BoxDecoration(
          borderRadius: BorderRadius.circular(18),
          border: Border.all(
            color: AppColors.surface(context).withValues(alpha: 0.55),
          ),
          boxShadow: [
            BoxShadow(
              blurRadius: 18,
              offset: const Offset(0, 10),
              color: AppColors.overlay(context, 0.08),
            ),
          ],
        ),
        child: child,
      ),
    );
  }
}


// ===== FILE: lib/features/tenant/tenancy/pay_rent/pay_rent_sheet.dart =====

import "package:flutter/material.dart";

import "select_payment_method_screen.dart";

import '../../../../core/theme/app_colors.dart';

class PayRentSheet {
  static Future<void> open(
    BuildContext context, {
    required String title,
    required int amountNgn,
  }) async {
    final res = await showModalBottomSheet<_PayRentResult>(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (ctx) => _PayRentBottomSheet(title: title, amountNgn: amountNgn),
    );

    if (res == null) return;

    if (context.mounted) {
      Navigator.of(context).push(
        MaterialPageRoute(
          builder: (_) => SelectPaymentMethodScreen(
            title: title,
            amountNgn: res.amountNgn,
            includeServiceCharge: res.includeServiceCharge,
          ),
        ),
      );
    }
  }
}

class _PayRentBottomSheet extends StatefulWidget {
  const _PayRentBottomSheet({required this.title, required this.amountNgn});

  final String title;
  final int amountNgn;

  @override
  State<_PayRentBottomSheet> createState() => _PayRentBottomSheetState();
}

class _PayRentBottomSheetState extends State<_PayRentBottomSheet> {
  bool _full = true;
  bool _includeFee = false;

  final TextEditingController _partCtrl = TextEditingController();

  String _fmt(int v) {
    final s = v.toString();
    final buf = StringBuffer();
    for (int i = 0; i < s.length; i++) {
      final idxFromEnd = s.length - i;
      buf.write(s[i]);
      if (idxFromEnd > 1 && idxFromEnd % 3 == 1) buf.write(",");
    }
    return "₦$buf";
  }

  int get _amount {
    if (_full) return widget.amountNgn;
    final raw = _partCtrl.text.replaceAll(RegExp(r"[^0-9]"), "");
    if (raw.isEmpty) return 0;
    return int.tryParse(raw) ?? 0;
  }

  @override
  void dispose() {
    _partCtrl.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final amount = _amount;

    return SafeArea(
      child: Padding(
        padding: EdgeInsets.only(
          bottom: MediaQuery.of(context).viewInsets.bottom,
        ),
        child: Material(
          color: Colors.transparent,
          child: Container(
            margin: const EdgeInsets.fromLTRB(12, 12, 12, 12),
            padding: const EdgeInsets.fromLTRB(14, 14, 14, 14),
            decoration: BoxDecoration(
              color: const Color(0xFFF1F3F8),
              borderRadius: BorderRadius.circular(18),
              border: Border.all(
                color: AppColors.surface(context).withValues(alpha: 0.7),
              ),
              boxShadow: [
                BoxShadow(
                  blurRadius: 22,
                  offset: const Offset(0, 12),
                  color: AppColors.overlay(context, 0.12),
                ),
              ],
            ),
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                Row(
                  children: [
                    const SizedBox(width: 34),
                    Expanded(
                      child: Text(
                        "Pay Rent",
                        textAlign: TextAlign.center,
                        style: Theme.of(context).textTheme.titleMedium
                            ?.copyWith(
                              fontWeight: FontWeight.w900,
                              color: AppColors.navy,
                            ),
                      ),
                    ),
                    IconButton(
                      onPressed: () => Navigator.of(context).pop(),
                      icon: const Icon(Icons.close_rounded),
                    ),
                  ],
                ),
                const SizedBox(height: 8),
                Container(
                  padding: const EdgeInsets.all(12),
                  decoration: BoxDecoration(
                    color: AppColors.surface(context).withValues(alpha: 0.60),
                    borderRadius: BorderRadius.circular(16),
                    border: Border.all(
                      color: AppColors.surface(context).withValues(alpha: 0.55),
                    ),
                  ),
                  child: Row(
                    children: [
                      ClipRRect(
                        borderRadius: BorderRadius.circular(12),
                        child: Container(
                          height: 54,
                          width: 54,
                          color: const Color(
                            0xFFCFDBEA,
                          ).withValues(alpha: 0.85),
                          alignment: Alignment.center,
                          child: const Icon(
                            Icons.home_rounded,
                            color: AppColors.brandBlueSoft,
                          ),
                        ),
                      ),
                      const SizedBox(width: 12),
                      Expanded(
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Text(
                              widget.title,
                              maxLines: 1,
                              overflow: TextOverflow.ellipsis,
                              style: Theme.of(context).textTheme.titleSmall
                                  ?.copyWith(
                                    fontWeight: FontWeight.w900,
                                    color: AppColors.navy,
                                  ),
                            ),
                            const SizedBox(height: 6),
                            Text(
                              "Amount due",
                              style: Theme.of(context).textTheme.bodySmall
                                  ?.copyWith(
                                    fontWeight: FontWeight.w800,
                                    color: AppColors.textMutedLight,
                                  ),
                            ),
                            const SizedBox(height: 2),
                            Text(
                              _fmt(widget.amountNgn),
                              style: Theme.of(context).textTheme.titleMedium
                                  ?.copyWith(
                                    fontWeight: FontWeight.w900,
                                    color: AppColors.navy,
                                  ),
                            ),
                          ],
                        ),
                      ),
                    ],
                  ),
                ),
                const SizedBox(height: 14),

                Align(
                  alignment: Alignment.centerLeft,
                  child: Text(
                    "Choose what to pay",
                    style: Theme.of(context).textTheme.bodyMedium?.copyWith(
                      fontWeight: FontWeight.w800,
                      color: AppColors.navy,
                    ),
                  ),
                ),
                const SizedBox(height: 10),

                _ChoiceTile(
                  label: "Full rent (${_fmt(widget.amountNgn)})",
                  selected: _full,
                  onTap: () => setState(() => _full = true),
                ),
                const SizedBox(height: 10),
                _ChoiceTile(
                  label: "Part payment",
                  selected: !_full,
                  onTap: () => setState(() => _full = false),
                ),
                if (!_full) ...[
                  const SizedBox(height: 10),
                  TextField(
                    controller: _partCtrl,
                    keyboardType: TextInputType.number,
                    decoration: const InputDecoration(
                      hintText: "Enter amount",
                      border: OutlineInputBorder(),
                    ),
                    onChanged: (_) => setState(() {}),
                  ),
                ],

                const SizedBox(height: 14),
                Row(
                  children: [
                    Expanded(
                      child: Text(
                        "Include service charge",
                        style: Theme.of(context).textTheme.bodyMedium?.copyWith(
                          fontWeight: FontWeight.w800,
                          color: AppColors.navy,
                        ),
                      ),
                    ),
                    Switch(
                      value: _includeFee,
                      onChanged: (v) => setState(() => _includeFee = v),
                    ),
                  ],
                ),
                const SizedBox(height: 12),

                SizedBox(
                  width: double.infinity,
                  child: ElevatedButton(
                    onPressed: amount <= 0
                        ? null
                        : () {
                            Navigator.of(context).pop(
                              _PayRentResult(
                                amountNgn: amount,
                                includeServiceCharge: _includeFee,
                              ),
                            );
                          },
                    style: ElevatedButton.styleFrom(
                      backgroundColor: const Color(0xFF6E87B8),
                      padding: const EdgeInsets.symmetric(vertical: 14),
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(12),
                      ),
                    ),
                    child: const Text(
                      "Continue",
                      style: TextStyle(fontWeight: FontWeight.w900),
                    ),
                  ),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }
}

class _ChoiceTile extends StatelessWidget {
  const _ChoiceTile({
    required this.label,
    required this.selected,
    required this.onTap,
  });

  final String label;
  final bool selected;
  final VoidCallback onTap;

  @override
  Widget build(BuildContext context) {
    return Material(
      color: selected
          ? const Color(0xFF6E87B8).withValues(alpha: 0.22)
          : AppColors.surface(context).withValues(alpha: 0.55),
      borderRadius: BorderRadius.circular(14),
      child: InkWell(
        onTap: onTap,
        borderRadius: BorderRadius.circular(14),
        child: Padding(
          padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 12),
          child: Row(
            children: [
              Expanded(
                child: Text(
                  label,
                  style: Theme.of(context).textTheme.bodyMedium?.copyWith(
                    fontWeight: FontWeight.w900,
                    color: AppColors.navy,
                  ),
                ),
              ),
              Container(
                height: 22,
                width: 22,
                decoration: BoxDecoration(
                  color: selected
                      ? const Color(0xFF6E87B8)
                      : Colors.transparent,
                  borderRadius: BorderRadius.circular(6),
                  border: Border.all(
                    color: selected
                        ? const Color(0xFF6E87B8)
                        : const Color(0xFFB9C1CF),
                  ),
                ),
                child: selected
                    ? const Icon(
                        Icons.check_rounded,
                        size: 16,
                        color: Colors.white,
                      )
                    : null,
              ),
            ],
          ),
        ),
      ),
    );
  }
}

class _PayRentResult {
  const _PayRentResult({
    required this.amountNgn,
    required this.includeServiceCharge,
  });
  final int amountNgn;
  final bool includeServiceCharge;
}


// ===== FILE: lib/features/tenant/tenancy/pay_rent/payment_success_screen.dart =====

import "package:flutter/material.dart";

import '../../../../core/ui/scaffold/app_top_bar.dart';
import '../../../../core/ui/scaffold/app_scaffold.dart';

import '../../../../core/theme/app_colors.dart';

class PaymentSuccessScreen extends StatelessWidget {
  const PaymentSuccessScreen({
    super.key,
    required this.receiptId,
    required this.title,
    required this.amountNgn,
  });

  final String receiptId;
  final String title;
  final int amountNgn;

  String _fmt(int v) {
    final s = v.toString();
    final buf = StringBuffer();
    for (int i = 0; i < s.length; i++) {
      final idxFromEnd = s.length - i;
      buf.write(s[i]);
      if (idxFromEnd > 1 && idxFromEnd % 3 == 1) buf.write(",");
    }
    return "₦$buf";
  }

  @override
  Widget build(BuildContext context) {
    final when = DateTime.now();
    final mo = [
      "Jan",
      "Feb",
      "Mar",
      "Apr",
      "May",
      "Jun",
      "Jul",
      "Aug",
      "Sep",
      "Oct",
      "Nov",
      "Dec",
    ][when.month - 1];
    final hour12 = (when.hour % 12 == 0) ? 12 : (when.hour % 12);
    final ampm = when.hour >= 12 ? "PM" : "AM";
    final time =
        "$mo ${when.day}, ${when.year} at $hour12:${when.minute.toString().padLeft(2, "0")} $ampm";

    return AppScaffold(
      topBar: const AppTopBar(title: 'Payment Success'),
      child: DecoratedBox(
        decoration: const BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [Color(0xFFF1F3F8), Color(0xFFE9ECF4)],
          ),
        ),
        child: SafeArea(
          child: Padding(
            padding: const EdgeInsets.fromLTRB(18, 18, 18, 18),
            child: Column(
              children: [
                const SizedBox(height: 12),
                const CircleAvatar(
                  radius: 26,
                  backgroundColor: Color(0xFF6E8E7A),
                  child: Icon(
                    Icons.check_rounded,
                    color: Colors.white,
                    size: 28,
                  ),
                ),
                const SizedBox(height: 14),
                Text(
                  "Payment Successful",
                  style: Theme.of(context).textTheme.titleLarge?.copyWith(
                    fontWeight: FontWeight.w900,
                    color: AppColors.navy,
                  ),
                ),
                const SizedBox(height: 10),
                Text(
                  "Receipt ID: $receiptId",
                  style: Theme.of(context).textTheme.bodyMedium?.copyWith(
                    fontWeight: FontWeight.w800,
                    color: AppColors.textMutedLight,
                  ),
                ),
                const SizedBox(height: 6),
                Text(
                  time,
                  style: Theme.of(context).textTheme.bodyMedium?.copyWith(
                    fontWeight: FontWeight.w800,
                    color: AppColors.textMutedLight,
                  ),
                ),
                const SizedBox(height: 18),
                SizedBox(
                  width: double.infinity,
                  child: ElevatedButton(
                    onPressed: () {},
                    style: ElevatedButton.styleFrom(
                      backgroundColor: const Color(0xFF6E87B8),
                      padding: const EdgeInsets.symmetric(vertical: 14),
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(12),
                      ),
                    ),
                    child: const Text(
                      "Download receipt",
                      style: TextStyle(fontWeight: FontWeight.w900),
                    ),
                  ),
                ),
                const SizedBox(height: 12),
                SizedBox(
                  width: double.infinity,
                  child: OutlinedButton(
                    onPressed: () {},
                    style: OutlinedButton.styleFrom(
                      padding: const EdgeInsets.symmetric(vertical: 14),
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(12),
                      ),
                    ),
                    child: const Text(
                      "View transactions",
                      style: TextStyle(fontWeight: FontWeight.w900),
                    ),
                  ),
                ),
                const SizedBox(height: 12),
                SizedBox(
                  width: double.infinity,
                  child: OutlinedButton(
                    onPressed: () =>
                        Navigator.of(context).popUntil((r) => r.isFirst),
                    style: OutlinedButton.styleFrom(
                      padding: const EdgeInsets.symmetric(vertical: 14),
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(12),
                      ),
                    ),
                    child: const Text(
                      "Back to tenancy",
                      style: TextStyle(fontWeight: FontWeight.w900),
                    ),
                  ),
                ),
                const Spacer(),
                Text(
                  "Paid: ${_fmt(amountNgn)} • $title",
                  style: Theme.of(context).textTheme.bodySmall?.copyWith(
                    fontWeight: FontWeight.w800,
                    color: AppColors.textMutedLight,
                  ),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }
}


// ===== FILE: lib/features/tenant/tenancy/pay_rent/select_payment_method_screen.dart =====

import "package:flutter/material.dart";

import '../../../../core/ui/scaffold/app_top_bar.dart';
import "confirm_payment_screen.dart";
import '../../../../core/ui/scaffold/app_scaffold.dart';

import '../../../../core/theme/app_colors.dart';

class SelectPaymentMethodScreen extends StatefulWidget {
  const SelectPaymentMethodScreen({
    super.key,
    required this.title,
    required this.amountNgn,
    required this.includeServiceCharge,
  });

  final String title;
  final int amountNgn;
  final bool includeServiceCharge;

  @override
  State<SelectPaymentMethodScreen> createState() =>
      _SelectPaymentMethodScreenState();
}

enum _Method { card, bank, wallet }

class _SelectPaymentMethodScreenState extends State<SelectPaymentMethodScreen> {
  _Method _method = _Method.card;

  String _fmt(int v) {
    final s = v.toString();
    final buf = StringBuffer();
    for (int i = 0; i < s.length; i++) {
      final idxFromEnd = s.length - i;
      buf.write(s[i]);
      if (idxFromEnd > 1 && idxFromEnd % 3 == 1) buf.write(",");
    }
    return "₦$buf";
  }

  @override
  Widget build(BuildContext context) {
    return AppScaffold(
      topBar: const AppTopBar(title: 'Select Payment Method'),
      child: DecoratedBox(
        decoration: const BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [Color(0xFFF1F3F8), Color(0xFFE9ECF4)],
          ),
        ),
        child: SafeArea(
          bottom: false,
          child: Column(
            children: [
              Padding(
                padding: const EdgeInsets.fromLTRB(10, 8, 10, 8),
                child: Row(
                  children: [
                    IconButton(
                      onPressed: () => Navigator.of(context).maybePop(),
                      icon: const Icon(Icons.arrow_back_ios_new_rounded),
                    ),
                    Expanded(
                      child: Text(
                        "Select Payment Method",
                        textAlign: TextAlign.center,
                        style: Theme.of(context).textTheme.titleMedium
                            ?.copyWith(
                              fontWeight: FontWeight.w900,
                              color: AppColors.navy,
                            ),
                      ),
                    ),
                    const SizedBox(width: 44),
                  ],
                ),
              ),
              Expanded(
                child: ListView(
                  padding: const EdgeInsets.fromLTRB(14, 10, 14, 120),
                  children: [
                    _SelectTile(
                      title: "Card",
                      subtitle: "•••• 1234",
                      leading: Icons.credit_card_rounded,
                      selected: _method == _Method.card,
                      onTap: () => setState(() => _method = _Method.card),
                      trailing: _method == _Method.card
                          ? const Icon(
                              Icons.check_circle_rounded,
                              color: Color(0xFF6E87B8),
                            )
                          : const Icon(Icons.chevron_right_rounded),
                    ),
                    const SizedBox(height: 12),
                    _SelectTile(
                      title: "Bank Transfer",
                      subtitle: "03 / 26",
                      leading: Icons.account_balance_rounded,
                      selected: _method == _Method.bank,
                      onTap: () => setState(() => _method = _Method.bank),
                      trailing: _method == _Method.bank
                          ? const Icon(
                              Icons.check_circle_rounded,
                              color: Color(0xFF6E87B8),
                            )
                          : const Icon(Icons.chevron_right_rounded),
                    ),
                    const SizedBox(height: 12),
                    _SelectTile(
                      title: "Wallet",
                      subtitle: "₦0",
                      leading: Icons.account_balance_wallet_rounded,
                      selected: _method == _Method.wallet,
                      onTap: () => setState(() => _method = _Method.wallet),
                      trailing: _method == _Method.wallet
                          ? const Icon(
                              Icons.check_circle_rounded,
                              color: Color(0xFF6E87B8),
                            )
                          : const Icon(Icons.chevron_right_rounded),
                    ),
                    const SizedBox(height: 18),
                    Text(
                      "Add new method",
                      style: Theme.of(context).textTheme.bodyMedium?.copyWith(
                        fontWeight: FontWeight.w900,
                        color: AppColors.navy,
                      ),
                    ),
                    const SizedBox(height: 10),
                    _GhostTile(icon: Icons.credit_card_rounded, text: "Card"),
                    const SizedBox(height: 10),
                    _GhostTile(
                      icon: Icons.account_balance_rounded,
                      text: "Bank Transfer",
                    ),
                    const SizedBox(height: 10),
                    _GhostTile(
                      icon: Icons.account_balance_wallet_rounded,
                      text: "Wallet",
                    ),
                    const SizedBox(height: 10),
                    _GhostTile(icon: Icons.add_rounded, text: "New method"),
                  ],
                ),
              ),
              SafeArea(
                top: false,
                child: Padding(
                  padding: const EdgeInsets.fromLTRB(14, 10, 14, 16),
                  child: SizedBox(
                    width: double.infinity,
                    child: ElevatedButton(
                      onPressed: () {
                        Navigator.of(context).push(
                          MaterialPageRoute(
                            builder: (_) => ConfirmPaymentScreen(
                              title: widget.title,
                              amountNgn: widget.amountNgn,
                              includeServiceCharge: widget.includeServiceCharge,
                              methodLabel: switch (_method) {
                                _Method.card => "Card •••• 1234",
                                _Method.bank => "Bank Transfer",
                                _Method.wallet => "Wallet",
                              },
                            ),
                          ),
                        );
                      },
                      style: ElevatedButton.styleFrom(
                        backgroundColor: const Color(0xFF6E8E7A),
                        padding: const EdgeInsets.symmetric(vertical: 14),
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(12),
                        ),
                      ),
                      child: Text(
                        "Pay ${_fmt(widget.amountNgn)}",
                        style: const TextStyle(fontWeight: FontWeight.w900),
                      ),
                    ),
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}

class _SelectTile extends StatelessWidget {
  const _SelectTile({
    required this.title,
    required this.subtitle,
    required this.leading,
    required this.selected,
    required this.onTap,
    required this.trailing,
  });

  final String title;
  final String subtitle;
  final IconData leading;
  final bool selected;
  final VoidCallback onTap;
  final Widget trailing;

  @override
  Widget build(BuildContext context) {
    return Material(
      color: Colors.white.withValues(alpha: selected ? 0.80 : 0.60),
      borderRadius: BorderRadius.circular(18),
      child: InkWell(
        onTap: onTap,
        borderRadius: BorderRadius.circular(18),
        child: Padding(
          padding: const EdgeInsets.all(14),
          child: Row(
            children: [
              Container(
                height: 44,
                width: 44,
                decoration: BoxDecoration(
                  color: const Color(0xFFCFDBEA).withValues(alpha: 0.85),
                  borderRadius: BorderRadius.circular(14),
                ),
                alignment: Alignment.center,
                child: Icon(leading, color: AppColors.brandBlueSoft),
              ),
              const SizedBox(width: 12),
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      title,
                      style: Theme.of(context).textTheme.titleSmall?.copyWith(
                        fontWeight: FontWeight.w900,
                        color: AppColors.navy,
                      ),
                    ),
                    const SizedBox(height: 4),
                    Text(
                      subtitle,
                      style: Theme.of(context).textTheme.bodySmall?.copyWith(
                        fontWeight: FontWeight.w800,
                        color: AppColors.textMutedLight,
                      ),
                    ),
                  ],
                ),
              ),
              trailing,
            ],
          ),
        ),
      ),
    );
  }
}

class _GhostTile extends StatelessWidget {
  const _GhostTile({required this.icon, required this.text});
  final IconData icon;
  final String text;

  @override
  Widget build(BuildContext context) {
    return Material(
      color: AppColors.surface(context).withValues(alpha: 0.45),
      borderRadius: BorderRadius.circular(18),
      child: InkWell(
        onTap: () {},
        borderRadius: BorderRadius.circular(18),
        child: Padding(
          padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 12),
          child: Row(
            children: [
              Icon(icon, color: AppColors.brandBlueSoft),
              const SizedBox(width: 12),
              Expanded(
                child: Text(
                  text,
                  style: Theme.of(context).textTheme.bodyMedium?.copyWith(
                    fontWeight: FontWeight.w900,
                    color: AppColors.navy,
                  ),
                ),
              ),
              const Icon(Icons.chevron_right_rounded),
            ],
          ),
        ),
      ),
    );
  }
}


// ===== FILE: lib/features/tenant/tenancy/tenancy_detail_screen.dart =====

import "package:flutter/material.dart";
import "../../../core/theme/app_spacing.dart";
import "../../../core/ui/scaffold/app_scaffold.dart";
import "../../../core/ui/scaffold/app_top_bar.dart";
import "../../../shared/services/dialog_service.dart";
import "../../../shared/services/toast_service.dart";
import "../../../shared/widgets/primary_button.dart";
import "../../../shared/widgets/secondary_button.dart";
import "pay_rent/pay_rent_sheet.dart";

class TenancyDetailScreen extends StatelessWidget {
  const TenancyDetailScreen({super.key});

  @override
  Widget build(BuildContext context) {
    return AppScaffold(
      topBar: const AppTopBar(
        title: "Tenancy Detail",
        subtitle: "Timeline & actions",
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            "Lease Documents",
            style: Theme.of(
              context,
            ).textTheme.titleMedium?.copyWith(fontWeight: FontWeight.w900),
          ),
          const SizedBox(height: AppSpacing.sm),
          OutlinedButton.icon(
            onPressed: () => ToastService.show(
              context,
              "Open lease PDF (demo)",
              success: true,
            ),
            icon: const Icon(Icons.picture_as_pdf_rounded),
            label: const Text("Lease Agreement.pdf"),
          ),

          const SizedBox(height: AppSpacing.lg),

          Text(
            "Payments",
            style: Theme.of(
              context,
            ).textTheme.titleMedium?.copyWith(fontWeight: FontWeight.w900),
          ),
          const SizedBox(height: AppSpacing.sm),
          PrimaryButton(
            label: "Pay rent",
            onPressed: () {
              PayRentSheet.open(
                context,
                title: "Lekki Phase 1 • Unit 3B",
                amountNgn: 50000,
              );
            },
          ),

          const SizedBox(height: AppSpacing.lg),

          Text(
            "End Tenancy",
            style: Theme.of(
              context,
            ).textTheme.titleMedium?.copyWith(fontWeight: FontWeight.w900),
          ),
          const SizedBox(height: AppSpacing.sm),
          PrimaryButton(
            label: "Request end tenancy",
            onPressed: () => ToastService.show(
              context,
              "End tenancy form (demo)",
              success: true,
            ),
          ),
          const SizedBox(height: AppSpacing.md),
          SecondaryButton(
            label: "Cancel request",
            onPressed: () async {
              final ok = await DialogService.confirm(
                context,
                title: "Cancel end request?",
                message: "Your tenancy will remain active.",
                confirmText: "Cancel request",
                danger: true,
              );
              if (ok && context.mounted) {
                ToastService.show(context, "Cancelled (demo)", success: true);
              }
            },
          ),
        ],
      ),
    );
  }
}


// ===== FILE: lib/features/tenant/tenancy/tenancy_screen.dart =====

import 'package:flutter/material.dart';
import '../../../core/theme/app_spacing.dart';
import '../../../core/ui/scaffold/app_scaffold.dart';
import '../../../core/ui/scaffold/app_top_bar.dart';
import '../../../shared/widgets/primary_button.dart';
import 'tenancy_detail_screen.dart';

import 'pay_rent/pay_rent_sheet.dart';

class TenancyScreen extends StatelessWidget {
  const TenancyScreen({super.key});

  @override
  Widget build(BuildContext context) {
    return AppScaffold(
      topBar: const AppTopBar(
        title: 'Tenancy',
        subtitle: 'Overview & lease docs',
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            'Active Tenancy',
            style: Theme.of(
              context,
            ).textTheme.titleLarge?.copyWith(fontWeight: FontWeight.w900),
          ),
          const SizedBox(height: AppSpacing.md),
          const Text(
            'Property: Modern 2 Bedroom Apartment\nNext Due: Feb 01, 2026\nRent: NGN 1,200,000',
          ),
          const SizedBox(height: AppSpacing.lg),

          PrimaryButton(
            label: 'Pay rent',
            onPressed: () {
              PayRentSheet.open(
                context,
                title: 'Lekki Phase 1 • Unit 3B',
                amountNgn: 50000,
              );
            },
          ),
          const SizedBox(height: AppSpacing.md),
          PrimaryButton(
            label: 'View tenancy details',
            onPressed: () {
              Navigator.of(context).push(
                MaterialPageRoute(builder: (_) => const TenancyDetailScreen()),
              );
            },
          ),
        ],
      ),
    );
  }
}


// ===== FILE: lib/features/tenant/viewings/viewing_detail_screen.dart =====

import "package:flutter/material.dart";

import '../../../core/ui/scaffold/app_top_bar.dart';
import "../../../shared/models/viewing_model.dart";
import '../../../core/ui/scaffold/app_scaffold.dart';

import '../../../core/theme/app_colors.dart';

class ViewingDetailScreen extends StatelessWidget {
  const ViewingDetailScreen({super.key, required this.viewing});

  final ViewingModel viewing;

  static const _bgTop = AppColors.lightBg;
  static const _bgBottom = AppColors.mist;
  static const _text = AppColors.navy;
  static const _muted = AppColors.textMutedLight;
  static const _blue = AppColors.brandBlueSoft;
  static const _red = Color(0xFFB54A4A);

  String _fmtDateOnly(DateTime dt) {
    const mos = [
      "Jan",
      "Feb",
      "Mar",
      "Apr",
      "May",
      "Jun",
      "Jul",
      "Aug",
      "Sep",
      "Oct",
      "Nov",
      "Dec",
    ];
    final mo = mos[dt.month - 1];
    return "$mo ${dt.day}";
  }

  String _fmtDateTime(DateTime dt) {
    const wds = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
    const mos = [
      "Jan",
      "Feb",
      "Mar",
      "Apr",
      "May",
      "Jun",
      "Jul",
      "Aug",
      "Sep",
      "Oct",
      "Nov",
      "Dec",
    ];
    final wd = wds[dt.weekday - 1];
    final mo = mos[dt.month - 1];
    final hour12 = (dt.hour % 12 == 0) ? 12 : (dt.hour % 12);
    final ampm = dt.hour >= 12 ? "PM" : "AM";
    final mm = dt.minute.toString().padLeft(2, "0");
    return "$wd, $mo ${dt.day} • $hour12:$mm $ampm";
  }

  @override
  Widget build(BuildContext context) {
    final price = viewing.priceText ?? "₦—";
    final dateText = _fmtDateOnly(viewing.dateTime);
    final fullDateTime = _fmtDateTime(viewing.dateTime);

    final canCancel =
        viewing.status == ViewingStatus.requested ||
        viewing.status == ViewingStatus.confirmed;

    // status stage for the timeline
    final int stage = viewing.status == ViewingStatus.requested
        ? 0
        : (viewing.status == ViewingStatus.confirmed ? 1 : 2);

    return AppScaffold(
      topBar: const AppTopBar(title: 'Viewing'),
      child: DecoratedBox(
        decoration: const BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [_bgTop, _bgBottom],
          ),
        ),
        child: SafeArea(
          bottom: false,
          child: Column(
            children: [
              // top bar like screenshot (back + arrows)
              Padding(
                padding: const EdgeInsets.fromLTRB(6, 6, 6, 6),
                child: Row(
                  children: [
                    IconButton(
                      onPressed: () => Navigator.of(context).maybePop(),
                      icon: const Icon(Icons.arrow_back_ios_new_rounded),
                    ),
                    IconButton(
                      onPressed: () {},
                      icon: const Icon(
                        Icons.arrow_back_ios_new_rounded,
                        size: 18,
                      ),
                    ),
                    IconButton(
                      onPressed: () {},
                      icon: const Icon(
                        Icons.arrow_forward_ios_rounded,
                        size: 18,
                      ),
                    ),
                    const Spacer(),
                  ],
                ),
              ),

              Expanded(
                child: ListView(
                  padding: const EdgeInsets.fromLTRB(14, 8, 14, 120),
                  children: [
                    // hero image with price overlay
                    ClipRRect(
                      borderRadius: BorderRadius.circular(18),
                      child: Stack(
                        children: [
                          Container(
                            height: 220,
                            width: double.infinity,
                            color: const Color(
                              0xFFCFDBEA,
                            ).withValues(alpha: 0.85),
                            alignment: Alignment.center,
                            child: const Icon(
                              Icons.home_rounded,
                              size: 64,
                              color: AppColors.brandBlueSoft,
                            ),
                          ),
                          Positioned(
                            left: 14,
                            bottom: 14,
                            child: Container(
                              padding: const EdgeInsets.symmetric(
                                horizontal: 12,
                                vertical: 8,
                              ),
                              decoration: BoxDecoration(
                                color: AppColors.overlay(context, 0.35),
                                borderRadius: BorderRadius.circular(12),
                              ),
                              child: Text(
                                price,
                                style: const TextStyle(
                                  color: Colors.white,
                                  fontWeight: FontWeight.w900,
                                ),
                              ),
                            ),
                          ),
                        ],
                      ),
                    ),
                    const SizedBox(height: 14),

                    // title
                    Text(
                      viewing.listingTitle,
                      style: Theme.of(context).textTheme.titleLarge?.copyWith(
                        fontWeight: FontWeight.w900,
                        color: _text,
                      ),
                    ),
                    const SizedBox(height: 10),

                    // date row + add to calendar
                    _FrostCard(
                      child: Padding(
                        padding: const EdgeInsets.all(14),
                        child: Row(
                          children: [
                            const Icon(
                              Icons.event_rounded,
                              size: 20,
                              color: Color(0xFFB24A5A),
                            ),
                            const SizedBox(width: 10),
                            Expanded(
                              child: Text(
                                dateText,
                                style: Theme.of(context).textTheme.titleSmall
                                    ?.copyWith(
                                      fontWeight: FontWeight.w900,
                                      color: _text,
                                    ),
                              ),
                            ),
                            TextButton(
                              onPressed: () {},
                              child: const Text("+ Add to Calendar"),
                            ),
                          ],
                        ),
                      ),
                    ),

                    const SizedBox(height: 12),

                    // location section (map card + get directions)
                    Text(
                      "Location",
                      style: Theme.of(context).textTheme.titleSmall?.copyWith(
                        fontWeight: FontWeight.w900,
                        color: _text.withValues(alpha: 0.85),
                      ),
                    ),
                    const SizedBox(height: 8),
                    _FrostCard(
                      child: Padding(
                        padding: const EdgeInsets.all(14),
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            Row(
                              children: [
                                const Icon(
                                  Icons.place_rounded,
                                  color: _blue,
                                  size: 18,
                                ),
                                const SizedBox(width: 8),
                                Expanded(
                                  child: Text(
                                    "${viewing.listingTitle}\n${viewing.location}",
                                    style: Theme.of(context)
                                        .textTheme
                                        .bodyMedium
                                        ?.copyWith(
                                          fontWeight: FontWeight.w900,
                                          color: _text,
                                        ),
                                  ),
                                ),
                              ],
                            ),
                            const SizedBox(height: 12),
                            ClipRRect(
                              borderRadius: BorderRadius.circular(14),
                              child: Container(
                                height: 130,
                                width: double.infinity,
                                decoration: BoxDecoration(
                                  color: AppColors.overlay(context, 0.05),
                                ),
                                child: Stack(
                                  children: [
                                    // light "map" grid placeholder
                                    Positioned.fill(
                                      child: Opacity(
                                        opacity: 0.20,
                                        child: CustomPaint(
                                          painter: _GridPainter(),
                                        ),
                                      ),
                                    ),
                                    Center(
                                      child: Container(
                                        padding: const EdgeInsets.all(10),
                                        decoration: BoxDecoration(
                                          color: Colors.white.withValues(
                                            alpha: 0.75,
                                          ),
                                          borderRadius: BorderRadius.circular(
                                            999,
                                          ),
                                        ),
                                        child: const Icon(
                                          Icons.location_on_rounded,
                                          color: _blue,
                                          size: 22,
                                        ),
                                      ),
                                    ),
                                    Positioned(
                                      right: 12,
                                      bottom: 10,
                                      child: _PillOutlineButton(
                                        text: "Get directions",
                                        onTap: () {},
                                      ),
                                    ),
                                  ],
                                ),
                              ),
                            ),
                          ],
                        ),
                      ),
                    ),

                    const SizedBox(height: 14),

                    // contact section
                    Text(
                      "Contact",
                      style: Theme.of(context).textTheme.titleSmall?.copyWith(
                        fontWeight: FontWeight.w900,
                        color: _text.withValues(alpha: 0.85),
                      ),
                    ),
                    const SizedBox(height: 8),
                    _FrostCard(
                      child: Padding(
                        padding: const EdgeInsets.all(14),
                        child: Row(
                          children: [
                            CircleAvatar(
                              radius: 22,
                              backgroundColor: const Color(
                                0xFFCFDBEA,
                              ).withValues(alpha: 0.85),
                              child: const Icon(
                                Icons.person_rounded,
                                color: _blue,
                              ),
                            ),
                            const SizedBox(width: 12),
                            Expanded(
                              child: Column(
                                crossAxisAlignment: CrossAxisAlignment.start,
                                children: [
                                  Text(
                                    viewing.agentName,
                                    style: Theme.of(context)
                                        .textTheme
                                        .titleSmall
                                        ?.copyWith(
                                          fontWeight: FontWeight.w900,
                                          color: _text,
                                        ),
                                  ),
                                  const SizedBox(height: 2),
                                  Text(
                                    "Real Estate Agent",
                                    style: Theme.of(context).textTheme.bodySmall
                                        ?.copyWith(
                                          fontWeight: FontWeight.w800,
                                          color: _muted.withValues(alpha: 0.9),
                                        ),
                                  ),
                                ],
                              ),
                            ),
                            _IconBubble(icon: Icons.call_rounded, onTap: () {}),
                            const SizedBox(width: 10),
                            _IconBubble(icon: Icons.chat_rounded, onTap: () {}),
                          ],
                        ),
                      ),
                    ),

                    const SizedBox(height: 14),

                    // status timeline like screenshot
                    _FrostCard(
                      child: Padding(
                        padding: const EdgeInsets.fromLTRB(14, 12, 14, 14),
                        child: Column(
                          crossAxisAlignment: CrossAxisAlignment.start,
                          children: [
                            _Timeline(stage: stage),
                            const SizedBox(height: 10),
                            Row(
                              mainAxisAlignment: MainAxisAlignment.spaceBetween,
                              children: [
                                _TimelineLabel(
                                  text: "Requested",
                                  active: stage >= 0,
                                ),
                                _TimelineLabel(
                                  text: "Confirmed",
                                  active: stage >= 1,
                                ),
                                _TimelineLabel(
                                  text: "Completed",
                                  active: stage >= 2,
                                ),
                              ],
                            ),
                            const SizedBox(height: 6),
                            Text(
                              fullDateTime,
                              style: Theme.of(context).textTheme.bodySmall
                                  ?.copyWith(
                                    fontWeight: FontWeight.w800,
                                    color: _muted.withValues(alpha: 0.9),
                                  ),
                            ),
                          ],
                        ),
                      ),
                    ),

                    const SizedBox(height: 14),

                    // bottom buttons
                    Row(
                      children: [
                        Expanded(
                          child: _PillButton(
                            text: "Reschedule  ›",
                            color: _blue,
                            onTap: () {},
                          ),
                        ),
                        const SizedBox(width: 12),
                        Expanded(
                          child: _PillButton(
                            text: "Cancel viewing",
                            color: _red,
                            onTap: canCancel ? () {} : null,
                          ),
                        ),
                      ],
                    ),
                  ],
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}

class _IconBubble extends StatelessWidget {
  const _IconBubble({required this.icon, required this.onTap});

  final IconData icon;
  final VoidCallback onTap;

  @override
  Widget build(BuildContext context) {
    return Material(
      color: AppColors.surface(context).withValues(alpha: 0.6),
      borderRadius: BorderRadius.circular(12),
      child: InkWell(
        onTap: onTap,
        borderRadius: BorderRadius.circular(12),
        child: SizedBox(
          height: 38,
          width: 38,
          child: Icon(icon, color: AppColors.brandBlueSoft, size: 18),
        ),
      ),
    );
  }
}

class _PillButton extends StatelessWidget {
  const _PillButton({
    required this.text,
    required this.color,
    required this.onTap,
  });

  final String text;
  final Color color;
  final VoidCallback? onTap;

  @override
  Widget build(BuildContext context) {
    final disabled = onTap == null;
    return Material(
      color: disabled
          ? const Color(0xFFB9C1CF).withValues(alpha: 0.28)
          : color.withValues(alpha: 0.80),
      borderRadius: BorderRadius.circular(16),
      child: InkWell(
        onTap: onTap,
        borderRadius: BorderRadius.circular(16),
        child: Container(
          height: 48,
          alignment: Alignment.center,
          padding: const EdgeInsets.symmetric(horizontal: 10),
          child: Text(
            text,
            maxLines: 1,
            overflow: TextOverflow.ellipsis,
            style: Theme.of(context).textTheme.bodyMedium?.copyWith(
              fontWeight: FontWeight.w900,
              color: disabled ? const Color(0xFF9AA2AF) : Colors.white,
            ),
          ),
        ),
      ),
    );
  }
}

class _PillOutlineButton extends StatelessWidget {
  const _PillOutlineButton({required this.text, required this.onTap});

  final String text;
  final VoidCallback onTap;

  @override
  Widget build(BuildContext context) {
    return Material(
      color: AppColors.surface(context).withValues(alpha: 0.65),
      borderRadius: BorderRadius.circular(999),
      child: InkWell(
        onTap: onTap,
        borderRadius: BorderRadius.circular(999),
        child: Padding(
          padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 8),
          child: Text(
            text,
            style: Theme.of(context).textTheme.bodySmall?.copyWith(
              fontWeight: FontWeight.w900,
              color: AppColors.navy,
            ),
          ),
        ),
      ),
    );
  }
}

class _TimelineLabel extends StatelessWidget {
  const _TimelineLabel({required this.text, required this.active});
  final String text;
  final bool active;

  @override
  Widget build(BuildContext context) {
    return Text(
      text,
      style: Theme.of(context).textTheme.bodySmall?.copyWith(
        fontWeight: FontWeight.w900,
        color: active
            ? AppColors.navy
            : AppColors.textMutedLight.withValues(alpha: 0.75),
      ),
    );
  }
}

class _Timeline extends StatelessWidget {
  const _Timeline({required this.stage});
  final int stage;

  static const _blue = AppColors.brandBlueSoft;
  static const _muted = AppColors.textMutedLight;
  Color _dotColor(int idx) {
    if (idx < stage) return _blue;
    if (idx == stage && stage == 2) return AppColors.brandGreenDeep;
    if (idx == stage) return _blue;
    return _muted.withValues(alpha: 0.35);
  }

  @override
  Widget build(BuildContext context) {
    Widget dot(int i) {
      final c = _dotColor(i);
      return Container(
        height: 16,
        width: 16,
        decoration: BoxDecoration(
          color: c.withValues(alpha: 0.20),
          borderRadius: BorderRadius.circular(999),
          border: Border.all(color: c.withValues(alpha: 0.75), width: 2),
        ),
        child: Center(
          child: Container(
            height: 6,
            width: 6,
            decoration: BoxDecoration(
              color: c.withValues(alpha: 0.95),
              borderRadius: BorderRadius.circular(999),
            ),
          ),
        ),
      );
    }

    Widget line(bool active) {
      return Expanded(
        child: Container(
          height: 2,
          color: (active ? _blue : _muted.withValues(alpha: 0.25)),
        ),
      );
    }

    return Row(
      children: [
        dot(0),
        const SizedBox(width: 8),
        line(stage >= 1),
        const SizedBox(width: 8),
        dot(1),
        const SizedBox(width: 8),
        line(stage >= 2),
        const SizedBox(width: 8),
        dot(2),
      ],
    );
  }
}

class _FrostCard extends StatelessWidget {
  const _FrostCard({required this.child});
  final Widget child;

  @override
  Widget build(BuildContext context) {
    return Material(
      color: AppColors.surface(context).withValues(alpha: 0.62),
      borderRadius: BorderRadius.circular(18),
      child: Container(
        decoration: BoxDecoration(
          borderRadius: BorderRadius.circular(18),
          border: Border.all(
            color: AppColors.surface(context).withValues(alpha: 0.55),
          ),
          boxShadow: [
            BoxShadow(
              blurRadius: 18,
              offset: const Offset(0, 10),
              color: AppColors.overlay(context, 0.08),
            ),
          ],
        ),
        child: child,
      ),
    );
  }
}

class _GridPainter extends CustomPainter {
  @override
  void paint(Canvas canvas, Size size) {
    final p = Paint()
      ..color = AppColors.navy.withValues(alpha: 0.20)
      ..strokeWidth = 1;

    const step = 18.0;

    for (double x = 0; x <= size.width; x += step) {
      canvas.drawLine(Offset(x, 0), Offset(x, size.height), p);
    }
    for (double y = 0; y <= size.height; y += step) {
      canvas.drawLine(Offset(0, y), Offset(size.width, y), p);
    }
  }

  @override
  bool shouldRepaint(covariant CustomPainter oldDelegate) => false;
}


// ===== FILE: lib/features/tenant/viewings/viewing_models.dart =====

import "package:flutter/foundation.dart";

enum ViewingStatus { requested, confirmed, completed, cancelled }

extension ViewingStatusX on ViewingStatus {
  String get label {
    switch (this) {
      case ViewingStatus.requested:
        return "Requested";
      case ViewingStatus.confirmed:
        return "Confirmed";
      case ViewingStatus.completed:
        return "Completed";
      case ViewingStatus.cancelled:
        return "Cancelled";
    }
  }
}

@immutable
class ViewingModel {
  const ViewingModel({
    required this.id,
    required this.listingTitle,
    required this.location,
    required this.agentName,
    required this.dateTime,
    required this.status,
    this.priceText,
  });

  final String id;
  final String listingTitle;
  final String location;
  final String agentName;
  final DateTime dateTime;
  final ViewingStatus status;
  final String? priceText;
}


// ===== FILE: lib/features/tenant/viewings/viewings_screen.dart =====

import "package:flutter/material.dart";

import '../../../core/ui/scaffold/app_top_bar.dart';
import "../../../shared/models/viewing_model.dart";
import "viewing_detail_screen.dart";
import '../../../core/ui/scaffold/app_scaffold.dart';

import '../../../core/theme/app_colors.dart';
import '../../../core/theme/app_shadows.dart';

class ViewingsScreen extends StatefulWidget {
  const ViewingsScreen({super.key});

  @override
  State<ViewingsScreen> createState() => _ViewingsScreenState();
}

enum _Tab { upcoming, completed }

class _ViewingsScreenState extends State<ViewingsScreen> {
  static const _bgTop = AppColors.lightBg;
  static const _bgBottom = AppColors.mist;
  static const _text = AppColors.navy;
  static const _muted = AppColors.textMutedLight;
  static const _blue = AppColors.brandBlueSoft;
  static const _green = AppColors.brandGreenDeep;
  static const _red = Color(0xFFB54A4A);

  _Tab _tab = _Tab.upcoming;

  final List<ViewingModel> _all = [
    ViewingModel(
      id: "v1",
      listingTitle: "Lekki Phase 1 • Unit 3B",
      location: "Lekki, Lagos",
      agentName: "Adekunle A.",
      dateTime: DateTime.now().add(const Duration(days: 2, hours: 3)),
      status: ViewingStatus.confirmed,
      priceText: "₦50,000 / month",
    ),
    ViewingModel(
      id: "v2",
      listingTitle: "Victoria Island Condo",
      location: "Victoria Island, Lagos",
      agentName: "Blessing O.",
      dateTime: DateTime.now().add(const Duration(days: 5, hours: 1)),
      status: ViewingStatus.confirmed,
      priceText: "₦120,000 / month",
    ),
    ViewingModel(
      id: "v3",
      listingTitle: "Ikoyi Villa • Room 5C",
      location: "Ikoyi, Lagos",
      agentName: "Tunde K.",
      dateTime: DateTime.now().add(const Duration(days: 10, hours: 1)),
      status: ViewingStatus.confirmed,
      priceText: "₦80,000 / month",
    ),
    ViewingModel(
      id: "v4",
      listingTitle: "Yaba • Studio Apartment",
      location: "Yaba, Lagos",
      agentName: "Chioma I.",
      dateTime: DateTime.now().subtract(const Duration(days: 12)),
      status: ViewingStatus.completed,
      priceText: "₦35,000 / month",
    ),
  ];

  List<ViewingModel> get _filtered {
    switch (_tab) {
      case _Tab.upcoming:
        final list =
            _all
                .where(
                  (v) =>
                      v.status == ViewingStatus.requested ||
                      v.status == ViewingStatus.confirmed,
                )
                .toList()
              ..sort((a, b) => a.dateTime.compareTo(b.dateTime));
        return list;
      case _Tab.completed:
        final list =
            _all.where((v) => v.status == ViewingStatus.completed).toList()
              ..sort((a, b) => b.dateTime.compareTo(a.dateTime));
        return list;
    }
  }

  String _fmtDateTime(DateTime dt) {
    const wds = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
    const mos = [
      "Jan",
      "Feb",
      "Mar",
      "Apr",
      "May",
      "Jun",
      "Jul",
      "Aug",
      "Sep",
      "Oct",
      "Nov",
      "Dec",
    ];
    final wd = wds[dt.weekday - 1];
    final mo = mos[dt.month - 1];
    final hour12 = (dt.hour % 12 == 0) ? 12 : (dt.hour % 12);
    final ampm = dt.hour >= 12 ? "PM" : "AM";
    final mm = dt.minute.toString().padLeft(2, "0");
    return "$wd, $mo ${dt.day} • $hour12:$mm $ampm";
  }

  String _dateOnly(DateTime dt) {
    const mos = [
      "Jan",
      "Feb",
      "Mar",
      "Apr",
      "May",
      "Jun",
      "Jul",
      "Aug",
      "Sep",
      "Oct",
      "Nov",
      "Dec",
    ];
    final mo = mos[dt.month - 1];
    return "$mo ${dt.day}";
  }

  @override
  Widget build(BuildContext context) {
    final items = _filtered;

    return AppScaffold(
      topBar: const AppTopBar(title: 'Viewings'),
      child: DecoratedBox(
        decoration: const BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [_bgTop, _bgBottom],
          ),
        ),
        child: SafeArea(
          bottom: false,
          child: Column(
            children: [
              // top bar
              Padding(
                padding: const EdgeInsets.fromLTRB(8, 8, 8, 6),
                child: Row(
                  children: [
                    IconButton(
                      onPressed: () => Navigator.of(context).maybePop(),
                      icon: const Icon(Icons.arrow_back_ios_new_rounded),
                    ),
                    Expanded(
                      child: Text(
                        "My Viewings",
                        textAlign: TextAlign.center,
                        style: Theme.of(context).textTheme.titleMedium
                            ?.copyWith(
                              fontWeight: FontWeight.w900,
                              color: _text,
                            ),
                      ),
                    ),
                    IconButton(
                      onPressed: () {},
                      icon: const Icon(Icons.calendar_month_rounded),
                    ),
                  ],
                ),
              ),

              // tabs (Upcoming / Completed like the screenshot)
              Padding(
                padding: const EdgeInsets.fromLTRB(14, 6, 14, 12),
                child: _Tabs(
                  value: _tab,
                  onChanged: (t) => setState(() => _tab = t),
                ),
              ),

              Expanded(
                child: items.isEmpty
                    ? Center(
                        child: Text(
                          "No viewings yet",
                          style: Theme.of(context).textTheme.titleMedium
                              ?.copyWith(
                                fontWeight: FontWeight.w900,
                                color: _muted,
                              ),
                        ),
                      )
                    : ListView.separated(
                        padding: const EdgeInsets.fromLTRB(14, 8, 14, 120),
                        itemCount: items.length,
                        separatorBuilder: (context, index) =>
                            const SizedBox(height: 12),
                        itemBuilder: (context, i) {
                          final v = items[i];
                          final statusChip = v.status == ViewingStatus.confirmed
                              ? "Confirmed"
                              : (v.status == ViewingStatus.requested
                                    ? "Requested"
                                    : "Completed");

                          final statusColor =
                              v.status == ViewingStatus.confirmed
                              ? _green
                              : (v.status == ViewingStatus.requested
                                    ? _blue
                                    : _muted);

                          return _ViewingCard(
                            title: v.listingTitle,
                            line1: _fmtDateTime(v.dateTime),
                            line2: _dateOnly(v.dateTime),
                            location: v.location,
                            statusText: statusChip,
                            statusColor: statusColor,
                            onTap: () {
                              Navigator.of(context).push(
                                MaterialPageRoute(
                                  builder: (_) =>
                                      ViewingDetailScreen(viewing: v),
                                ),
                              );
                            },
                            onDirections: () {},
                            onReschedule: () {},
                            onCancel: () {},
                            cancelColor: _red,
                          );
                        },
                      ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}

class _Tabs extends StatelessWidget {
  const _Tabs({required this.value, required this.onChanged});
  final _Tab value;
  final ValueChanged<_Tab> onChanged;

  @override
  Widget build(BuildContext context) {
    Widget tab(_Tab t, String label) {
      final selected = value == t;
      return Expanded(
        child: Material(
          color: selected
              ? AppColors.brandBlueSoft.withValues(alpha: 0.24)
              : AppColors.surface(context).withValues(alpha: 0.55),
          borderRadius: BorderRadius.circular(14),
          child: InkWell(
            onTap: () => onChanged(t),
            borderRadius: BorderRadius.circular(14),
            child: Padding(
              padding: EdgeInsets.symmetric(vertical: 10),
              child: Center(
                child: Text(
                  label,
                  style: Theme.of(context).textTheme.bodyMedium?.copyWith(
                    fontWeight: FontWeight.w900,
                    color: AppColors.navy,
                  ),
                ),
              ),
            ),
          ),
        ),
      );
    }

    return Container(
      padding: EdgeInsets.all(6),
      decoration: BoxDecoration(
        color: AppColors.surface(context).withValues(alpha: 0.35),
        borderRadius: BorderRadius.circular(18),
        border: Border.all(
          color: AppColors.surface(context).withValues(alpha: 0.45),
        ),
      ),
      child: Row(
        children: [
          tab(_Tab.upcoming, "Upcoming"),
          const SizedBox(width: 8),
          tab(_Tab.completed, "Completed"),
        ],
      ),
    );
  }
}

class _ViewingCard extends StatelessWidget {
  const _ViewingCard({
    required this.title,
    required this.line1,
    required this.line2,
    required this.location,
    required this.statusText,
    required this.statusColor,
    required this.onTap,
    required this.onDirections,
    required this.onReschedule,
    required this.onCancel,
    required this.cancelColor,
  });

  final String title;
  final String line1;
  final String line2;
  final String location;

  final String statusText;
  final Color statusColor;

  final VoidCallback onTap;
  final VoidCallback onDirections;
  final VoidCallback onReschedule;
  final VoidCallback onCancel;

  final Color cancelColor;

  @override
  Widget build(BuildContext context) {
    return _FrostCard(
      child: InkWell(
        onTap: onTap,
        borderRadius: BorderRadius.circular(18),
        child: Padding(
          padding: const EdgeInsets.all(12),
          child: Column(
            children: [
              Row(
                children: [
                  // thumbnail like screenshot
                  ClipRRect(
                    borderRadius: BorderRadius.circular(14),
                    child: Container(
                      height: 64,
                      width: 72,
                      color: const Color(0xFFCFDBEA).withValues(alpha: 0.85),
                      alignment: Alignment.center,
                      child: const Icon(
                        Icons.home_rounded,
                        color: AppColors.brandBlueSoft,
                      ),
                    ),
                  ),
                  const SizedBox(width: 12),

                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(
                          title,
                          maxLines: 1,
                          overflow: TextOverflow.ellipsis,
                          style: Theme.of(context).textTheme.titleSmall
                              ?.copyWith(
                                fontWeight: FontWeight.w900,
                                color: AppColors.navy,
                              ),
                        ),
                        const SizedBox(height: 6),

                        Row(
                          children: [
                            const Icon(
                              Icons.event_rounded,
                              size: 16,
                              color: Color(0xFFB24A5A),
                            ),
                            SizedBox(width: 6),
                            Expanded(
                              child: Text(
                                line1,
                                maxLines: 1,
                                overflow: TextOverflow.ellipsis,
                                style: Theme.of(context).textTheme.bodySmall
                                    ?.copyWith(
                                      fontWeight: FontWeight.w800,
                                      color: AppColors.textMutedLight,
                                    ),
                              ),
                            ),
                          ],
                        ),

                        SizedBox(height: 6),
                        Text(
                          location,
                          maxLines: 1,
                          overflow: TextOverflow.ellipsis,
                          style: Theme.of(context).textTheme.bodySmall
                              ?.copyWith(
                                fontWeight: FontWeight.w800,
                                color: AppColors.brandBlueSoft,
                              ),
                        ),
                      ],
                    ),
                  ),

                  const SizedBox(width: 10),

                  // status pill
                  Container(
                    padding: const EdgeInsets.symmetric(
                      horizontal: 10,
                      vertical: 7,
                    ),
                    decoration: BoxDecoration(
                      color: statusColor.withValues(alpha: 0.18),
                      borderRadius: BorderRadius.circular(999),
                    ),
                    child: Text(
                      statusText,
                      style: Theme.of(context).textTheme.bodySmall?.copyWith(
                        fontWeight: FontWeight.w900,
                        color: statusColor,
                      ),
                    ),
                  ),
                ],
              ),

              const SizedBox(height: 12),

              // action row like screenshot (NO overflow)
              Wrap(
                spacing: 10,
                runSpacing: 10,
                children: [
                  _MiniAction(
                    icon: Icons.directions_rounded,
                    text: "Directions",
                    onTap: onDirections,
                  ),
                  _MiniAction(
                    icon: Icons.schedule_rounded,
                    text: "Reschedule",
                    onTap: onReschedule,
                  ),
                  _MiniAction(
                    icon: Icons.close_rounded,
                    text: "Cancel",
                    onTap: onCancel,
                    textColor: cancelColor,
                    iconColor: cancelColor,
                  ),
                ],
              ),
            ],
          ),
        ),
      ),
    );
  }
}

class _MiniAction extends StatelessWidget {
  const _MiniAction({
    required this.icon,
    required this.text,
    required this.onTap,
    this.textColor,
    this.iconColor,
  });

  final IconData icon;
  final String text;
  final VoidCallback onTap;
  final Color? textColor;
  final Color? iconColor;

  @override
  Widget build(BuildContext context) {
    final tc = textColor ?? AppColors.navy;
    final ic = iconColor ?? AppColors.textMutedLight;

    return Material(
      color: AppColors.overlay(context, 0.04),
      borderRadius: BorderRadius.circular(14),
      child: InkWell(
        onTap: onTap,
        borderRadius: BorderRadius.circular(14),
        child: Padding(
          padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 10),
          child: Row(
            mainAxisSize: MainAxisSize.min,
            children: [
              Icon(icon, size: 18, color: ic),
              const SizedBox(width: 8),
              Text(
                text,
                style: Theme.of(context).textTheme.bodySmall?.copyWith(
                  fontWeight: FontWeight.w900,
                  color: tc,
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }
}

class _FrostCard extends StatelessWidget {
  const _FrostCard({required this.child});
  final Widget child;

  @override
  Widget build(BuildContext context) {
    return Material(
      color: AppColors.surface(context).withValues(alpha: 0.70),
      borderRadius: BorderRadius.circular(18),
      child: Container(
        decoration: BoxDecoration(
          borderRadius: BorderRadius.circular(18),
          border: Border.all(
            color: AppColors.surface(context).withValues(alpha: 0.55),
          ),
          boxShadow: AppShadows.lift(context, blur: 18, y: 10, alpha: 0.08),
        ),
        child: child,
      ),
    );
  }
}
